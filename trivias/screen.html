<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STEAM Trivia - Fundacion STEAM RD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F',
                            negro: '#010101',
                            blanco: '#FFFFFF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            transition: background 0.5s ease;
        }

        /* Category backgrounds */
        body.cat-general { background: linear-gradient(135deg, #E8F4F8 0%, #F0F8FF 100%); }
        body.cat-science { background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%); }
        body.cat-mathematics { background: linear-gradient(135deg, #E3F2FD 0%, #E8F4F8 100%); }
        body.cat-robotics { background: linear-gradient(135deg, #FCE4EC 0%, #F3E5F5 100%); }
        body.cat-chemistry { background: linear-gradient(135deg, #E8F5E9 0%, #F1F8E9 100%); }
        body.cat-technology { background: linear-gradient(135deg, #F3E5F5 0%, #EDE7F6 100%); }
        body.cat-history { background: linear-gradient(135deg, #FFF3E0 0%, #FBE9E7 100%); }
        body.cat-geography { background: linear-gradient(135deg, #E0F7FA 0%, #E3F2FD 100%); }
        body.cat-default { background: #FFFFFF; }

        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .logo-gradient {
            background: linear-gradient(45deg, #0595AE, #AB3D8B, #EB8225, #73A03F);
            background-size: 300% 300%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientMove 3s ease infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        .timer-warning { animation: pulse 0.5s ease infinite; }
        .timer-danger { animation: shake 0.3s ease infinite; }

        @keyframes correctPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .option-correct { animation: correctPop 0.3s ease; }
        .option-incorrect { animation: incorrectShake 0.3s ease; }

        @keyframes winnerBounce {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .winner-bounce { animation: winnerBounce 0.5s ease; }

        @keyframes confettiFall {
            0% { transform: translateY(-100px) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        /* Player avatar visual */
        .player-avatar-visual {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            position: relative;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .player-avatar-visual::before {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            right: 3px;
            height: 9px;
            background: rgba(255,255,255,0.35);
            border-radius: 6px 6px 0 0;
        }

        .player-avatar-visual-large {
            width: 60px;
            height: 60px;
            border-radius: 12px;
        }

        .player-avatar-visual-large::before {
            height: 12px;
            top: 4px;
            left: 4px;
            right: 4px;
            border-radius: 8px 8px 0 0;
        }

        .player-avatar-visual-small {
            width: 32px;
            height: 32px;
            border-radius: 8px;
        }

        .player-avatar-visual-small::before {
            height: 6px;
            top: 2px;
            left: 2px;
            right: 2px;
            border-radius: 4px 4px 0 0;
        }
    </style>
</head>
<body class="cat-default font-sans text-steam-negro overflow-hidden">
    <div class="w-screen h-screen flex flex-col relative">
        <!-- WAITING SCREEN -->
        <div class="screen waiting-screen active flex-col items-center justify-center p-10" id="waitingScreen">
            <div class="mb-8">
                <h1 class="text-5xl font-black logo-gradient drop-shadow">STEAM TRIVIA</h1>
            </div>
            <h2 class="text-2xl mb-4 text-steam-turquesa font-bold">Esperando Jugadores!</h2>
            <p class="text-lg text-steam-negro/70 mb-8">Escanea el codigo QR con tu telefono para unirte</p>
            <div class="flex flex-wrap gap-5 justify-center mb-8 max-w-3xl" id="playersGrid"></div>
            <div class="bg-orange-50 border-2 border-steam-naranja rounded-2xl py-4 px-6 mt-5 text-center hidden" id="adminHint">
                <p class="text-steam-naranja font-bold">El Jugador 1 controla el juego desde su telefono</p>
            </div>
        </div>

        <!-- CATEGORY SCREEN -->
        <div class="screen flex-col p-8 overflow-y-auto" id="categoryScreen">
            <h2 class="text-2xl text-steam-turquesa mb-8 text-center font-bold">Jugador 1: Selecciona una Categoria</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto mb-8" id="categoryGrid"></div>
            <div class="bg-orange-50 border-2 border-steam-naranja rounded-2xl py-4 px-6 text-center max-w-md mx-auto">
                <p class="text-steam-naranja font-bold">Esperando que el Jugador 1 seleccione categoria e inicie...</p>
            </div>
        </div>

        <!-- PLAYING SCREEN -->
        <div class="screen flex-col h-full" id="playingScreen">
            <!-- Header -->
            <div class="flex justify-between items-center p-5">
                <div class="flex-1 flex justify-center items-center">
                    <div class="w-3/5 h-8 bg-black/10 rounded-full overflow-visible relative border-[3px] border-steam-turquesa">
                        <div class="h-full bg-gradient-to-r from-steam-verde via-steam-naranja to-steam-morado rounded-full transition-all duration-100 relative" id="timerBarFill" style="width: 100%;">
                            <div class="absolute -right-4 top-1/2 -translate-y-1/2 w-0 h-0 border-l-[20px] border-l-steam-morado border-y-[15px] border-y-transparent"></div>
                        </div>
                    </div>
                </div>
                <div class="w-20 h-20 bg-steam-turquesa rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg border-4 border-white transition-all" id="timerCircle">20</div>
            </div>

            <!-- Content -->
            <div class="flex-1 flex flex-col px-10 pb-8">
                <div class="flex-1 flex flex-col items-center justify-center">
                    <div class="text-lg text-steam-turquesa mb-4 font-bold" id="questionNumber">Pregunta 1 de 5</div>
                    <h2 class="text-3xl text-center max-w-4xl leading-tight mb-10" id="questionText">Cual es la capital de Francia?</h2>
                    <div class="grid grid-cols-2 gap-4 max-w-4xl w-full" id="optionsGrid"></div>
                </div>
            </div>

            <!-- Footer -->
            <div class="flex items-center p-4 gap-5 bg-white/90 border-t-2 border-gray-200">
                <div class="w-28 h-20 bg-gradient-to-br from-steam-turquesa to-steam-morado rounded-xl flex items-center justify-center">
                    <span class="text-xl font-bold text-white">STEAM</span>
                </div>
                <div class="flex gap-3 flex-1 flex-wrap" id="playersStatus"></div>
            </div>

            <!-- Scoreboard -->
            <div class="absolute top-28 right-5 bg-white rounded-2xl p-4 min-w-[180px] border-2 border-gray-200 shadow-lg" id="scoreboard">
                <div class="text-lg text-steam-turquesa mb-3 text-center font-bold">Puntuacion</div>
                <div class="flex flex-col gap-2" id="scoreboardList"></div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div class="screen flex-col items-center justify-center p-10" id="endScreen">
            <h2 class="text-3xl text-steam-turquesa mb-8 font-bold">Juego Terminado!</h2>
            <div class="winner-bounce text-center mb-8" id="winnerSection"></div>
            <div class="flex flex-col gap-3 max-w-lg w-full mb-8" id="podium"></div>
            <div class="bg-orange-50 border-2 border-steam-naranja rounded-2xl py-5 px-8 text-center animate-pulse">
                <p class="text-steam-naranja text-lg font-bold">Esperando que el Jugador 1 decida...</p>
            </div>
        </div>

        <!-- Sound toggle -->
        <div class="absolute bottom-5 right-5 text-3xl cursor-pointer opacity-70 hover:opacity-100 transition-opacity z-50" id="soundToggle">ðŸ”Š</div>
        
        <!-- Confetti container -->
        <div class="fixed top-0 left-0 w-full h-full pointer-events-none z-[1000] overflow-hidden" id="confettiContainer"></div>
    </div>

    <script>
        const categories = {
            general: { name: "General", emoji: "ðŸŒ", color: "general" },
            science: { name: "Ciencia", emoji: "ðŸ”¬", color: "science" },
            mathematics: { name: "Matematicas", emoji: "ðŸ“", color: "mathematics" },
            robotics: { name: "Robotica", emoji: "ðŸ¤–", color: "robotics" },
            chemistry: { name: "Quimica", emoji: "âš—ï¸", color: "chemistry" },
            technology: { name: "Tecnologia", emoji: "ðŸ’»", color: "technology" },
            history: { name: "Historia", emoji: "ðŸ“œ", color: "history" },
            geography: { name: "Geografia", emoji: "ðŸ—ºï¸", color: "geography" }
        };

        const questions = {
            general: [
                { question: "Cual es la capital de Francia?", options: ["Londres", "Paris", "Berlin", "Madrid"], correct: 1 },
                { question: "En que aÃ±o llego el hombre a la Luna?", options: ["1965", "1969", "1972", "1975"], correct: 1 },
                { question: "Quien pinto la Mona Lisa?", options: ["Picasso", "Van Gogh", "Leonardo da Vinci", "Miguel Angel"], correct: 2 },
                { question: "Cual es el oceano mas grande del mundo?", options: ["Atlantico", "Indico", "Artico", "Pacifico"], correct: 3 },
                { question: "Cuantos continentes hay en la Tierra?", options: ["5", "6", "7", "8"], correct: 2 }
            ],
            science: [
                { question: "Cual es el elemento quimico del oro?", options: ["Go", "Gd", "Au", "Ag"], correct: 2 },
                { question: "Que planeta es el mas cercano al Sol?", options: ["Venus", "Mercurio", "Marte", "Tierra"], correct: 1 },
                { question: "Cuantos huesos tiene el cuerpo humano adulto?", options: ["196", "206", "216", "226"], correct: 1 },
                { question: "Cual es el animal mas grande del mundo?", options: ["Elefante", "Tiburon blanco", "Ballena azul", "Jirafa"], correct: 2 },
                { question: "Cual es la galaxia en la que vivimos?", options: ["Andromeda", "Via Lactea", "Sombrero", "Triangulo"], correct: 1 }
            ],
            mathematics: [
                { question: "Cuanto es 2 + 2 Ã— 3?", options: ["12", "8", "10", "6"], correct: 1 },
                { question: "Cual es la raiz cuadrada de 144?", options: ["10", "11", "12", "13"], correct: 2 },
                { question: "Cuantos grados tiene un triangulo?", options: ["180Â°", "360Â°", "90Â°", "270Â°"], correct: 0 },
                { question: "Cual es el numero Ï€ (pi) aproximadamente?", options: ["2.14", "3.14", "4.14", "5.14"], correct: 1 },
                { question: "Cuantos lados tiene un hexagono?", options: ["4", "5", "6", "7"], correct: 2 }
            ],
            robotics: [
                { question: "Que significa 'AI' en robotica?", options: ["Automated Intelligence", "Artificial Intelligence", "Advanced Integration", "Automatic Interface"], correct: 1 },
                { question: "Que sensor se usa para detectar obstaculos?", options: ["GPS", "Ultrasonido", "Bluetooth", "WiFi"], correct: 1 },
                { question: "Que lenguaje se usa comunmente en Arduino?", options: ["Python", "Java", "C/C++", "JavaScript"], correct: 2 },
                { question: "Que es un actuador en robotica?", options: ["Sensor", "Motor", "Bateria", "Procesador"], correct: 1 },
                { question: "Que es ROS en robotica?", options: ["Robot Operating System", "Robotic Output System", "Remote Operation Software", "Robot Optimization Suite"], correct: 0 }
            ],
            chemistry: [
                { question: "Cual es el simbolo del elemento oxigeno?", options: ["Ox", "O2", "O", "Ox2"], correct: 2 },
                { question: "Cuantos elementos hay en la tabla periodica?", options: ["108", "118", "128", "138"], correct: 1 },
                { question: "Cual es la formula del dioxido de carbono?", options: ["CO", "CO2", "C2O", "C2O2"], correct: 1 },
                { question: "Que pH tiene una sustancia neutra?", options: ["0", "7", "14", "10"], correct: 1 },
                { question: "Cual es la formula quimica del agua?", options: ["H2", "O2", "H2O", "HO"], correct: 2 }
            ],
            technology: [
                { question: "Que significa 'www' en una direccion web?", options: ["World Wide Web", "World Web Way", "Wide World Web", "Web World Wide"], correct: 0 },
                { question: "Que compaÃ±ia creo Android?", options: ["Apple", "Microsoft", "Google", "Samsung"], correct: 2 },
                { question: "Que significa 'CPU'?", options: ["Central Processing Unit", "Computer Power Unit", "Control Processing Unit", "Central Power Unit"], correct: 0 },
                { question: "Que significa 'HTML'?", options: ["HyperText Markup Language", "High Tech Machine Learning", "Home Tool Management List", "Hyper Transfer Media Link"], correct: 0 },
                { question: "Que compaÃ±ia creo Windows?", options: ["Apple", "Google", "Microsoft", "IBM"], correct: 2 }
            ],
            history: [
                { question: "En que aÃ±o cayo el Imperio Romano de Occidente?", options: ["410", "476", "500", "600"], correct: 1 },
                { question: "Quien fue el primer presidente de EE.UU.?", options: ["Jefferson", "Lincoln", "Washington", "Adams"], correct: 2 },
                { question: "Que civilizacion construyo las piramides de Giza?", options: ["Griega", "Egipcia", "Romana", "Maya"], correct: 1 },
                { question: "En que aÃ±o termino la Segunda Guerra Mundial?", options: ["1943", "1944", "1945", "1946"], correct: 2 },
                { question: "En que aÃ±o llego Colon a America?", options: ["1492", "1500", "1510", "1520"], correct: 0 }
            ],
            geography: [
                { question: "Cual es el rio mas largo del mundo?", options: ["Amazonas", "Nilo", "Yangtse", "Misisipi"], correct: 1 },
                { question: "Cual es la montaÃ±a mas alta del mundo?", options: ["K2", "Kangchenjunga", "Everest", "Makalu"], correct: 2 },
                { question: "Cual es la capital de Australia?", options: ["Sidney", "Melbourne", "Canberra", "Brisbane"], correct: 2 },
                { question: "Cual es el desierto mas grande del mundo?", options: ["Sahara", "Gobi", "Antartico", "Arabia"], correct: 0 },
                { question: "Cual es la capital de Canada?", options: ["Toronto", "Vancouver", "Montreal", "Ottawa"], correct: 3 }
            ]
        };

        const playerColors = ['#0595AE', '#73A03F', '#EB8225', '#AB3D8B'];
        
        let airconsole;
        let players = {};
        let gameState = 'waiting';
        let currentQuestion = 0;
        let gameQuestions = [];
        let questionStartTime = 0;
        let answers = {};
        let selectedCategory = 'general';
        let timer = null;
        let timeLeft = 20;
        let soundEnabled = true;
        let adminDeviceId = null;

        const domCache = {};

        function cacheDomElements() {
            domCache.timerCircle = document.getElementById('timerCircle');
            domCache.timerBarFill = document.getElementById('timerBarFill');
            domCache.questionNumber = document.getElementById('questionNumber');
            domCache.questionText = document.getElementById('questionText');
            domCache.optionsGrid = document.getElementById('optionsGrid');
            domCache.playersStatus = document.getElementById('playersStatus');
            domCache.scoreboardList = document.getElementById('scoreboardList');
            domCache.playersGrid = document.getElementById('playersGrid');
            domCache.adminHint = document.getElementById('adminHint');
        }

        let audioContext;

        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playSound(type) {
            if (!soundEnabled) return;
            initAudio();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            switch(type) {
                case 'join':
                    oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(784, audioContext.currentTime + 0.1);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'correct':
                    [523, 659, 784].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.15, audioContext.currentTime + i * 0.08);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.08 + 0.15);
                        osc.start(audioContext.currentTime + i * 0.08);
                        osc.stop(audioContext.currentTime + i * 0.08 + 0.15);
                    });
                    break;
                case 'wrong':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                    oscillator.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                    gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'tick':
                    oscillator.frequency.value = 800;
                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.05);
                    break;
                case 'victory':
                    [523, 659, 784, 1047].forEach((freq, i) => {
                        const osc = audioContext.createOscillator();
                        const gain = audioContext.createGain();
                        osc.connect(gain);
                        gain.connect(audioContext.destination);
                        osc.frequency.value = freq;
                        gain.gain.setValueAtTime(0.2, audioContext.currentTime + i * 0.15);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + i * 0.15 + 0.3);
                        osc.start(audioContext.currentTime + i * 0.15);
                        osc.stop(audioContext.currentTime + i * 0.15 + 0.3);
                    });
                    break;
            }
        }

        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            container.innerHTML = '';
            const colors = ['#0595AE', '#AB3D8B', '#EB8225', '#73A03F'];
            
            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 2 + 's';
                confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(confetti);
            }
            
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function setCategoryBackground(category) {
            document.body.className = 'cat-' + (categories[category]?.color || 'default') + ' font-sans text-steam-negro overflow-hidden';
        }

        function init() {
            airconsole = new AirConsole();
            cacheDomElements();

            airconsole.onReady = function() {
                console.log('Screen ready');
                setupCategories();
            };

            airconsole.onConnect = function(deviceId) {
                console.log('Device connected:', deviceId);
            };

            airconsole.onDisconnect = function(deviceId) {
                if (players[deviceId]) {
                    players[deviceId].disconnected = true;
                    updatePlayersDisplay();
                    airconsole.broadcast({ action: 'playerDisconnected', playerId: deviceId, playerName: players[deviceId].name });
                }
            };

            airconsole.onMessage = function(deviceId, data) {
                console.log("Received:", data.action, "from", deviceId);
                
                if (data.action === 'join') {
                    const isAdmin = adminDeviceId === null;
                    if (isAdmin) adminDeviceId = deviceId;
                    
                    players[deviceId] = {
                        id: deviceId,
                        name: data.name,
                        score: 0,
                        color: playerColors[Object.keys(players).length % playerColors.length],
                        isAdmin: isAdmin,
                        disconnected: false
                    };
                    
                    playSound('join');
                    updatePlayersDisplay();
                    
                    airconsole.message(deviceId, { 
                        action: 'joined', 
                        color: players[deviceId].color,
                        isAdmin: isAdmin,
                        gameState: gameState,
                        selectedCategory: selectedCategory
                    });
                    
                    if (isAdmin && gameState === 'waiting') {
                        showScreen('category');
                        gameState = 'categorySelect';
                    }
                    
                    broadcastGameState();
                    
                } else if (data.action === 'selectCategory' && deviceId === adminDeviceId) {
                    selectedCategory = data.category;
                    setCategoryBackground(selectedCategory);
                    
                    document.querySelectorAll('.category-card').forEach(card => {
                        card.classList.remove('border-steam-verde', 'bg-green-50');
                        card.classList.add('border-gray-200');
                    });
                    const selected = document.querySelector(`[data-category="${data.category}"]`);
                    if (selected) {
                        selected.classList.remove('border-gray-200');
                        selected.classList.add('border-steam-verde', 'bg-green-50');
                    }
                    
                    airconsole.broadcast({ action: 'categorySelected', category: data.category });
                    
                } else if (data.action === 'startGame' && deviceId === adminDeviceId) {
                    startGame();
                    
                } else if (data.action === 'answer' && gameState === 'playing') {
                    handleAnswer(deviceId, data.option, data.timestamp);
                    
                } else if (data.action === 'playAgain' && deviceId === adminDeviceId) {
                    resetGame();
                }
            };

            document.getElementById('soundToggle').addEventListener('click', toggleSound);
        }

        function broadcastGameState() {
            airconsole.broadcast({
                action: 'gameStateUpdate',
                gameState: gameState,
                selectedCategory: selectedCategory,
                players: players,
                adminId: adminDeviceId
            });
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById('soundToggle').textContent = soundEnabled ? 'ðŸ”Š' : 'ðŸ”‡';
        }

        function setupCategories() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            Object.entries(categories).forEach(([key, category]) => {
                const card = document.createElement('div');
                card.className = 'category-card bg-white border-[3px] border-gray-200 rounded-2xl p-5 text-center cursor-pointer transition-all shadow-md hover:border-steam-turquesa hover:-translate-y-1 hover:shadow-lg';
                card.dataset.category = key;
                card.innerHTML = `
                    <div class="text-4xl mb-3">${category.emoji}</div>
                    <div class="text-lg font-bold">${category.name}</div>
                `;
                grid.appendChild(card);
            });
            document.querySelector('.category-card')?.classList.add('border-steam-verde', 'bg-green-50');
        }

        function updatePlayersDisplay() {
            const grid = domCache.playersGrid || document.getElementById('playersGrid');
            const fragment = document.createDocumentFragment();
            
            Object.values(players).forEach(player => {
                const card = document.createElement('div');
                let borderClass = 'border-gray-200';
                let bgClass = 'bg-white';
                
                if (player.disconnected) {
                    borderClass = 'border-steam-morado';
                    bgClass = 'bg-pink-50 opacity-60';
                } else if (player.isAdmin) {
                    borderClass = 'border-steam-naranja';
                    bgClass = 'bg-orange-50';
                }
                
                card.className = `${bgClass} border-[3px] ${borderClass} rounded-2xl py-4 px-6 flex items-center gap-3 shadow-lg transition-all`;
                card.innerHTML = `
                    <div class="player-avatar-visual" style="background-color: ${player.color};"></div>
                    <div>
                        <div class="text-lg font-bold">${player.name}</div>
                        <div class="text-sm ${player.disconnected ? 'text-steam-morado' : 'text-steam-verde'}">
                            ${player.disconnected ? 'Desconectado' : (player.isAdmin ? 'Admin' : 'Conectado')}
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });
            
            grid.innerHTML = '';
            grid.appendChild(fragment);

            const adminHint = domCache.adminHint || document.getElementById('adminHint');
            if (adminHint && Object.keys(players).length >= 1) {
                adminHint.classList.remove('hidden');
            }

            updatePlayersStatus();
        }

        function updatePlayersStatus() {
            const container = domCache.playersStatus || document.getElementById('playersStatus');
            if (!container) return;
            
            const fragment = document.createDocumentFragment();
            Object.values(players).forEach(player => {
                const hasAnswered = answers[player.id] !== undefined;
                let borderClass = 'border-gray-200';
                let bgClass = 'bg-white';
                
                if (player.disconnected) {
                    borderClass = 'border-steam-morado';
                    bgClass = 'bg-pink-50';
                } else if (hasAnswered) {
                    borderClass = 'border-steam-verde';
                    bgClass = 'bg-green-50';
                }
                
                const card = document.createElement('div');
                card.className = `flex items-center gap-2 ${bgClass} py-2 px-4 rounded-xl border-2 ${borderClass} transition-all`;
                card.innerHTML = `
                    <div class="player-avatar-visual-small" style="background-color: ${player.color};"></div>
                    <span class="font-bold text-sm">${player.name}</span>
                    ${player.disconnected ? '<span class="text-steam-morado">X</span>' : (hasAnswered ? '<span class="text-steam-verde">âœ“</span>' : '<span class="text-gray-400">...</span>')}
                `;
                fragment.appendChild(card);
            });
            container.innerHTML = '';
            container.appendChild(fragment);
        }

        function startGame() {
            gameState = 'playing';
            currentQuestion = 0;
            
            const categoryQuestions = questions[selectedCategory] || questions.general;
            gameQuestions = [...categoryQuestions].sort(() => Math.random() - 0.5).slice(0, 5);
            
            Object.keys(players).forEach(id => {
                players[id].score = 0;
            });

            setCategoryBackground(selectedCategory);
            showScreen('playing');
            
            airconsole.broadcast({ 
                action: 'gameStart',
                category: selectedCategory,
                question: { index: currentQuestion, total: gameQuestions.length }
            });
            
            setTimeout(() => showQuestion(), 300);
        }

        function showQuestion() {
            answers = {};
            questionStartTime = Date.now();
            timeLeft = 20;
            
            const question = gameQuestions[currentQuestion];
            if (domCache.questionNumber) domCache.questionNumber.textContent = `Pregunta ${currentQuestion + 1} de ${gameQuestions.length}`;
            if (domCache.questionText) domCache.questionText.textContent = question.question;
            
            displayOptions(question);
            updatePlayersStatus();
            updateScoreboard();
            startTimer();
            
            airconsole.broadcast({
                action: 'showQuestion',
                questionIndex: currentQuestion,
                totalQuestions: gameQuestions.length
            });
        }

        function displayOptions(question) {
            const container = domCache.optionsGrid || document.getElementById('optionsGrid');
            container.innerHTML = '';
            
            const letters = ['A', 'B', 'C', 'D'];
            const colors = ['bg-steam-verde', 'bg-steam-morado', 'bg-steam-turquesa', 'bg-steam-naranja'];
            
            const fragment = document.createDocumentFragment();
            question.options.forEach((option, index) => {
                const card = document.createElement('div');
                card.className = 'option-card flex items-center bg-white rounded-xl overflow-hidden border-[3px] border-gray-200 shadow-md transition-all';
                card.dataset.index = index;
                card.innerHTML = `
                    <div class="w-[70px] h-[70px] flex items-center justify-center text-3xl font-bold text-white flex-shrink-0 ${colors[index]}">${letters[index]}</div>
                    <div class="flex-1 p-4 text-lg font-medium">${option}</div>
                `;
                fragment.appendChild(card);
            });
            container.appendChild(fragment);
        }

        function startTimer() {
            clearInterval(timer);
            updateTimerDisplay();
            
            timer = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();
                
                if (timeLeft <= 5) {
                    playSound('tick');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    showResults();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const circle = domCache.timerCircle;
            const barFill = domCache.timerBarFill;
            if (!circle || !barFill) return;
            
            circle.textContent = timeLeft;
            const percentage = (timeLeft / 20) * 100;
            barFill.style.width = `${percentage}%`;
            
            circle.classList.remove('timer-warning', 'timer-danger', 'bg-steam-turquesa', 'bg-steam-naranja', 'bg-steam-morado');
            
            if (timeLeft <= 5) {
                circle.classList.add('bg-steam-morado', 'timer-danger');
            } else if (timeLeft <= 10) {
                circle.classList.add('bg-steam-naranja', 'timer-warning');
            } else {
                circle.classList.add('bg-steam-turquesa');
            }
        }

        function handleAnswer(playerId, optionIndex, timestamp) {
            if (answers[playerId] || players[playerId]?.disconnected) return;

            const timeElapsed = timestamp - questionStartTime;
            const isCorrect = optionIndex === gameQuestions[currentQuestion].correct;

            answers[playerId] = {
                option: optionIndex,
                correct: isCorrect,
                time: timeElapsed
            };

            if (isCorrect) {
                const points = Math.max(100, Math.floor(1000 - (timeElapsed / 20)));
                players[playerId].score += points;
                playSound('correct');
                
                airconsole.message(playerId, { 
                    action: 'result', 
                    correct: true, 
                    points: points
                });
            } else {
                playSound('wrong');
                airconsole.message(playerId, { 
                    action: 'result', 
                    correct: false, 
                    points: 0
                });
            }

            updatePlayersStatus();

            const activePlayers = Object.values(players).filter(p => !p.disconnected);
            if (Object.keys(answers).length >= activePlayers.length) {
                clearInterval(timer);
                setTimeout(() => showResults(), 800);
            }
        }

        function showResults() {
            clearInterval(timer);
            const question = gameQuestions[currentQuestion];
            
            const options = document.querySelectorAll('.option-card');
            options.forEach((opt, index) => {
                if (index === question.correct) {
                    opt.classList.add('bg-steam-verde', 'border-steam-verde', 'option-correct');
                    opt.querySelector('.flex-1').classList.add('text-white');
                } else {
                    const wasSelected = Object.values(answers).some(a => a.option === index);
                    if (wasSelected) {
                        opt.classList.add('bg-steam-morado', 'border-steam-morado', 'option-incorrect');
                        opt.querySelector('.flex-1').classList.add('text-white');
                    }
                }
            });

            updateScoreboard();
            
            airconsole.broadcast({
                action: 'showAnswer',
                correctIndex: question.correct
            });

            setTimeout(() => {
                if (currentQuestion < gameQuestions.length - 1) {
                    currentQuestion++;
                    showQuestion();
                    airconsole.broadcast({ 
                        action: 'nextQuestion', 
                        question: { index: currentQuestion, total: gameQuestions.length }
                    });
                } else {
                    endGame();
                }
            }, 2500);
        }

        function updateScoreboard() {
            const list = document.getElementById('scoreboardList');
            list.innerHTML = '';
            
            const sortedPlayers = Object.values(players)
                .filter(p => !p.disconnected)
                .sort((a, b) => b.score - a.score);
            
            sortedPlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = `flex justify-between items-center p-2 rounded-lg text-sm ${index === 0 ? 'bg-orange-50 border-2 border-steam-naranja' : 'bg-gray-100'}`;
                item.innerHTML = `
                    <div class="flex items-center gap-2">
                        <div class="player-avatar-visual-small" style="background-color: ${player.color};"></div>
                        <span>${player.name}</span>
                    </div>
                    <span class="font-bold">${player.score}</span>
                `;
                list.appendChild(item);
            });
            
            airconsole.broadcast({ action: 'leaderboardUpdate', players: sortedPlayers });
        }

        function endGame() {
            gameState = 'gameEnd';
            showScreen('end');
            
            const sortedPlayers = Object.values(players)
                .filter(p => !p.disconnected)
                .sort((a, b) => b.score - a.score);
            
            const winnerSection = document.getElementById('winnerSection');
            if (sortedPlayers.length > 0) {
                const winner = sortedPlayers[0];
                winnerSection.innerHTML = `
                    <div class="text-6xl mb-4">1er Lugar</div>
                    <div class="flex justify-center mb-4">
                        <div class="player-avatar-visual-large" style="background-color: ${winner.color};"></div>
                    </div>
                    <div class="text-3xl font-bold text-steam-naranja">${winner.name}</div>
                    <div class="text-xl text-steam-verde mt-2">${winner.score} puntos</div>
                `;
                
                playSound('victory');
                createConfetti();
            }
            
            const podium = document.getElementById('podium');
            podium.innerHTML = '';
            
            const medals = ['1ro', '2do', '3ro'];
            const podiumBg = ['bg-gradient-to-r from-yellow-100 to-amber-100 border-steam-naranja', 'bg-gradient-to-r from-gray-100 to-gray-200 border-gray-400', 'bg-gradient-to-r from-orange-100 to-amber-100 border-orange-400'];
            
            sortedPlayers.forEach((player, index) => {
                const item = document.createElement('div');
                item.className = `flex items-center justify-between p-4 rounded-2xl border-[3px] shadow-md ${podiumBg[index] || 'bg-white border-gray-200'}`;
                item.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="text-2xl font-bold">${medals[index] || `#${index + 1}`}</span>
                        <div class="player-avatar-visual" style="background-color: ${player.color};"></div>
                        <span class="text-lg font-bold">${player.name}</span>
                    </div>
                    <span class="text-xl font-bold text-steam-turquesa">${player.score} pts</span>
                `;
                podium.appendChild(item);
            });

            airconsole.broadcast({ 
                action: 'gameEnd', 
                winner: sortedPlayers[0],
                players: sortedPlayers
            });
        }

        function resetGame() {
            gameState = 'categorySelect';
            currentQuestion = 0;
            answers = {};
            clearInterval(timer);
            
            Object.keys(players).forEach(id => {
                players[id].score = 0;
            });
            
            showScreen('category');
            airconsole.broadcast({ action: 'reset', gameState: 'categorySelect' });
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            
            const targetScreen = document.getElementById(screen + 'Screen');
            if (targetScreen) {
                targetScreen.classList.add('active');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
