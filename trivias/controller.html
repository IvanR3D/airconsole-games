<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Trivia - Control</title>
    <script src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: linear-gradient(180deg, #1B4D3E 0%, #0D2818 100%);
            min-height: 100vh;
            color: white;
            overflow: hidden;
            touch-action: manipulation;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        /* JOIN SCREEN */
        .join-screen {
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .join-logo {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .join-title {
            font-size: 2em;
            color: #F4D03F;
            margin-bottom: 10px;
        }

        .join-subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 30px;
        }

        .join-button {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.5em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .join-button:active {
            transform: scale(0.95);
        }

        .join-button:disabled {
            background: #666;
            box-shadow: none;
        }

        /* WAITING SCREEN */
        .waiting-screen {
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .player-info {
            margin-bottom: 30px;
        }

        .player-avatar-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            margin: 0 auto 15px;
            border: 4px solid white;
        }

        .player-name-display {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .admin-badge {
            background: #F4D03F;
            color: #000;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 10px;
        }

        .waiting-message {
            font-size: 1.5em;
            color: #F4D03F;
            margin-bottom: 20px;
        }

        .waiting-animation {
            font-size: 3em;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        /* PLAYING SCREEN */
        .playing-screen {
            padding: 20px;
        }

        .game-info {
            text-align: center;
            margin-bottom: 20px;
        }

        .select-answer-text {
            font-size: 1.3em;
            color: #F4D03F;
            margin-bottom: 15px;
        }

        /* ANSWER BUTTONS - ESTILO AIRCONSOLE */
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            flex: 1;
            max-height: 400px;
        }

        .answer-button {
            border: none;
            border-radius: 15px;
            font-size: 3em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 6px 0 rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .answer-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            border-radius: 15px 15px 0 0;
        }

        .answer-button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.3);
        }

        .answer-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .answer-button.selected {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0, 0, 0, 0.3);
            filter: brightness(0.8);
        }

        .answer-button.correct-highlight {
            animation: correctPulse 0.5s ease infinite;
        }

        .answer-button.wrong-highlight {
            animation: wrongShake 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Colores de los botones */
        .answer-a { background: #8B9A46; box-shadow: 0 6px 0 #6B7A36; }
        .answer-b { background: #C94C4C; box-shadow: 0 6px 0 #A93C3C; }
        .answer-c { background: #4A8B8B; box-shadow: 0 6px 0 #3A7B7B; }
        .answer-d { background: #D4A44C; box-shadow: 0 6px 0 #B4843C; }

        .answer-a:active, .answer-a.selected { box-shadow: 0 2px 0 #6B7A36; }
        .answer-b:active, .answer-b.selected { box-shadow: 0 2px 0 #A93C3C; }
        .answer-c:active, .answer-c.selected { box-shadow: 0 2px 0 #3A7B7B; }
        .answer-d:active, .answer-d.selected { box-shadow: 0 2px 0 #B4843C; }

        /* PLAYER STATUS */
        .player-status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(0, 0, 0, 0.3);
            padding: 15px 20px;
            border-radius: 15px;
            margin-top: 20px;
        }

        .player-mini-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            border: 2px solid white;
        }

        .player-mini-info {
            flex: 1;
            margin-left: 15px;
        }

        .player-mini-name {
            font-weight: bold;
        }

        .player-mini-rank {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .player-mini-score {
            background: #F4D03F;
            color: #000;
            padding: 8px 15px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* QUIT BUTTON */
        .quit-button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 30px;
            font-size: 1em;
            border-radius: 10px;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .quit-button:active {
            background: rgba(255, 255, 255, 0.2);
        }

        /* RESULT FEEDBACK */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-content {
            text-align: center;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .result-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .result-text {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .result-points {
            font-size: 1.5em;
            color: #F4D03F;
        }

        .result-correct {
            color: #4CAF50;
        }

        .result-incorrect {
            color: #f44336;
        }

        /* END SCREEN */
        .end-screen {
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .final-rank {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .final-message {
            font-size: 1.8em;
            color: #F4D03F;
            margin-bottom: 10px;
        }

        .final-score {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 30px;
        }

        .waiting-next {
            font-size: 1.2em;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- JOIN SCREEN -->
        <div class="screen join-screen active" id="joinScreen">
            <div class="join-logo">üéØ</div>
            <h1 class="join-title">STEAM Trivia</h1>
            <p class="join-subtitle">¬°Demuestra tus conocimientos!</p>
            <button class="join-button" id="joinButton">¬°UNIRSE!</button>
        </div>

        <!-- WAITING SCREEN -->
        <div class="screen waiting-screen" id="waitingScreen">
            <div class="player-info">
                <div class="player-avatar-large" id="playerAvatar"></div>
                <div class="player-name-display" id="playerNameDisplay"></div>
                <div class="admin-badge" id="adminBadge" style="display: none;">üëë ADMIN</div>
            </div>
            <div class="waiting-animation">‚è≥</div>
            <p class="waiting-message">Esperando que inicie el juego...</p>
        </div>

        <!-- PLAYING SCREEN -->
        <div class="screen playing-screen" id="playingScreen">
            <div class="game-info">
                <p class="select-answer-text">Selecciona tu respuesta:</p>
            </div>

            <div class="answer-grid" id="answerGrid">
                <button class="answer-button answer-a" data-option="0">A</button>
                <button class="answer-button answer-b" data-option="1">B</button>
                <button class="answer-button answer-c" data-option="2">C</button>
                <button class="answer-button answer-d" data-option="3">D</button>
            </div>

            <div class="player-status-bar">
                <div class="player-mini-avatar" id="miniAvatar"></div>
                <div class="player-mini-info">
                    <div class="player-mini-name" id="miniName"></div>
                    <div class="player-mini-rank" id="miniRank">Rank 1</div>
                </div>
                <div class="player-mini-score" id="miniScore">0</div>
            </div>

            <button class="quit-button" id="quitButton">Salir del juego</button>
        </div>

        <!-- END SCREEN -->
        <div class="screen end-screen" id="endScreen">
            <div class="final-rank" id="finalRank">ü•á</div>
            <p class="final-message" id="finalMessage">¬°Felicidades!</p>
            <div class="final-score" id="finalScore">0 puntos</div>
            <p class="waiting-next">Esperando nueva partida...</p>
        </div>

        <!-- RESULT OVERLAY -->
        <div class="result-overlay" id="resultOverlay">
            <div class="result-content">
                <div class="result-icon" id="resultIcon">‚úì</div>
                <div class="result-text" id="resultText">¬°Correcto!</div>
                <div class="result-points" id="resultPoints">+500 pts</div>
            </div>
        </div>
    </div>

    <script>
        let airconsole;
        let playerName = '';
        let playerEmoji = '';
        let playerColor = '';
        let isAdmin = false;
        let hasAnswered = false;
        let myScore = 0;
        let myRank = 1;

        function init() {
            airconsole = new AirConsole();

            airconsole.onReady = function() {
                console.log('Controller ready');
            };

            airconsole.onMessage = function(from, data) {
                console.log("Controller received:", data.action, data);
                
                if (data.action === 'joined') {
                    playerColor = data.color;
                    playerEmoji = data.emoji;
                    isAdmin = data.isAdmin;
                    
                    document.getElementById('playerAvatar').style.backgroundColor = playerColor;
                    document.getElementById('playerAvatar').textContent = playerEmoji;
                    document.getElementById('playerNameDisplay').textContent = playerName;
                    document.getElementById('adminBadge').style.display = isAdmin ? 'inline-block' : 'none';
                    
                    document.getElementById('miniAvatar').style.backgroundColor = playerColor;
                    document.getElementById('miniAvatar').textContent = playerEmoji;
                    document.getElementById('miniName').textContent = playerName;
                    
                    showScreen('waiting');
                } else if (data.action === 'gameStart') {
                    showScreen('playing');
                    resetAnswer();
                } else if (data.action === 'nextQuestion') {
                    resetAnswer();
                } else if (data.action === 'result') {
                    showResult(data.correct, data.points);
                    if (data.correct) {
                        myScore += data.points;
                        document.getElementById('miniScore').textContent = myScore;
                    }
                } else if (data.action === 'leaderboardUpdate') {
                    updateRank(data.players);
                } else if (data.action === 'gameEnd') {
                    showEndScreen(data.winner, data.players);
                } else if (data.action === 'reset') {
                    resetController();
                }
            };

            document.getElementById('joinButton').addEventListener('click', joinGame);
            
            // Setup answer buttons
            document.querySelectorAll('.answer-button').forEach(btn => {
                btn.addEventListener('click', () => selectAnswer(parseInt(btn.dataset.option)));
            });

            document.getElementById('quitButton').addEventListener('click', () => {
                showScreen('waiting');
            });
        }

        function joinGame() {
            playerName = airconsole.getNickname() || `Jugador ${airconsole.device_id}`;
            const emojis = ['üòÄ', 'üòé', 'ü§ì', 'ü§†', 'üò∫', 'üê∂', 'ü¶ä', 'üêº', 'üê∏', 'ü¶Å', 'ü¶Ñ', 'üêô', 'ü¶ã', 'üê¢'];
            playerEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            airconsole.message(AirConsole.SCREEN, { 
                action: 'join', 
                name: playerName, 
                emoji: playerEmoji 
            });
            
            document.getElementById('joinButton').disabled = true;
            document.getElementById('joinButton').textContent = 'Conectando...';
        }

        function selectAnswer(optionIndex) {
            if (hasAnswered) return;
            hasAnswered = true;
            
            // Visual feedback
            document.querySelectorAll('.answer-button').forEach(btn => {
                btn.disabled = true;
                if (parseInt(btn.dataset.option) === optionIndex) {
                    btn.classList.add('selected');
                }
            });
            
            // Vibrate
            if (navigator.vibrate) navigator.vibrate(50);
            
            // Send answer
            airconsole.message(AirConsole.SCREEN, {
                action: 'answer',
                option: optionIndex,
                timestamp: Date.now()
            });
        }

        function resetAnswer() {
            hasAnswered = false;
            document.querySelectorAll('.answer-button').forEach(btn => {
                btn.disabled = false;
                btn.classList.remove('selected', 'correct-highlight', 'wrong-highlight');
            });
            document.getElementById('resultOverlay').classList.remove('active');
        }

        function showResult(correct, points) {
            const overlay = document.getElementById('resultOverlay');
            const icon = document.getElementById('resultIcon');
            const text = document.getElementById('resultText');
            const pts = document.getElementById('resultPoints');
            
            if (correct) {
                icon.textContent = '‚úì';
                icon.className = 'result-icon result-correct';
                text.textContent = '¬°Correcto!';
                text.className = 'result-text result-correct';
                pts.textContent = `+${points} pts`;
                if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            } else {
                icon.textContent = '‚úó';
                icon.className = 'result-icon result-incorrect';
                text.textContent = 'Incorrecto';
                text.className = 'result-text result-incorrect';
                pts.textContent = '0 pts';
                if (navigator.vibrate) navigator.vibrate(200);
            }
            
            overlay.classList.add('active');
            
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 2000);
        }

        function updateRank(players) {
            const myPlayer = players.find(p => p.name === playerName);
            if (myPlayer) {
                myRank = players.indexOf(myPlayer) + 1;
                myScore = myPlayer.score;
                document.getElementById('miniRank').textContent = `Rank ${myRank}`;
                document.getElementById('miniScore').textContent = myScore;
            }
        }

        function showEndScreen(winner, players) {
            showScreen('end');
            
            const myPlayer = players.find(p => p.name === playerName);
            const rank = players.indexOf(myPlayer) + 1;
            
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            document.getElementById('finalRank').textContent = medals[rank - 1] || `#${rank}`;
            
            if (winner.name === playerName) {
                document.getElementById('finalMessage').textContent = '¬°Ganaste!';
            } else {
                document.getElementById('finalMessage').textContent = `Gan√≥ ${winner.emoji} ${winner.name}`;
            }
            
            document.getElementById('finalScore').textContent = `${myPlayer?.score || 0} puntos`;
        }

        function resetController() {
            hasAnswered = false;
            myScore = 0;
            myRank = 1;
            document.getElementById('miniScore').textContent = '0';
            document.getElementById('miniRank').textContent = 'Rank 1';
            showScreen('waiting');
            resetAnswer();
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screen + 'Screen').classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
