<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Trivia - Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <script type="module">
        // Import Anime.js v4 from esm.sh
        import { animate, stagger } from 'https://esm.sh/animejs';
        window.anime = { animate, stagger };
        console.log('Anime.js v4 loaded from esm.sh');
    </script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F',
                            negro: '#010101',
                            blanco: '#FFFFFF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: white;
        }

        body {
            touch-action: manipulation;
            background: white;
        }

        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        /* Player avatar visual - responsive */
        .player-avatar-visual {
            width: clamp(50px, 15vw, 70px);
            height: clamp(50px, 15vw, 70px);
            border-radius: clamp(10px, 3vw, 14px);
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }

        .player-avatar-visual::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: clamp(10px, 3vw, 14px);
            background: rgba(255,255,255,0.35);
            border-radius: 9px 9px 0 0;
        }

        .player-avatar-visual-small {
            width: clamp(28px, 8vw, 40px);
            height: clamp(28px, 8vw, 40px);
            border-radius: clamp(6px, 1.5vw, 9px);
        }

        .player-avatar-visual-small::before {
            height: clamp(6px, 1.5vw, 9px);
            top: 3px;
            left: 3px;
            right: 3px;
            border-radius: 5px 5px 0 0;
        }

        /* Button 3D effect */
        .btn-3d {
            transition: all 0.08s ease;
        }

        .btn-3d:active:not(:disabled) {
            transform: translateY(4px);
        }

        .btn-verde { box-shadow: 0 6px 0 #5a8030; }
        .btn-verde:active:not(:disabled) { box-shadow: 0 2px 0 #5a8030; }

        .btn-morado { box-shadow: 0 6px 0 #8a3070; }
        .btn-morado:active:not(:disabled) { box-shadow: 0 2px 0 #8a3070; }

        .btn-turquesa { box-shadow: 0 6px 0 #047a91; }
        .btn-turquesa:active:not(:disabled) { box-shadow: 0 2px 0 #047a91; }

        .btn-naranja { box-shadow: 0 6px 0 #c46d1d; }
        .btn-naranja:active:not(:disabled) { box-shadow: 0 2px 0 #c46d1d; }

        /* Answer button shine */
        .answer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            border-radius: 15px 15px 0 0;
            pointer-events: none;
        }

        .answer-btn.selected {
            transform: translateY(4px);
        }

        .answer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .correct-highlight { animation: correctPulse 0.4s ease infinite; }
        .wrong-highlight { animation: wrongShake 0.4s ease; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce-anim { 
            animation: bounce 1s ease infinite;
            display: inline-block;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .pop-in { 
            animation: popIn 0.25s ease forwards;
            display: block;
        }

        /* Answer grid responsive */
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: clamp(8px, 2vw, 12px);
            flex: 1;
            max-height: clamp(200px, 50vh, 400px);
        }

        .answer-btn {
            font-size: clamp(1.5rem, 8vw, 2.5rem);
        }

        /* Pulse animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.02); }
        }

        .pulse {
            animation: pulse 2s ease infinite;
            display: inline-flex;
        }

        /* Animated background particles */
        .bg-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            opacity: 0.4;
            animation: floatParticle 15s infinite ease-in-out;
            will-change: transform;
        }

        @keyframes floatParticle {
            0%, 100% { transform: translate(0, 0) rotate(0deg); opacity: 0.4; }
            25% { transform: translate(30px, -30px) rotate(90deg); opacity: 0.6; }
            50% { transform: translate(0, -60px) rotate(180deg); opacity: 0.4; }
            75% { transform: translate(-30px, -30px) rotate(270deg); opacity: 0.6; }
        }

        .category-icon {
            font-size: clamp(2rem, 8vw, 3rem);
            display: inline-block;
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden font-sans bg-white text-steam-negro">
    <div class="w-full h-full flex flex-col">
        <!-- JOIN SCREEN -->
        <div class="screen active flex-col items-center justify-center p-4 sm:p-8 text-center gap-4 sm:gap-6 relative overflow-hidden bg-white" id="joinScreen">
            <!-- Animated background removed -->
            
            <!-- Content -->
            <div class="relative z-10 w-full max-w-md">
                <!-- Logo Section -->
                <div class="mb-6">
                    <img src="../LogoSteamRD-Color.webp" alt="STEAM RD Logo" class="w-32 h-32 mx-auto mb-4" style="filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.1));">
                </div>
                
                <h1 class="text-4xl sm:text-5xl font-black mb-8 text-steam-turquesa">TRIVIA</h1>
                
                <!-- Info Cards -->
                <div class="space-y-3 mb-8">
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">üéØ</div>
                            <div>
                                <h3 class="font-bold text-sm text-gray-800">Pon a prueba tus conocimientos</h3>
                                <p class="text-xs text-gray-600">Responde preguntas de diferentes categor√≠as</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">üë•</div>
                            <div>
                                <h3 class="font-bold text-sm text-gray-800">Juega con amigos</h3>
                                <p class="text-xs text-gray-600">Hasta 4 jugadores pueden competir</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-4 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="text-2xl">‚ö°</div>
                            <div>
                                <h3 class="font-bold text-sm text-gray-800">Responde r√°pido</h3>
                                <p class="text-xs text-gray-600">Gana m√°s puntos por velocidad</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="bg-steam-verde text-white border-none py-5 px-10 text-xl font-black rounded-full cursor-pointer uppercase w-full shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3" id="joinBtn">
                    <iconify-icon icon="mdi:gamepad-variant" style="font-size: 1.5rem;"></iconify-icon>
                    UNIRSE AL JUEGO
                </button>
                
                <div class="bg-green-50 border-2 border-steam-verde rounded-2xl py-4 px-6 pulse hidden items-center gap-3 mt-4" id="connectingMsg">
                    <div class="w-5 h-5 border-3 border-steam-verde rounded-full animate-spin" style="border-top-color: transparent;"></div>
                    <span class="font-bold text-steam-verde">Conectando...</span>
                </div>
                <div class="bg-red-50 border-2 border-red-500 rounded-2xl py-4 px-6 hidden items-center gap-3 mt-4" id="errorMsg">
                    <div class="text-3xl">‚ö†</div>
                    <div>
                        <p class="font-bold text-red-600">Juego Lleno</p>
                        <p class="text-sm text-gray-600">Ya hay 4 jugadores conectados</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- WAITING SCREEN (Non-admin) -->
        <div class="screen flex-col items-center justify-center p-4 sm:p-6 text-center relative overflow-hidden bg-white" id="waitingScreen">
            <!-- Animated background -->
            <div class="bg-particles" id="waitingControllerBgParticles"></div>
            
            <!-- Content -->
            <div class="relative z-10 w-full max-w-md">
                <div class="mb-6 sm:mb-8">
                    <div class="mx-auto mb-4 sm:mb-5 w-20 h-20 sm:w-24 sm:h-24 rounded-full flex items-center justify-center relative border-4 border-white shadow-lg" id="playerAvatar">
                        <iconify-icon icon="mdi:gamepad-variant" style="font-size: clamp(2.5rem, 8vw, 3.5rem); color: white;"></iconify-icon>
                    </div>
                    <div class="text-xl sm:text-2xl font-black mb-2 text-steam-turquesa" id="playerNameDisplay"></div>
                </div>
                
                <iconify-icon icon="mdi:timer-sand" class="bounce-anim" style="font-size: clamp(3rem, 10vw, 4rem); color: #0595AE;"></iconify-icon>
                
                <div class="bg-green-50 border-3 border-steam-verde rounded-2xl py-4 px-6 mb-6 shadow-lg">
                    <p class="text-lg sm:text-xl font-black text-steam-verde">Esperando que inicie el juego...</p>
                </div>
                
                <div class="text-center" id="nonAdminWaiting">
                    <p class="text-sm sm:text-base mb-4 sm:mb-5 text-gray-600">El Jugador 1 est√° seleccionando la categor√≠a</p>
                    <div class="bg-blue-50 rounded-2xl p-5 sm:p-6 border-2 border-steam-turquesa hidden" id="selectedCategoryDisplay">
                        <div class="text-5xl sm:text-6xl mb-3 sm:mb-4" id="selectedCategoryEmoji">üåç</div>
                        <div class="text-xl sm:text-2xl font-black text-steam-turquesa" id="selectedCategoryName">General</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ADMIN CATEGORY SELECT SCREEN -->
        <div class="screen flex-col p-3 sm:p-5 h-screen overflow-hidden relative bg-white" id="categorySelectScreen">
            <!-- Animated Background -->
            <div class="bg-particles" id="controllerBgParticles"></div>
            <div class="grid-bg"></div>
            
            <!-- Content -->
            <div class="relative z-10 flex flex-col h-full">
                <!-- Admin Badge -->
                <div class="text-center mb-4 sm:mb-5">
                    <div class="inline-flex items-center gap-2 bg-orange-50 border-3 border-steam-naranja rounded-full py-3 px-5 mb-3 shadow-lg">
                        <iconify-icon icon="mdi:crown" style="font-size: 1.5rem; color: #EB8225;"></iconify-icon>
                        <span class="font-black text-sm sm:text-base text-steam-naranja">ERES EL ADMIN</span>
                    </div>
                    <div class="mx-auto mb-2 sm:mb-3 w-16 h-16 sm:w-20 sm:h-20 rounded-full flex items-center justify-center border-3 border-white shadow-lg" id="adminAvatar">
                        <iconify-icon icon="mdi:crown" style="font-size: clamp(2rem, 6vw, 2.5rem); color: white;"></iconify-icon>
                    </div>
                    <div class="text-base sm:text-lg font-black text-steam-naranja" id="adminNameDisplay"></div>
                </div>
                
                <h2 class="text-lg sm:text-xl font-black text-center mb-4 sm:mb-5 text-steam-turquesa">Selecciona una Categor√≠a</h2>
                
                <!-- Categories Grid -->
                <div class="flex-1 overflow-y-auto">
                    <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-5" id="categoryGrid"></div>
                </div>
                
                <!-- Start Button -->
                <button class="bg-steam-turquesa text-white border-none py-4 sm:py-5 px-6 sm:px-8 text-base sm:text-lg font-black rounded-full cursor-pointer uppercase w-full shadow-lg transition-all active:scale-95 flex items-center justify-center gap-3" id="startGameBtn">
                    <iconify-icon icon="mdi:rocket-launch" style="font-size: 1.5rem;"></iconify-icon>
                    INICIAR JUEGO!
                </button>
            </div>
        </div>

        <!-- PLAYING SCREEN -->
        <div class="screen flex-col p-3 sm:p-4 h-full" id="playingScreen">
            <div class="text-center mb-2 sm:mb-4">
                <div class="text-sm sm:text-base text-steam-turquesa font-bold mb-1 sm:mb-2" id="questionIndicator">Pregunta 1 de 5</div>
                <p class="text-base sm:text-lg">Selecciona tu respuesta:</p>
            </div>

            <div class="answer-grid" id="answerGrid">
                <button class="answer-btn bg-steam-verde border-none rounded-xl sm:rounded-2xl font-bold text-white cursor-pointer relative btn-3d btn-verde" data-option="0">A</button>
                <button class="answer-btn bg-steam-morado border-none rounded-xl sm:rounded-2xl font-bold text-white cursor-pointer relative btn-3d btn-morado" data-option="1">B</button>
                <button class="answer-btn bg-steam-turquesa border-none rounded-xl sm:rounded-2xl font-bold text-white cursor-pointer relative btn-3d btn-turquesa" data-option="2">C</button>
                <button class="answer-btn bg-steam-naranja border-none rounded-xl sm:rounded-2xl font-bold text-white cursor-pointer relative btn-3d btn-naranja" data-option="3">D</button>
            </div>

            <div class="flex items-center justify-between bg-gray-100 p-2 sm:p-3 rounded-lg sm:rounded-xl mt-3 sm:mt-4 border-2 border-gray-200">
                <div class="player-avatar-visual-small" id="miniAvatar"></div>
                <div class="flex-1 ml-2 sm:ml-3">
                    <div class="font-bold text-xs sm:text-sm" id="miniName"></div>
                    <div class="text-[10px] sm:text-xs text-gray-500" id="miniRank">Rank 1</div>
                </div>
                <div class="bg-steam-naranja text-white py-1 sm:py-2 px-2 sm:px-3 rounded-lg sm:rounded-xl font-bold text-sm sm:text-lg" id="miniScore">0</div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div class="screen flex-col items-center justify-center p-4 sm:p-6 text-center gap-3 sm:gap-4" id="endScreen">
            <div class="text-4xl sm:text-5xl" id="finalRank">1ro</div>
            <div class="player-avatar-visual mx-auto" id="resultAvatar"></div>
            <p class="text-lg sm:text-xl font-bold text-steam-turquesa" id="finalMessage">Felicidades!</p>
            <div class="text-xl sm:text-2xl font-bold text-steam-verde" id="finalScore">0 puntos</div>
            <button class="bg-steam-morado text-white border-none py-3 sm:py-4 px-6 sm:px-8 text-base sm:text-lg font-bold rounded-full cursor-pointer uppercase btn-3d btn-morado hidden" id="playAgainBtn">JUGAR DE NUEVO</button>
            <p class="text-xs sm:text-sm text-gray-600" id="waitingNextText">Esperando al Jugador 1...</p>
        </div>

        <!-- RESULT OVERLAY -->
        <div class="fixed top-0 left-0 w-full h-full bg-white/95 hidden items-center justify-center z-50" id="resultOverlay">
            <div class="text-center pop-in" id="resultContent">
                <div class="text-5xl sm:text-6xl mb-3 sm:mb-4 result-icon">‚úì</div>
                <div class="text-xl sm:text-2xl font-bold mb-2 result-text">Correcto!</div>
                <div class="text-lg sm:text-xl result-points">+500 pts</div>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            general: { name: "General", icon: "mdi:earth" },
            science: { name: "Ciencia", icon: "mdi:microscope" },
            mathematics: { name: "Matematicas", icon: "mdi:math-compass" },
            robotics: { name: "Robotica", icon: "mdi:robot" },
            chemistry: { name: "Quimica", icon: "mdi:flask" },
            technology: { name: "Tecnologia", icon: "mdi:laptop" },
            history: { name: "Historia", icon: "mdi:book-open-page-variant" },
            geography: { name: "Geografia", icon: "mdi:map" }
        };

        let airconsole;
        let playerName = '';
        let playerColor = '';
        let isAdmin = false;
        let hasAnswered = false;
        let myScore = 0;
        let myRank = 1;
        let selectedCategory = 'general';
        let hasJoined = false; // Track if player has explicitly joined

        const domCache = {};
        
        function cacheDom() {
            domCache.playerAvatar = document.getElementById('playerAvatar');
            domCache.playerNameDisplay = document.getElementById('playerNameDisplay');
            domCache.adminAvatar = document.getElementById('adminAvatar');
            domCache.adminNameDisplay = document.getElementById('adminNameDisplay');
            domCache.miniAvatar = document.getElementById('miniAvatar');
            domCache.miniName = document.getElementById('miniName');
            domCache.miniScore = document.getElementById('miniScore');
            domCache.miniRank = document.getElementById('miniRank');
            domCache.resultAvatar = document.getElementById('resultAvatar');
            domCache.questionIndicator = document.getElementById('questionIndicator');
            domCache.resultOverlay = document.getElementById('resultOverlay');
            domCache.resultContent = document.getElementById('resultContent');
            domCache.answerButtons = document.querySelectorAll('.answer-btn');
        }

        function sendMessage(msg) {
            airconsole.message(AirConsole.SCREEN, msg);
        }

        function init() {
            airconsole = new AirConsole();
            cacheDom();

            airconsole.onReady = function() {
                console.log('Controller ready');
                setupCategoryGrid();
                setupAnswerButtons();
                createJoinParticles();
                
                // Get player name but don't auto-join
                playerName = airconsole.getNickname() || `Jugador ${airconsole.device_id}`;
                console.log('Controller ready, waiting for user to join...');
            };

            airconsole.onMessage = function(from, data) {
                console.log("Received:", data.action);
                
                switch(data.action) {
                    case 'joined':
                        handleJoined(data);
                        break;
                    case 'reconnected':
                        handleReconnected(data);
                        break;
                    case 'gameFull':
                        handleGameFull();
                        break;
                    case 'gameStateUpdate':
                        handleGameStateUpdate(data);
                        break;
                    case 'categorySelected':
                        updateSelectedCategory(data.category);
                        break;
                    case 'gameStart':
                        handleGameStart(data);
                        break;
                    case 'showQuestion':
                        handleShowQuestion(data);
                        break;
                    case 'result':
                        showResult(data.correct, data.points);
                        break;
                    case 'showAnswer':
                        handleShowAnswer(data.correctIndex);
                        break;
                    case 'nextQuestion':
                        handleNextQuestion(data);
                        break;
                    case 'leaderboardUpdate':
                        updateRank(data.players);
                        break;
                    case 'gameEnd':
                        showEndScreen(data.winner, data.players);
                        break;
                    case 'reset':
                        handleReset(data);
                        break;
                }
            };

            // Join button handler
            document.getElementById('joinBtn').addEventListener('click', () => {
                if (!hasJoined) {
                    hasJoined = true;
                    document.getElementById('joinBtn').classList.add('hidden');
                    document.getElementById('connectingMsg').classList.remove('hidden');
                    document.getElementById('connectingMsg').classList.add('flex');
                    
                    // Send join request to screen
                    sendMessage({ action: 'join' });
                    console.log('Join request sent to screen');
                }
            });

            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('playAgainBtn').addEventListener('click', playAgain);
        }

        function createJoinParticles() {
            // Particles disabled - clean background
        }

        function createWaitingControllerParticles() {
            const container = document.getElementById('waitingControllerBgParticles');
            if (!container || container.children.length > 0) return;
            
            const colors = ['#00d9ff', '#00ff88', '#ff00ff', '#ff9900'];
            const icons = ['‚è≥', '‚≠ê', 'üí°', 'üéØ'];
            
            for (let i = 0; i < 6; i++) {
                const particle = document.createElement('div');
                const size = Math.random() * 40 + 20;
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                particle.className = 'particle';
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.borderRadius = '50%';
                particle.style.background = `radial-gradient(circle, ${color}, transparent)`;
                particle.style.boxShadow = `0 0 ${size}px ${color}`;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 5 + 's';
                particle.style.animationDuration = (Math.random() * 15 + 15) + 's';
                particle.style.opacity = '0.4';
                
                container.appendChild(particle);
            }
            
            for (let i = 0; i < 4; i++) {
                const iconEl = document.createElement('div');
                const icon = icons[Math.floor(Math.random() * icons.length)];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                iconEl.className = 'particle icon-particle';
                iconEl.textContent = icon;
                iconEl.style.color = color;
                iconEl.style.fontSize = (Math.random() * 30 + 20) + 'px';
                iconEl.style.left = Math.random() * 100 + '%';
                iconEl.style.top = Math.random() * 100 + '%';
                iconEl.style.animationDelay = Math.random() * 5 + 's';
                iconEl.style.animationDuration = (Math.random() * 20 + 20) + 's';
                iconEl.style.filter = `drop-shadow(0 0 8px ${color})`;
                iconEl.style.opacity = '0.5';
                
                container.appendChild(iconEl);
            }
        }

        function setupCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            
            Object.entries(categories).forEach(([key, cat]) => {
                const btn = document.createElement('div');
                btn.className = `category-btn bg-white border-[3px] ${key === selectedCategory ? 'border-steam-verde bg-green-50' : 'border-gray-200'} rounded-xl sm:rounded-2xl p-3 sm:p-4 text-center cursor-pointer transition-all shadow-md active:scale-95`;
                btn.dataset.category = key;
                btn.innerHTML = `
                    <iconify-icon icon="${cat.icon}" class="category-icon mb-2"></iconify-icon>
                    <div class="text-xs sm:text-sm font-bold">${cat.name}</div>
                `;
                btn.addEventListener('click', () => selectCategory(key));
                grid.appendChild(btn);
            });
            
            // Initialize particles for default category
            if (isAdmin) {
                createControllerParticles(selectedCategory);
            }
        }

        function setupAnswerButtons() {
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!hasAnswered && !btn.disabled) {
                        selectAnswer(parseInt(btn.dataset.option));
                    }
                });
            });
        }

        function handleJoined(data) {
            playerColor = data.color;
            isAdmin = data.isAdmin;
            
            if (data.score !== undefined) {
                myScore = data.score;
            }
            
            updateAvatarDisplays();
            
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
            
            // Ocultar mensaje de conexi√≥n cuando se conecta exitosamente
            document.getElementById('connectingMsg').classList.add('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            
            if (isAdmin) {
                showScreen('categorySelect');
            } else {
                createWaitingControllerParticles();
                showScreen('waiting');
            }
        }

        function handleReconnected(data) {
            playerColor = data.color;
            isAdmin = data.isAdmin;
            
            if (data.score !== undefined) {
                myScore = data.score;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
            }
            
            updateAvatarDisplays();
            
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
            
            // Ocultar mensaje de conexi√≥n cuando se reconecta exitosamente
            document.getElementById('connectingMsg').classList.add('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            
            // Resume appropriate screen based on game state
            if (data.gameState === 'playing') {
                showScreen('playing');
                resetAnswer();
            } else if (data.gameState === 'gameEnd') {
                // Will receive gameEnd message separately
                showScreen('waiting');
            } else if (data.gameState === 'categorySelect') {
                if (isAdmin) {
                    showScreen('categorySelect');
                } else {
                    createWaitingControllerParticles();
                    showScreen('waiting');
                }
            } else {
                if (isAdmin) {
                    showScreen('categorySelect');
                } else {
                    createWaitingControllerParticles();
                    showScreen('waiting');
                }
            }
        }

        function handleGameFull() {
            document.getElementById('connectingMsg').classList.add('hidden');
            document.getElementById('errorMsg').classList.remove('hidden');
            if (navigator.vibrate) navigator.vibrate([200, 100, 200]);
        }

        function updateAvatarDisplays() {
            if (domCache.playerAvatar) {
                domCache.playerAvatar.style.backgroundColor = playerColor;
            }
            if (domCache.playerNameDisplay) domCache.playerNameDisplay.textContent = playerName;
            
            if (domCache.adminAvatar) {
                domCache.adminAvatar.style.backgroundColor = playerColor;
            }
            if (domCache.adminNameDisplay) domCache.adminNameDisplay.textContent = playerName;
            
            if (domCache.miniAvatar) {
                domCache.miniAvatar.style.backgroundColor = playerColor;
            }
            if (domCache.miniName) domCache.miniName.textContent = playerName;
            
            if (domCache.resultAvatar) {
                domCache.resultAvatar.style.backgroundColor = playerColor;
            }
        }

        function handleGameStateUpdate(data) {
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
        }

        function selectCategory(category) {
            selectedCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('border-steam-verde', 'bg-green-50');
                btn.classList.add('border-gray-200');
                if (btn.dataset.category === category) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-steam-verde', 'bg-green-50');
                    
                    // Animate selected icon
                    const icon = btn.querySelector('.category-icon');
                    if (icon && anime && anime.animate) {
                        anime.animate(icon, {
                            scale: [1, 1.3, 1],
                            rotate: ['0deg', '360deg'],
                            duration: 600,
                            ease: 'inOutQuad'
                        });
                    }
                }
            });
            
            // Create background particles
            createControllerParticles(category);
            
            sendMessage({ action: 'selectCategory', category: category });
        }

        function createControllerParticles(category) {
            const container = document.getElementById('controllerBgParticles');
            if (!container) return;
            
            container.innerHTML = '';
            
            const colorMap = {
                general: ['#0595AE', '#73A03F', '#EB8225'],
                science: ['#4CAF50', '#8BC34A', '#CDDC39'],
                mathematics: ['#2196F3', '#03A9F4', '#00BCD4'],
                robotics: ['#E91E63', '#F06292', '#F48FB1'],
                chemistry: ['#4CAF50', '#66BB6A', '#81C784'],
                technology: ['#9C27B0', '#BA68C8', '#CE93D8'],
                history: ['#FF9800', '#FFB74D', '#FFCC80'],
                geography: ['#00BCD4', '#4DD0E1', '#80DEEA']
            };
            
            const colors = colorMap[category] || colorMap.general;
            const icon = categories[category]?.emoji || 'üåç';
            
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                const size = Math.random() * 40 + 20;
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                particle.className = 'particle';
                particle.style.width = size + 'px';
                particle.style.height = size + 'px';
                particle.style.backgroundColor = color;
                particle.style.left = Math.random() * 100 + '%';
                particle.style.top = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 5 + 's';
                particle.style.animationDuration = (Math.random() * 10 + 10) + 's';
                
                container.appendChild(particle);
            }
            
            // Add floating icons
            for (let i = 0; i < 5; i++) {
                const iconEl = document.createElement('div');
                iconEl.className = 'particle';
                iconEl.textContent = icon;
                iconEl.style.fontSize = (Math.random() * 20 + 15) + 'px';
                iconEl.style.left = Math.random() * 100 + '%';
                iconEl.style.top = Math.random() * 100 + '%';
                iconEl.style.animationDelay = Math.random() * 5 + 's';
                iconEl.style.animationDuration = (Math.random() * 15 + 15) + 's';
                iconEl.style.backgroundColor = 'transparent';
                
                container.appendChild(iconEl);
            }
            
            if (typeof anime !== 'undefined' && anime.animate && anime.stagger) {
                anime.animate('.particle', {
                    opacity: [0, 0.2],
                    scale: [0, 1],
                    duration: 800,
                    delay: anime.stagger(40),
                    ease: 'outElastic(1, .8)'
                });
            }
        }

        function updateSelectedCategory(category) {
            selectedCategory = category;
            
            const cat = categories[category];
            if (cat) {
                const emojiEl = document.getElementById('selectedCategoryEmoji');
                emojiEl.innerHTML = `<iconify-icon icon="${cat.icon}" style="font-size: clamp(3rem, 10vw, 4rem); color: #0595AE;"></iconify-icon>`;
                document.getElementById('selectedCategoryName').textContent = cat.name;
                document.getElementById('selectedCategoryDisplay').classList.remove('hidden');
            }
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('border-steam-verde', 'bg-green-50');
                btn.classList.add('border-gray-200');
                if (btn.dataset.category === category) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-steam-verde', 'bg-green-50');
                }
            });
        }

        function startGame() {
            sendMessage({ action: 'startGame' });
        }

        function handleGameStart(data) {
            myScore = 0;
            myRank = 1;
            if (domCache.miniScore) domCache.miniScore.textContent = '0';
            if (domCache.miniRank) domCache.miniRank.textContent = 'Rank 1';
            
            showScreen('playing');
            resetAnswer();
        }

        function handleShowQuestion(data) {
            if (domCache.questionIndicator) {
                domCache.questionIndicator.textContent = `Pregunta ${data.questionIndex + 1} de ${data.totalQuestions}`;
            }
            resetAnswer();
        }

        function handleNextQuestion(data) {
            if (domCache.questionIndicator) {
                domCache.questionIndicator.textContent = `Pregunta ${data.question.index + 1} de ${data.question.total}`;
            }
            resetAnswer();
        }

        function selectAnswer(optionIndex) {
            if (hasAnswered) return;
            hasAnswered = true;
            
            sendMessage({
                action: 'answer',
                option: optionIndex,
                timestamp: Date.now()
            });
            
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    btn.disabled = true;
                    if (parseInt(btn.dataset.option) === optionIndex) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            if (navigator.vibrate) navigator.vibrate(40);
        }

        function resetAnswer() {
            hasAnswered = false;
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('selected', 'correct-highlight', 'wrong-highlight');
                });
            }
            if (domCache.resultOverlay) {
                domCache.resultOverlay.classList.add('hidden');
                domCache.resultOverlay.classList.remove('flex');
            }
        }

        function showResult(correct, points) {
            const overlay = domCache.resultOverlay;
            const content = domCache.resultContent;
            if (!overlay || !content) return;
            
            if (correct) {
                content.innerHTML = `
                    <div class="text-5xl sm:text-6xl mb-3 sm:mb-4 text-steam-verde">‚úì</div>
                    <div class="text-xl sm:text-2xl font-bold mb-2 text-steam-verde">Correcto!</div>
                    <div class="text-lg sm:text-xl text-steam-naranja">+${points} pts</div>
                `;
                myScore += points;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
                if (navigator.vibrate) navigator.vibrate([40, 20, 40]);
            } else {
                content.innerHTML = `
                    <div class="text-5xl sm:text-6xl mb-3 sm:mb-4 text-steam-morado">‚úó</div>
                    <div class="text-xl sm:text-2xl font-bold mb-2 text-steam-morado">Incorrecto</div>
                    <div class="text-lg sm:text-xl text-gray-500">0 pts</div>
                `;
                if (navigator.vibrate) navigator.vibrate(150);
            }
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }, 1200);
        }

        function handleShowAnswer(correctIndex) {
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    const idx = parseInt(btn.dataset.option);
                    if (idx === correctIndex) {
                        btn.classList.add('correct-highlight');
                    } else if (btn.classList.contains('selected')) {
                        btn.classList.add('wrong-highlight');
                    }
                });
            }
        }

        function updateRank(players) {
            const myPlayer = players.find(p => p.name === playerName);
            if (myPlayer) {
                myRank = players.indexOf(myPlayer) + 1;
                myScore = myPlayer.score;
                if (domCache.miniRank) domCache.miniRank.textContent = `Rank ${myRank}`;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
            }
        }

        function showEndScreen(winner, players) {
            showScreen('end');
            
            const myPlayer = players.find(p => p.name === playerName);
            const rank = myPlayer ? players.indexOf(myPlayer) + 1 : players.length;
            
            const medals = ['1ro', '2do', '3ro'];
            document.getElementById('finalRank').textContent = medals[rank - 1] || `#${rank}`;
            
            if (winner && winner.name === playerName) {
                document.getElementById('finalMessage').textContent = 'GANASTE!';
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            } else if (winner) {
                document.getElementById('finalMessage').textContent = `Gano ${winner.name}`;
            }
            
            document.getElementById('finalScore').textContent = `${myPlayer?.score || 0} puntos`;
            
            document.getElementById('playAgainBtn').classList.toggle('hidden', !isAdmin);
            document.getElementById('waitingNextText').classList.toggle('hidden', isAdmin);
        }

        function playAgain() {
            sendMessage({ action: 'playAgain' });
        }

        function handleReset(data) {
            hasAnswered = false;
            myScore = 0;
            myRank = 1;
            if (domCache.miniScore) domCache.miniScore.textContent = '0';
            if (domCache.miniRank) domCache.miniRank.textContent = 'Rank 1';
            
            // Reset error messages
            document.getElementById('connectingMsg').classList.remove('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            
            if (isAdmin) {
                showScreen('categorySelect');
            } else {
                showScreen('waiting');
            }
            resetAnswer();
        }

        const screenCache = {};
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            if (!screenCache[screen]) {
                screenCache[screen] = document.getElementById(screen + 'Screen');
            }
            if (screenCache[screen]) {
                screenCache[screen].classList.add('active');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
