<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Trivia - Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F',
                            negro: '#010101',
                            blanco: '#FFFFFF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            touch-action: manipulation;
        }

        .screen {
            display: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        /* Player avatar visual */
        .player-avatar-visual {
            width: 70px;
            height: 70px;
            border-radius: 14px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
        }

        .player-avatar-visual::before {
            content: '';
            position: absolute;
            top: 5px;
            left: 5px;
            right: 5px;
            height: 14px;
            background: rgba(255,255,255,0.35);
            border-radius: 9px 9px 0 0;
        }

        .player-avatar-visual-small {
            width: 38px;
            height: 38px;
            border-radius: 8px;
        }

        .player-avatar-visual-small::before {
            height: 8px;
            top: 3px;
            left: 3px;
            right: 3px;
            border-radius: 5px 5px 0 0;
        }

        /* Button 3D effect */
        .btn-3d {
            transition: all 0.08s ease;
        }

        .btn-3d:active:not(:disabled) {
            transform: translateY(4px);
        }

        .btn-verde { box-shadow: 0 6px 0 #5a8030; }
        .btn-verde:active:not(:disabled) { box-shadow: 0 2px 0 #5a8030; }

        .btn-morado { box-shadow: 0 6px 0 #8a3070; }
        .btn-morado:active:not(:disabled) { box-shadow: 0 2px 0 #8a3070; }

        .btn-turquesa { box-shadow: 0 6px 0 #047a91; }
        .btn-turquesa:active:not(:disabled) { box-shadow: 0 2px 0 #047a91; }

        .btn-naranja { box-shadow: 0 6px 0 #c46d1d; }
        .btn-naranja:active:not(:disabled) { box-shadow: 0 2px 0 #c46d1d; }

        /* Answer button shine */
        .answer-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            border-radius: 15px 15px 0 0;
            pointer-events: none;
        }

        .answer-btn.selected {
            transform: translateY(4px);
        }

        .answer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        .correct-highlight { animation: correctPulse 0.4s ease infinite; }
        .wrong-highlight { animation: wrongShake 0.4s ease; }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .bounce-anim { animation: bounce 1s ease infinite; }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .pop-in { animation: popIn 0.25s ease; }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden font-sans bg-white text-steam-negro">
    <div class="w-full h-full flex flex-col">
        <!-- JOIN SCREEN -->
        <div class="screen active flex-col items-center justify-center p-8 text-center gap-6" id="joinScreen">
            <div class="flex justify-center mb-2">
                <div class="player-avatar-visual bg-steam-turquesa"></div>
            </div>
            <h1 class="text-2xl font-bold text-steam-turquesa">STEAM Trivia</h1>
            <p class="text-base text-steam-negro/70">Fundacion STEAM RD</p>
            <button class="bg-steam-verde text-white border-none py-4 px-10 text-xl font-bold rounded-full cursor-pointer uppercase btn-3d btn-verde" id="joinButton">Unirse!</button>
        </div>

        <!-- WAITING SCREEN (Non-admin) -->
        <div class="screen flex-col items-center justify-center p-6 text-center" id="waitingScreen">
            <div class="mb-6">
                <div class="player-avatar-visual mx-auto mb-4" id="playerAvatar"></div>
                <div class="text-xl font-bold" id="playerNameDisplay"></div>
            </div>
            <div class="text-4xl mb-4 bounce-anim">...</div>
            <p class="text-lg text-steam-turquesa font-bold mb-4">Esperando que inicie el juego...</p>
            <div class="text-center" id="nonAdminWaiting">
                <p class="text-sm text-gray-600 mb-4">El Jugador 1 esta seleccionando la categoria</p>
                <div class="bg-gray-100 rounded-2xl p-5 border-2 border-gray-200 hidden" id="selectedCategoryDisplay">
                    <div class="text-5xl mb-3" id="selectedCategoryEmoji">üåç</div>
                    <div class="text-xl font-bold text-steam-turquesa" id="selectedCategoryName">General</div>
                </div>
            </div>
        </div>

        <!-- ADMIN CATEGORY SELECT SCREEN -->
        <div class="screen flex-col p-5 overflow-y-auto" id="categorySelectScreen">
            <div class="text-center mb-4">
                <div class="player-avatar-visual mx-auto mb-3" id="adminAvatar"></div>
                <div class="text-lg font-bold" id="adminNameDisplay"></div>
                <div class="bg-steam-naranja text-white py-1 px-4 rounded-full font-bold text-sm inline-block mt-2">ADMIN</div>
            </div>
            <h2 class="text-xl font-bold text-steam-turquesa mb-4 text-center">Selecciona una Categoria</h2>
            <div class="grid grid-cols-2 gap-3 mb-5" id="categoryGrid"></div>
            <button class="bg-steam-turquesa text-white border-none py-4 px-8 text-lg font-bold rounded-full cursor-pointer uppercase btn-3d btn-turquesa w-full" id="startGameBtn">INICIAR JUEGO!</button>
        </div>

        <!-- PLAYING SCREEN -->
        <div class="screen flex-col p-4 h-full" id="playingScreen">
            <div class="text-center mb-4">
                <div class="text-base text-steam-turquesa font-bold mb-2" id="questionIndicator">Pregunta 1 de 5</div>
                <p class="text-lg">Selecciona tu respuesta:</p>
            </div>

            <div class="grid grid-cols-2 gap-3 flex-1 max-h-[350px]" id="answerGrid">
                <button class="answer-btn bg-steam-verde border-none rounded-2xl text-4xl font-bold text-white cursor-pointer relative btn-3d btn-verde" data-option="0">A</button>
                <button class="answer-btn bg-steam-morado border-none rounded-2xl text-4xl font-bold text-white cursor-pointer relative btn-3d btn-morado" data-option="1">B</button>
                <button class="answer-btn bg-steam-turquesa border-none rounded-2xl text-4xl font-bold text-white cursor-pointer relative btn-3d btn-turquesa" data-option="2">C</button>
                <button class="answer-btn bg-steam-naranja border-none rounded-2xl text-4xl font-bold text-white cursor-pointer relative btn-3d btn-naranja" data-option="3">D</button>
            </div>

            <div class="flex items-center justify-between bg-gray-100 p-3 rounded-xl mt-4 border-2 border-gray-200">
                <div class="player-avatar-visual-small" id="miniAvatar"></div>
                <div class="flex-1 ml-3">
                    <div class="font-bold text-sm" id="miniName"></div>
                    <div class="text-xs text-gray-500" id="miniRank">Rank 1</div>
                </div>
                <div class="bg-steam-naranja text-white py-2 px-3 rounded-xl font-bold text-lg" id="miniScore">0</div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div class="screen flex-col items-center justify-center p-6 text-center gap-4" id="endScreen">
            <div class="text-5xl" id="finalRank">1ro</div>
            <div class="player-avatar-visual mx-auto" id="resultAvatar"></div>
            <p class="text-xl font-bold text-steam-turquesa" id="finalMessage">Felicidades!</p>
            <div class="text-2xl font-bold text-steam-verde" id="finalScore">0 puntos</div>
            <button class="bg-steam-morado text-white border-none py-4 px-8 text-lg font-bold rounded-full cursor-pointer uppercase btn-3d btn-morado hidden" id="playAgainBtn">JUGAR DE NUEVO</button>
            <p class="text-sm text-gray-600" id="waitingNextText">Esperando al Jugador 1...</p>
        </div>

        <!-- RESULT OVERLAY -->
        <div class="fixed top-0 left-0 w-full h-full bg-white/95 hidden items-center justify-center z-50" id="resultOverlay">
            <div class="text-center pop-in" id="resultContent">
                <div class="text-6xl mb-4 result-icon">‚úì</div>
                <div class="text-2xl font-bold mb-2 result-text">Correcto!</div>
                <div class="text-xl result-points">+500 pts</div>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            general: { name: "General", emoji: "üåç" },
            science: { name: "Ciencia", emoji: "üî¨" },
            mathematics: { name: "Matematicas", emoji: "üìê" },
            robotics: { name: "Robotica", emoji: "ü§ñ" },
            chemistry: { name: "Quimica", emoji: "‚öóÔ∏è" },
            technology: { name: "Tecnologia", emoji: "üíª" },
            history: { name: "Historia", emoji: "üìú" },
            geography: { name: "Geografia", emoji: "üó∫Ô∏è" }
        };

        let airconsole;
        let playerName = '';
        let playerColor = '';
        let isAdmin = false;
        let hasAnswered = false;
        let myScore = 0;
        let myRank = 1;
        let selectedCategory = 'general';

        const domCache = {};
        
        function cacheDom() {
            domCache.joinButton = document.getElementById('joinButton');
            domCache.playerAvatar = document.getElementById('playerAvatar');
            domCache.playerNameDisplay = document.getElementById('playerNameDisplay');
            domCache.adminAvatar = document.getElementById('adminAvatar');
            domCache.adminNameDisplay = document.getElementById('adminNameDisplay');
            domCache.miniAvatar = document.getElementById('miniAvatar');
            domCache.miniName = document.getElementById('miniName');
            domCache.miniScore = document.getElementById('miniScore');
            domCache.miniRank = document.getElementById('miniRank');
            domCache.resultAvatar = document.getElementById('resultAvatar');
            domCache.questionIndicator = document.getElementById('questionIndicator');
            domCache.resultOverlay = document.getElementById('resultOverlay');
            domCache.resultContent = document.getElementById('resultContent');
            domCache.answerButtons = document.querySelectorAll('.answer-btn');
        }

        function sendMessage(msg) {
            airconsole.message(AirConsole.SCREEN, msg);
        }

        function init() {
            airconsole = new AirConsole();
            cacheDom();

            airconsole.onReady = function() {
                console.log('Controller ready');
                setupCategoryGrid();
                setupAnswerButtons();
            };

            airconsole.onMessage = function(from, data) {
                console.log("Received:", data.action);
                
                switch(data.action) {
                    case 'joined':
                        handleJoined(data);
                        break;
                    case 'gameStateUpdate':
                        handleGameStateUpdate(data);
                        break;
                    case 'categorySelected':
                        updateSelectedCategory(data.category);
                        break;
                    case 'gameStart':
                        handleGameStart(data);
                        break;
                    case 'showQuestion':
                        handleShowQuestion(data);
                        break;
                    case 'result':
                        showResult(data.correct, data.points);
                        break;
                    case 'showAnswer':
                        handleShowAnswer(data.correctIndex);
                        break;
                    case 'nextQuestion':
                        handleNextQuestion(data);
                        break;
                    case 'leaderboardUpdate':
                        updateRank(data.players);
                        break;
                    case 'gameEnd':
                        showEndScreen(data.winner, data.players);
                        break;
                    case 'reset':
                        handleReset(data);
                        break;
                }
            };

            document.getElementById('joinButton').addEventListener('click', joinGame);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('playAgainBtn').addEventListener('click', playAgain);
        }

        function setupCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            
            Object.entries(categories).forEach(([key, cat]) => {
                const btn = document.createElement('div');
                btn.className = `category-btn bg-white border-[3px] ${key === selectedCategory ? 'border-steam-verde bg-green-50' : 'border-gray-200'} rounded-xl p-4 text-center cursor-pointer transition-all shadow-md active:scale-95`;
                btn.dataset.category = key;
                btn.innerHTML = `
                    <div class="text-3xl mb-2">${cat.emoji}</div>
                    <div class="text-sm font-bold">${cat.name}</div>
                `;
                btn.addEventListener('click', () => selectCategory(key));
                grid.appendChild(btn);
            });
        }

        function setupAnswerButtons() {
            document.querySelectorAll('.answer-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!hasAnswered && !btn.disabled) {
                        selectAnswer(parseInt(btn.dataset.option));
                    }
                });
            });
        }

        function joinGame() {
            playerName = airconsole.getNickname() || `Jugador ${airconsole.device_id}`;
            
            sendMessage({ action: 'join', name: playerName });
            
            if (domCache.joinButton) {
                domCache.joinButton.disabled = true;
                domCache.joinButton.textContent = 'Conectando...';
            }
        }

        function handleJoined(data) {
            playerColor = data.color;
            isAdmin = data.isAdmin;
            
            updateAvatarDisplays();
            
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
            
            if (isAdmin) {
                showScreen('categorySelect');
            } else {
                showScreen('waiting');
            }
        }

        function updateAvatarDisplays() {
            if (domCache.playerAvatar) {
                domCache.playerAvatar.style.backgroundColor = playerColor;
            }
            if (domCache.playerNameDisplay) domCache.playerNameDisplay.textContent = playerName;
            
            if (domCache.adminAvatar) {
                domCache.adminAvatar.style.backgroundColor = playerColor;
            }
            if (domCache.adminNameDisplay) domCache.adminNameDisplay.textContent = playerName;
            
            if (domCache.miniAvatar) {
                domCache.miniAvatar.style.backgroundColor = playerColor;
            }
            if (domCache.miniName) domCache.miniName.textContent = playerName;
            
            if (domCache.resultAvatar) {
                domCache.resultAvatar.style.backgroundColor = playerColor;
            }
        }

        function handleGameStateUpdate(data) {
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
        }

        function selectCategory(category) {
            selectedCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('border-steam-verde', 'bg-green-50');
                btn.classList.add('border-gray-200');
                if (btn.dataset.category === category) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-steam-verde', 'bg-green-50');
                }
            });
            
            sendMessage({ action: 'selectCategory', category: category });
        }

        function updateSelectedCategory(category) {
            selectedCategory = category;
            
            const cat = categories[category];
            if (cat) {
                document.getElementById('selectedCategoryEmoji').textContent = cat.emoji;
                document.getElementById('selectedCategoryName').textContent = cat.name;
                document.getElementById('selectedCategoryDisplay').classList.remove('hidden');
            }
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('border-steam-verde', 'bg-green-50');
                btn.classList.add('border-gray-200');
                if (btn.dataset.category === category) {
                    btn.classList.remove('border-gray-200');
                    btn.classList.add('border-steam-verde', 'bg-green-50');
                }
            });
        }

        function startGame() {
            sendMessage({ action: 'startGame' });
        }

        function handleGameStart(data) {
            myScore = 0;
            myRank = 1;
            if (domCache.miniScore) domCache.miniScore.textContent = '0';
            if (domCache.miniRank) domCache.miniRank.textContent = 'Rank 1';
            
            showScreen('playing');
            resetAnswer();
        }

        function handleShowQuestion(data) {
            if (domCache.questionIndicator) {
                domCache.questionIndicator.textContent = `Pregunta ${data.questionIndex + 1} de ${data.totalQuestions}`;
            }
            resetAnswer();
        }

        function handleNextQuestion(data) {
            if (domCache.questionIndicator) {
                domCache.questionIndicator.textContent = `Pregunta ${data.question.index + 1} de ${data.question.total}`;
            }
            resetAnswer();
        }

        function selectAnswer(optionIndex) {
            if (hasAnswered) return;
            hasAnswered = true;
            
            sendMessage({
                action: 'answer',
                option: optionIndex,
                timestamp: Date.now()
            });
            
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    btn.disabled = true;
                    if (parseInt(btn.dataset.option) === optionIndex) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            if (navigator.vibrate) navigator.vibrate(40);
        }

        function resetAnswer() {
            hasAnswered = false;
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('selected', 'correct-highlight', 'wrong-highlight');
                });
            }
            if (domCache.resultOverlay) {
                domCache.resultOverlay.classList.add('hidden');
                domCache.resultOverlay.classList.remove('flex');
            }
        }

        function showResult(correct, points) {
            const overlay = domCache.resultOverlay;
            const content = domCache.resultContent;
            if (!overlay || !content) return;
            
            if (correct) {
                content.innerHTML = `
                    <div class="text-6xl mb-4 text-steam-verde">‚úì</div>
                    <div class="text-2xl font-bold mb-2 text-steam-verde">Correcto!</div>
                    <div class="text-xl text-steam-naranja">+${points} pts</div>
                `;
                myScore += points;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
                if (navigator.vibrate) navigator.vibrate([40, 20, 40]);
            } else {
                content.innerHTML = `
                    <div class="text-6xl mb-4 text-steam-morado">‚úó</div>
                    <div class="text-2xl font-bold mb-2 text-steam-morado">Incorrecto</div>
                    <div class="text-xl text-gray-500">0 pts</div>
                `;
                if (navigator.vibrate) navigator.vibrate(150);
            }
            
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
            
            setTimeout(() => {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }, 1200);
        }

        function handleShowAnswer(correctIndex) {
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    const idx = parseInt(btn.dataset.option);
                    if (idx === correctIndex) {
                        btn.classList.add('correct-highlight');
                    } else if (btn.classList.contains('selected')) {
                        btn.classList.add('wrong-highlight');
                    }
                });
            }
        }

        function updateRank(players) {
            const myPlayer = players.find(p => p.name === playerName);
            if (myPlayer) {
                myRank = players.indexOf(myPlayer) + 1;
                myScore = myPlayer.score;
                if (domCache.miniRank) domCache.miniRank.textContent = `Rank ${myRank}`;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
            }
        }

        function showEndScreen(winner, players) {
            showScreen('end');
            
            const myPlayer = players.find(p => p.name === playerName);
            const rank = myPlayer ? players.indexOf(myPlayer) + 1 : players.length;
            
            const medals = ['1ro', '2do', '3ro'];
            document.getElementById('finalRank').textContent = medals[rank - 1] || `#${rank}`;
            
            if (winner && winner.name === playerName) {
                document.getElementById('finalMessage').textContent = 'GANASTE!';
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            } else if (winner) {
                document.getElementById('finalMessage').textContent = `Gano ${winner.name}`;
            }
            
            document.getElementById('finalScore').textContent = `${myPlayer?.score || 0} puntos`;
            
            document.getElementById('playAgainBtn').classList.toggle('hidden', !isAdmin);
            document.getElementById('waitingNextText').classList.toggle('hidden', isAdmin);
        }

        function playAgain() {
            sendMessage({ action: 'playAgain' });
        }

        function handleReset(data) {
            hasAnswered = false;
            myScore = 0;
            myRank = 1;
            if (domCache.miniScore) domCache.miniScore.textContent = '0';
            if (domCache.miniRank) domCache.miniRank.textContent = 'Rank 1';
            
            if (isAdmin) {
                showScreen('categorySelect');
            } else {
                showScreen('waiting');
            }
            resetAnswer();
        }

        const screenCache = {};
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            if (!screenCache[screen]) {
                screenCache[screen] = document.getElementById(screen + 'Screen');
            }
            if (screenCache[screen]) {
                screenCache[screen].classList.add('active');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
