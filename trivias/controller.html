<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Trivia - Control</title>
    <script src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --steam-turquesa: #0595AE;
            --steam-morado: #AB3D8B;
            --steam-naranja: #EB8225;
            --steam-verde: #73A03F;
            --steam-negro: #010101;
            --steam-blanco: #FFFFFF;
        }

        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            min-height: 100vh;
            color: var(--steam-negro);
            overflow: hidden;
            touch-action: manipulation;
            background: var(--steam-blanco);
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .screen.active {
            display: flex;
            opacity: 1;
        }

        /* JOIN SCREEN */
        .join-screen {
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .join-logo {
            font-size: 3.5em;
            margin-bottom: 15px;
        }

        .join-title {
            font-size: 1.8em;
            color: var(--steam-turquesa);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .join-subtitle {
            font-size: 1.1em;
            color: var(--steam-negro);
            opacity: 0.7;
            margin-bottom: 25px;
        }

        .join-button {
            background: var(--steam-verde);
            color: white;
            border: none;
            padding: 18px 45px;
            font-size: 1.4em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #5a8030;
            transition: all 0.1s ease;
            text-transform: uppercase;
        }

        .join-button:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #5a8030;
        }

        .join-button:disabled {
            background: #ccc;
            box-shadow: 0 4px 0 #999;
        }

        /* WAITING SCREEN */
        .waiting-screen {
            align-items: center;
            justify-content: center;
            padding: 25px;
            text-align: center;
        }

        .player-info {
            margin-bottom: 25px;
        }

        .player-avatar-large {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5em;
            margin: 0 auto 12px;
            border: 4px solid white;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .player-name-display {
            font-size: 1.6em;
            font-weight: bold;
            color: var(--steam-negro);
            margin-bottom: 5px;
        }

        .admin-badge {
            background: var(--steam-naranja);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            margin-top: 8px;
            font-size: 0.9em;
        }

        .waiting-message {
            font-size: 1.3em;
            color: var(--steam-turquesa);
            margin-bottom: 15px;
            font-weight: bold;
        }

        .waiting-animation {
            font-size: 2.5em;
            animation: bounce 1s ease infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* ADMIN CATEGORY SELECTION */
        .category-select-screen {
            padding: 20px;
            overflow-y: auto;
        }

        .category-title {
            text-align: center;
            font-size: 1.4em;
            color: var(--steam-turquesa);
            margin-bottom: 20px;
            font-weight: bold;
        }

        .category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .category-btn {
            background: white;
            border: 3px solid #E0E0E0;
            border-radius: 12px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s ease;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
        }

        .category-btn.selected {
            border-color: var(--steam-verde);
            background: #F5FAF0;
        }

        .category-btn:active {
            transform: scale(0.95);
        }

        .category-btn-emoji {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .category-btn-name {
            font-size: 0.95em;
            font-weight: bold;
            color: var(--steam-negro);
        }

        .start-game-btn {
            background: var(--steam-turquesa);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #047a91;
            transition: all 0.1s ease;
            width: 100%;
            text-transform: uppercase;
        }

        .start-game-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #047a91;
        }

        /* PLAYING SCREEN */
        .playing-screen {
            padding: 15px;
        }

        .game-info {
            text-align: center;
            margin-bottom: 15px;
        }

        .question-indicator {
            font-size: 1em;
            color: var(--steam-turquesa);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .select-answer-text {
            font-size: 1.2em;
            margin-bottom: 10px;
            color: var(--steam-negro);
        }

        /* ANSWER BUTTONS */
        .answer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            flex: 1;
            max-height: 350px;
        }

        .answer-button {
            border: none;
            border-radius: 15px;
            font-size: 2.5em;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .answer-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            border-radius: 15px 15px 0 0;
        }

        .answer-button:active:not(:disabled),
        .answer-button.selected {
            transform: translateY(4px);
        }

        .answer-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .answer-button.correct-highlight {
            animation: correctPulse 0.4s ease infinite;
        }

        .answer-button.wrong-highlight {
            animation: wrongShake 0.4s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.03); }
        }

        @keyframes wrongShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-8px); }
            75% { transform: translateX(8px); }
        }

        /* Button colors */
        .answer-a { background: var(--steam-verde); box-shadow: 0 6px 0 #5a8030; }
        .answer-b { background: var(--steam-morado); box-shadow: 0 6px 0 #8a3070; }
        .answer-c { background: var(--steam-turquesa); box-shadow: 0 6px 0 #047a91; }
        .answer-d { background: var(--steam-naranja); box-shadow: 0 6px 0 #c46d1d; }

        .answer-a:active:not(:disabled), .answer-a.selected { box-shadow: 0 2px 0 #5a8030; }
        .answer-b:active:not(:disabled), .answer-b.selected { box-shadow: 0 2px 0 #8a3070; }
        .answer-c:active:not(:disabled), .answer-c.selected { box-shadow: 0 2px 0 #047a91; }
        .answer-d:active:not(:disabled), .answer-d.selected { box-shadow: 0 2px 0 #c46d1d; }

        /* PLAYER STATUS BAR */
        .player-status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #F5F5F5;
            padding: 12px 15px;
            border-radius: 12px;
            margin-top: 15px;
            border: 2px solid #E0E0E0;
        }

        .player-mini-avatar {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .player-mini-info {
            flex: 1;
            margin-left: 12px;
        }

        .player-mini-name {
            font-weight: bold;
            font-size: 0.95em;
            color: var(--steam-negro);
        }

        .player-mini-rank {
            font-size: 0.8em;
            color: #666;
        }

        .player-mini-score {
            background: var(--steam-naranja);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.1em;
        }

        /* RESULT OVERLAY */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .result-overlay.active {
            display: flex;
        }

        .result-content {
            text-align: center;
            animation: popIn 0.25s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .result-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .result-text {
            font-size: 1.8em;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .result-points {
            font-size: 1.4em;
        }

        .result-correct .result-icon,
        .result-correct .result-text { color: var(--steam-verde); }
        .result-incorrect .result-icon,
        .result-incorrect .result-text { color: var(--steam-morado); }
        .result-correct .result-points { color: var(--steam-naranja); }

        /* END SCREEN */
        .end-screen {
            align-items: center;
            justify-content: center;
            padding: 25px;
            text-align: center;
        }

        .final-rank {
            font-size: 4em;
            margin-bottom: 15px;
        }

        .final-message {
            font-size: 1.6em;
            color: var(--steam-turquesa);
            margin-bottom: 8px;
            font-weight: bold;
        }

        .final-score {
            font-size: 2em;
            font-weight: bold;
            color: var(--steam-verde);
            margin-bottom: 25px;
        }

        .play-again-btn {
            background: var(--steam-morado);
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 1.3em;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 6px 0 #8a3070;
            transition: all 0.1s ease;
            text-transform: uppercase;
            margin-bottom: 15px;
        }

        .play-again-btn:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 #8a3070;
        }

        .waiting-next {
            font-size: 1em;
            color: #666;
        }

        /* NON-ADMIN WAITING */
        .non-admin-waiting {
            text-align: center;
            padding: 20px;
        }

        .non-admin-waiting p {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 10px;
        }

        .selected-category-display {
            background: #F5F5F5;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #E0E0E0;
        }

        .selected-category-emoji {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .selected-category-name {
            font-size: 1.3em;
            font-weight: bold;
            color: var(--steam-turquesa);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- JOIN SCREEN -->
        <div class="screen join-screen active" id="joinScreen">
            <div class="join-logo">üéØ</div>
            <h1 class="join-title">STEAM Trivia</h1>
            <p class="join-subtitle">Fundaci√≥n STEAM RD</p>
            <button class="join-button" id="joinButton">¬°UNIRSE!</button>
        </div>

        <!-- WAITING SCREEN (Non-admin) -->
        <div class="screen waiting-screen" id="waitingScreen">
            <div class="player-info">
                <div class="player-avatar-large" id="playerAvatar"></div>
                <div class="player-name-display" id="playerNameDisplay"></div>
            </div>
            <div class="waiting-animation">‚è≥</div>
            <p class="waiting-message">Esperando que inicie el juego...</p>
            <div class="non-admin-waiting" id="nonAdminWaiting">
                <p>El Jugador 1 est√° seleccionando la categor√≠a</p>
                <div class="selected-category-display" id="selectedCategoryDisplay" style="display: none;">
                    <div class="selected-category-emoji" id="selectedCategoryEmoji">üåç</div>
                    <div class="selected-category-name" id="selectedCategoryName">General</div>
                </div>
            </div>
        </div>

        <!-- ADMIN CATEGORY SELECT SCREEN -->
        <div class="screen category-select-screen" id="categorySelectScreen">
            <div class="player-info" style="margin-bottom: 15px;">
                <div class="player-avatar-large" id="adminAvatar"></div>
                <div class="player-name-display" id="adminNameDisplay"></div>
                <div class="admin-badge">üëë ADMIN</div>
            </div>
            <h2 class="category-title">Selecciona una Categor√≠a</h2>
            <div class="category-grid" id="categoryGrid"></div>
            <button class="start-game-btn" id="startGameBtn">üöÄ ¬°INICIAR JUEGO!</button>
        </div>

        <!-- PLAYING SCREEN -->
        <div class="screen playing-screen" id="playingScreen">
            <div class="game-info">
                <div class="question-indicator" id="questionIndicator">Pregunta 1 de 5</div>
                <p class="select-answer-text">Selecciona tu respuesta:</p>
            </div>

            <div class="answer-grid" id="answerGrid">
                <button class="answer-button answer-a" data-option="0">A</button>
                <button class="answer-button answer-b" data-option="1">B</button>
                <button class="answer-button answer-c" data-option="2">C</button>
                <button class="answer-button answer-d" data-option="3">D</button>
            </div>

            <div class="player-status-bar">
                <div class="player-mini-avatar" id="miniAvatar"></div>
                <div class="player-mini-info">
                    <div class="player-mini-name" id="miniName"></div>
                    <div class="player-mini-rank" id="miniRank">Rank 1</div>
                </div>
                <div class="player-mini-score" id="miniScore">0</div>
            </div>
        </div>

        <!-- END SCREEN -->
        <div class="screen end-screen" id="endScreen">
            <div class="final-rank" id="finalRank">ü•á</div>
            <p class="final-message" id="finalMessage">¬°Felicidades!</p>
            <div class="final-score" id="finalScore">0 puntos</div>
            <button class="play-again-btn" id="playAgainBtn" style="display: none;">üîÑ JUGAR DE NUEVO</button>
            <p class="waiting-next" id="waitingNextText">Esperando al Jugador 1...</p>
        </div>

        <!-- RESULT OVERLAY -->
        <div class="result-overlay" id="resultOverlay">
            <div class="result-content" id="resultContent">
                <div class="result-icon">‚úì</div>
                <div class="result-text">¬°Correcto!</div>
                <div class="result-points">+500 pts</div>
            </div>
        </div>
    </div>

    <script>
        const categories = {
            general: { name: "General", emoji: "üåç" },
            science: { name: "Ciencia", emoji: "üî¨" },
            mathematics: { name: "Matem√°ticas", emoji: "üìê" },
            robotics: { name: "Rob√≥tica", emoji: "ü§ñ" },
            chemistry: { name: "Qu√≠mica", emoji: "‚öóÔ∏è" },
            technology: { name: "Tecnolog√≠a", emoji: "üíª" },
            history: { name: "Historia", emoji: "üìú" },
            geography: { name: "Geograf√≠a", emoji: "üó∫Ô∏è" }
        };

        let airconsole;
        let playerName = '';
        let playerEmoji = '';
        let playerColor = '';
        let isAdmin = false;
        let hasAnswered = false;
        let myScore = 0;
        let myRank = 1;
        let selectedCategory = 'general';

        // Performance: cache de elementos DOM
        const domCache = {};
        
        function cacheDom() {
            domCache.joinButton = document.getElementById('joinButton');
            domCache.playerAvatar = document.getElementById('playerAvatar');
            domCache.playerNameDisplay = document.getElementById('playerNameDisplay');
            domCache.adminAvatar = document.getElementById('adminAvatar');
            domCache.adminNameDisplay = document.getElementById('adminNameDisplay');
            domCache.miniAvatar = document.getElementById('miniAvatar');
            domCache.miniName = document.getElementById('miniName');
            domCache.miniScore = document.getElementById('miniScore');
            domCache.miniRank = document.getElementById('miniRank');
            domCache.questionIndicator = document.getElementById('questionIndicator');
            domCache.resultOverlay = document.getElementById('resultOverlay');
            domCache.resultContent = document.getElementById('resultContent');
            domCache.answerButtons = document.querySelectorAll('.answer-button');
        }

        // Performance: env√≠o r√°pido de mensajes
        function sendMessage(msg) {
            airconsole.message(AirConsole.SCREEN, msg);
        }

        function init() {
            airconsole = new AirConsole();
            cacheDom();

            airconsole.onReady = function() {
                console.log('Controller ready');
                setupCategoryGrid();
                setupAnswerButtons();
            };

            airconsole.onMessage = function(from, data) {
                console.log("Received:", data.action);
                
                switch(data.action) {
                    case 'joined':
                        handleJoined(data);
                        break;
                    case 'gameStateUpdate':
                        handleGameStateUpdate(data);
                        break;
                    case 'categorySelected':
                        updateSelectedCategory(data.category);
                        break;
                    case 'gameStart':
                        handleGameStart(data);
                        break;
                    case 'showQuestion':
                        handleShowQuestion(data);
                        break;
                    case 'result':
                        showResult(data.correct, data.points);
                        break;
                    case 'showAnswer':
                        handleShowAnswer(data.correctIndex);
                        break;
                    case 'nextQuestion':
                        handleNextQuestion(data);
                        break;
                    case 'leaderboardUpdate':
                        updateRank(data.players);
                        break;
                    case 'gameEnd':
                        showEndScreen(data.winner, data.players);
                        break;
                    case 'reset':
                        handleReset(data);
                        break;
                }
            };

            document.getElementById('joinButton').addEventListener('click', joinGame);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('playAgainBtn').addEventListener('click', playAgain);
        }

        function setupCategoryGrid() {
            const grid = document.getElementById('categoryGrid');
            grid.innerHTML = '';
            
            Object.entries(categories).forEach(([key, cat]) => {
                const btn = document.createElement('div');
                btn.className = 'category-btn' + (key === selectedCategory ? ' selected' : '');
                btn.dataset.category = key;
                btn.innerHTML = `
                    <div class="category-btn-emoji">${cat.emoji}</div>
                    <div class="category-btn-name">${cat.name}</div>
                `;
                btn.addEventListener('click', () => selectCategory(key));
                grid.appendChild(btn);
            });
        }

        function setupAnswerButtons() {
            document.querySelectorAll('.answer-button').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!hasAnswered && !btn.disabled) {
                        selectAnswer(parseInt(btn.dataset.option));
                    }
                });
            });
        }

        function joinGame() {
            playerName = airconsole.getNickname() || `Jugador ${airconsole.device_id}`;
            const emojis = ['üòÄ', 'üòé', 'ü§ì', 'ü§†', 'üò∫', 'üê∂', 'ü¶ä', 'üêº', 'üê∏', 'ü¶Å', 'ü¶Ñ', 'üêô'];
            playerEmoji = emojis[Math.floor(Math.random() * emojis.length)];
            
            sendMessage({ action: 'join', name: playerName, emoji: playerEmoji });
            
            if (domCache.joinButton) {
                domCache.joinButton.disabled = true;
                domCache.joinButton.textContent = 'Conectando...';
            }
        }

        function handleJoined(data) {
            playerColor = data.color;
            playerEmoji = data.emoji;
            isAdmin = data.isAdmin;
            
            updateAvatarDisplays();
            
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
            
            if (isAdmin) {
                showScreen('categorySelect');
            } else {
                showScreen('waiting');
            }
        }

        function updateAvatarDisplays() {
            if (domCache.playerAvatar) {
                domCache.playerAvatar.style.backgroundColor = playerColor;
                domCache.playerAvatar.textContent = playerEmoji;
            }
            if (domCache.playerNameDisplay) domCache.playerNameDisplay.textContent = playerName;
            
            if (domCache.adminAvatar) {
                domCache.adminAvatar.style.backgroundColor = playerColor;
                domCache.adminAvatar.textContent = playerEmoji;
            }
            if (domCache.adminNameDisplay) domCache.adminNameDisplay.textContent = playerName;
            
            if (domCache.miniAvatar) {
                domCache.miniAvatar.style.backgroundColor = playerColor;
                domCache.miniAvatar.textContent = playerEmoji;
            }
            if (domCache.miniName) domCache.miniName.textContent = playerName;
        }

        function handleGameStateUpdate(data) {
            if (data.selectedCategory) {
                updateSelectedCategory(data.selectedCategory);
            }
        }

        function selectCategory(category) {
            selectedCategory = category;
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.category === category);
            });
            
            sendMessage({ action: 'selectCategory', category: category });
        }

        function updateSelectedCategory(category) {
            selectedCategory = category;
            
            const cat = categories[category];
            if (cat) {
                document.getElementById('selectedCategoryEmoji').textContent = cat.emoji;
                document.getElementById('selectedCategoryName').textContent = cat.name;
                document.getElementById('selectedCategoryDisplay').style.display = 'block';
            }
            
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.category === category);
            });
        }

        function startGame() {
            sendMessage({ action: 'startGame' });
        }

        function handleGameStart(data) {
            myScore = 0;
            myRank = 1;
            if (domCache.miniScore) domCache.miniScore.textContent = '0';
            if (domCache.miniRank) domCache.miniRank.textContent = 'Rank 1';
            
            showScreen('playing');
            resetAnswer();
        }

        function handleShowQuestion(data) {
            if (domCache.questionIndicator) {
                domCache.questionIndicator.textContent = `Pregunta ${data.questionIndex + 1} de ${data.totalQuestions}`;
            }
            resetAnswer();
        }

        function handleNextQuestion(data) {
            if (domCache.questionIndicator) {
                domCache.questionIndicator.textContent = `Pregunta ${data.question.index + 1} de ${data.question.total}`;
            }
            resetAnswer();
        }

        function selectAnswer(optionIndex) {
            if (hasAnswered) return;
            hasAnswered = true;
            
            // Enviar respuesta PRIMERO para mejor sincronizaci√≥n
            sendMessage({
                action: 'answer',
                option: optionIndex,
                timestamp: Date.now()
            });
            
            // Luego actualizar UI
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    btn.disabled = true;
                    if (parseInt(btn.dataset.option) === optionIndex) {
                        btn.classList.add('selected');
                    }
                });
            }
            
            if (navigator.vibrate) navigator.vibrate(40);
        }

        function resetAnswer() {
            hasAnswered = false;
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    btn.disabled = false;
                    btn.classList.remove('selected', 'correct-highlight', 'wrong-highlight');
                });
            }
            if (domCache.resultOverlay) domCache.resultOverlay.classList.remove('active');
        }

        function showResult(correct, points) {
            const overlay = domCache.resultOverlay;
            const content = domCache.resultContent;
            if (!overlay || !content) return;
            
            if (correct) {
                content.className = 'result-content result-correct';
                content.innerHTML = `
                    <div class="result-icon">‚úì</div>
                    <div class="result-text">¬°Correcto!</div>
                    <div class="result-points">+${points} pts</div>
                `;
                myScore += points;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
                if (navigator.vibrate) navigator.vibrate([40, 20, 40]);
            } else {
                content.className = 'result-content result-incorrect';
                content.innerHTML = `
                    <div class="result-icon">‚úó</div>
                    <div class="result-text">Incorrecto</div>
                    <div class="result-points">0 pts</div>
                `;
                if (navigator.vibrate) navigator.vibrate(150);
            }
            
            overlay.classList.add('active');
            
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 1200);
        }

        function handleShowAnswer(correctIndex) {
            if (domCache.answerButtons) {
                domCache.answerButtons.forEach(btn => {
                    const idx = parseInt(btn.dataset.option);
                    if (idx === correctIndex) {
                        btn.classList.add('correct-highlight');
                    } else if (btn.classList.contains('selected')) {
                        btn.classList.add('wrong-highlight');
                    }
                });
            }
        }

        function updateRank(players) {
            const myPlayer = players.find(p => p.name === playerName);
            if (myPlayer) {
                myRank = players.indexOf(myPlayer) + 1;
                myScore = myPlayer.score;
                if (domCache.miniRank) domCache.miniRank.textContent = `Rank ${myRank}`;
                if (domCache.miniScore) domCache.miniScore.textContent = myScore;
            }
        }

        function showEndScreen(winner, players) {
            showScreen('end');
            
            const myPlayer = players.find(p => p.name === playerName);
            const rank = myPlayer ? players.indexOf(myPlayer) + 1 : players.length;
            
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            document.getElementById('finalRank').textContent = medals[rank - 1] || `#${rank}`;
            
            if (winner && winner.name === playerName) {
                document.getElementById('finalMessage').textContent = '¬°GANASTE!';
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            } else if (winner) {
                document.getElementById('finalMessage').textContent = `Gan√≥ ${winner.emoji} ${winner.name}`;
            }
            
            document.getElementById('finalScore').textContent = `${myPlayer?.score || 0} puntos`;
            
            document.getElementById('playAgainBtn').style.display = isAdmin ? 'block' : 'none';
            document.getElementById('waitingNextText').style.display = isAdmin ? 'none' : 'block';
        }

        function playAgain() {
            sendMessage({ action: 'playAgain' });
        }

        function handleReset(data) {
            hasAnswered = false;
            myScore = 0;
            myRank = 1;
            if (domCache.miniScore) domCache.miniScore.textContent = '0';
            if (domCache.miniRank) domCache.miniRank.textContent = 'Rank 1';
            
            if (isAdmin) {
                showScreen('categorySelect');
            } else {
                showScreen('waiting');
            }
            resetAnswer();
        }

        // Performance: cache de pantallas
        const screenCache = {};
        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            if (!screenCache[screen]) {
                screenCache[screen] = document.getElementById(screen + 'Screen');
            }
            if (screenCache[screen]) {
                screenCache[screen].classList.add('active');
            }
        }

        window.onload = init;
    </script>
</body>
</html>
