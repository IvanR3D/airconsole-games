<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Platformer - Control</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    
    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F'
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        /* ==========================================================================
           BASE STYLES
           ========================================================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        
        body {
            touch-action: none;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* ==========================================================================
           AVATAR STYLES
           ========================================================================== */
        .avatar {
            width: clamp(70px, 22vw, 100px);
            height: clamp(70px, 22vw, 100px);
            border-radius: 18px;
            position: relative;
            box-shadow: 0 8px 0 rgba(0,0,0,0.15), 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .avatar::before,
        .avatar::after {
            content: '';
            position: absolute;
            width: 24%;
            height: 24%;
            top: 32%;
            background: radial-gradient(circle at 50% 50%, #222 35%, transparent 36%), white;
            border-radius: 50%;
            animation: idleBlink 4s ease-in-out infinite;
        }
        
        .avatar::before { left: 18%; }
        .avatar::after { right: 18%; animation-delay: 0.05s; }
        
        .avatar-sm {
            width: clamp(45px, 14vw, 60px);
            height: clamp(45px, 14vw, 60px);
            border-radius: 12px;
            box-shadow: 0 5px 0 rgba(0,0,0,0.15);
            position: relative;
        }
        
        .avatar-sm::before,
        .avatar-sm::after {
            content: '';
            position: absolute;
            width: 26%;
            height: 26%;
            top: 30%;
            background: radial-gradient(circle at 50% 50%, #222 35%, transparent 36%), white;
            border-radius: 50%;
            animation: idleBlink 4s ease-in-out infinite;
        }
        
        .avatar-sm::before { left: 16%; }
        .avatar-sm::after { right: 16%; animation-delay: 0.05s; }

        /* ==========================================================================
           COLOR PICKER
           ========================================================================== */
        .color-btn {
            width: clamp(52px, 15vw, 68px);
            height: clamp(52px, 15vw, 68px);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        
        .color-btn:active {
            transform: translateY(3px);
            box-shadow: 0 1px 0 rgba(0,0,0,0.2);
        }
        
        .color-btn.selected {
            transform: scale(1.12);
            border-color: #EB8225;
            box-shadow: 0 0 0 4px #EB8225, 0 6px 20px rgba(235,130,37,0.4);
        }

        /* ==========================================================================
           ACTION BUTTONS
           ========================================================================== */
        .btn {
            border: none;
            border-radius: 50px;
            font-weight: 800;
            text-transform: uppercase;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        
        .btn:active { transform: translateY(4px); }
        
        .btn-verde { background: #73A03F; box-shadow: 0 6px 0 #5a8030; }
        .btn-verde:active { box-shadow: 0 2px 0 #5a8030; }
        
        .btn-turquesa { background: #0595AE; box-shadow: 0 6px 0 #047a91; }
        .btn-turquesa:active { box-shadow: 0 2px 0 #047a91; }
        
        .btn-morado { background: #AB3D8B; box-shadow: 0 6px 0 #8a3070; }
        .btn-morado:active { box-shadow: 0 2px 0 #8a3070; }

        /* ==========================================================================
           GAME CONTROLS
           ========================================================================== */
        .ctrl-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.08s, box-shadow 0.08s;
        }
        
        .ctrl-btn:active,
        .ctrl-btn.pressed { transform: translateY(6px); }

        .jump-btn {
            width: clamp(100px, 30vmin, 150px);
            height: clamp(100px, 30vmin, 150px);
            border-radius: 50%;
            background: #73A03F;
            box-shadow: 0 10px 0 #5a8030;
        }
        
        .jump-btn:active,
        .jump-btn.pressed { box-shadow: 0 2px 0 #5a8030; }

        .move-btn {
            width: clamp(70px, 22vmin, 100px);
            height: clamp(70px, 22vmin, 100px);
            border-radius: 20px;
        }
        
        .left-btn { background: #AB3D8B; box-shadow: 0 8px 0 #8a3070; }
        .left-btn:active,
        .left-btn.pressed { box-shadow: 0 2px 0 #8a3070; }
        
        .right-btn { background: #0595AE; box-shadow: 0 8px 0 #047a91; }
        .right-btn:active,
        .right-btn.pressed { box-shadow: 0 2px 0 #047a91; }

        .ctrl-icon {
            font-size: clamp(2rem, 10vmin, 3.5rem);
            color: white;
            line-height: 1;
        }
        
        .ctrl-label {
            font-size: clamp(0.7rem, 3vmin, 1rem);
            font-weight: 700;
            color: white;
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* ==========================================================================
           RESPONSIVE LAYOUTS
           ========================================================================== */
        
        /* Portrait */
        @media (orientation: portrait) {
            .game-controls {
                flex-direction: column !important;
                gap: clamp(15px, 4vh, 30px) !important;
            }
            .move-gap { gap: clamp(30px, 15vw, 80px) !important; }
            .game-header { display: flex !important; }
        }

        /* Landscape */
        @media (orientation: landscape) {
            .game-controls {
                flex-direction: row !important;
                justify-content: space-around !important;
                align-items: center !important;
                gap: 4vw !important;
                width: 100% !important;
            }
            .jump-btn { width: clamp(80px, 20vmin, 130px); height: clamp(80px, 20vmin, 130px); }
            .move-btn { width: clamp(65px, 16vmin, 90px); height: clamp(65px, 16vmin, 90px); }
            .move-gap { gap: clamp(15px, 5vw, 40px) !important; }
            .game-header { display: none !important; }
            .ctrl-icon { font-size: clamp(1.8rem, 8vmin, 3rem); }
            .ctrl-label { font-size: clamp(0.6rem, 2.5vmin, 0.9rem); }
        }

        /* Small height screens */
        @media (max-height: 400px) {
            .game-header { display: none !important; }
            .jump-btn { width: 70px; height: 70px; }
            .move-btn { width: 60px; height: 60px; }
        }

        /* ==========================================================================
           ANIMATIONS
           ========================================================================== */
        @keyframes idleBlink {
            0%, 42%, 48%, 100% { transform: scaleY(1); }
            45% { transform: scaleY(0.05); }
        }

        @keyframes happyJump {
            0% { transform: scale(1); }
            40% { transform: scale(1.15) translateY(-12px); }
            70% { transform: scale(0.95) translateY(0); }
            100% { transform: scale(1) translateY(0); }
        }
        
        .avatar.jump { animation: happyJump 0.5s ease-out; }

        @keyframes blinkHappy {
            0% { transform: scaleY(1); }
            20% { transform: scaleY(0.05); }
            40% { transform: scaleY(1); }
            60% { transform: scaleY(0.05); }
            80%, 100% { transform: scaleY(1); }
        }
        
        .avatar.blink::before,
        .avatar.blink::after { animation: blinkHappy 0.6s ease-out !important; }

        @keyframes float { 50% { transform: translateY(-8px); } }
        .float { animation: float 3s ease-in-out infinite; }

        @keyframes spin { 50% { transform: rotate(90deg); } }
        .spin { animation: spin 2s ease-in-out infinite; }

        @keyframes pulse { 50% { opacity: 0.6; } }
        .pulse { animation: pulse 2s ease infinite; }

        @keyframes pop {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .pop { animation: pop 0.4s ease-out; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- JOIN SCREEN -->
    <div class="screen flex flex-col items-center justify-center w-full h-full p-6 text-center gap-5" id="joinScreen">
        <div class="float">
            <div class="avatar bg-steam-verde"></div>
        </div>
        <div>
            <h1 class="text-2xl sm:text-3xl font-black text-steam-turquesa">STEAM</h1>
            <h2 class="text-xl sm:text-2xl font-bold text-steam-verde flex items-center justify-center gap-2">
                <iconify-icon icon="mdi:gamepad-variant"></iconify-icon>
                Platformer
            </h2>
        </div>
        <p class="text-sm text-gray-500">Fundacion STEAM RD</p>
        <div class="bg-steam-verde/10 border-2 border-steam-verde rounded-2xl py-4 px-6 pulse flex items-center gap-2" id="connectingMsg">
            <iconify-icon icon="mdi:loading" class="text-steam-verde text-2xl animate-spin"></iconify-icon>
            <span class="text-steam-verde font-bold">Conectando...</span>
        </div>
        <div class="bg-red-500/10 border-2 border-red-500 rounded-2xl py-4 px-6 hidden flex items-center gap-2" id="errorMsg">
            <iconify-icon icon="mdi:alert-circle" class="text-red-500 text-2xl"></iconify-icon>
            <div>
                <p class="text-red-500 font-bold">Juego Lleno</p>
                <p class="text-red-500 text-sm">Ya hay 4 jugadores conectados</p>
            </div>
        </div>
    </div>

    <!-- SELECT SCREEN -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-5 gap-4 overflow-y-auto" id="selectScreen">
        <div class="bg-steam-naranja text-white py-2 px-5 rounded-full font-bold text-sm hidden flex items-center gap-2" id="adminBadge">
            <iconify-icon icon="mdi:crown"></iconify-icon>
            ADMIN
        </div>
        
        <h2 class="text-xl font-bold text-steam-turquesa flex items-center gap-2">
            <iconify-icon icon="mdi:account-edit"></iconify-icon>
            Tu Personaje
        </h2>
        
        <div class="float">
            <div class="avatar" id="avatarDisplay" style="background:#73A03F"></div>
        </div>
        
        <div class="mt-2">
            <p class="text-sm text-gray-500 mb-4 flex items-center justify-center gap-2">
                <iconify-icon icon="mdi:palette"></iconify-icon>
                Elige tu color
            </p>
            <div class="grid grid-cols-4 gap-4" id="colorGrid"></div>
        </div>
        
        <div class="flex items-center gap-2 text-steam-verde font-bold mt-2">
            <iconify-icon icon="mdi:check-circle" class="text-xl"></iconify-icon>
            Listo para jugar
        </div>
        
        <button class="btn btn-turquesa py-4 px-8 text-base hidden pulse mt-2 flex items-center gap-2" id="startBtn">
            <iconify-icon icon="mdi:rocket-launch"></iconify-icon>
            INICIAR JUEGO!
        </button>
        
        <div class="bg-gray-100 rounded-2xl py-4 px-6 border-2 border-gray-200 mt-2 pulse" id="waitingHint">
            <p class="text-sm text-gray-500 flex items-center gap-2">
                <iconify-icon icon="mdi:timer-sand" class="animate-spin"></iconify-icon>
                Esperando al Jugador 1...
            </p>
        </div>
    </div>

    <!-- GAME CONTROLLER -->
    <div class="screen hidden flex-col items-center justify-evenly w-full h-full p-4 bg-[#1B4D3E]" id="gameScreen">
        <div class="flex items-center gap-3 game-header">
            <div class="avatar-sm" id="gameAvatar" style="background:#73A03F"></div>
            <span class="text-xl font-bold text-white" id="gameName">Verde</span>
        </div>
        
        <div class="flex flex-col items-center w-full game-controls">
            <div class="ctrl-btn jump-btn" id="jumpBtn">
                <iconify-icon icon="mdi:arrow-up-bold" class="ctrl-icon"></iconify-icon>
                <span class="ctrl-label">SALTAR</span>
            </div>
            
            <div class="flex items-center justify-center move-gap mt-6">
                <div class="ctrl-btn move-btn left-btn" id="leftBtn">
                    <iconify-icon icon="mdi:arrow-left-bold" class="ctrl-icon"></iconify-icon>
                    <span class="ctrl-label">IZQ</span>
                </div>
                <div class="ctrl-btn move-btn right-btn" id="rightBtn">
                    <iconify-icon icon="mdi:arrow-right-bold" class="ctrl-icon"></iconify-icon>
                    <span class="ctrl-label">DER</span>
                </div>
            </div>
        </div>
        
        <div class="game-header"></div>
    </div>

    <!-- RESULTS SCREEN -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-5 text-center gap-4 bg-gray-50" id="resultsScreen">
        <h2 class="text-2xl font-bold text-steam-turquesa flex items-center gap-2">
            <iconify-icon icon="mdi:flag-checkered"></iconify-icon>
            Fin de Carrera!
        </h2>
        
        <div class="text-5xl font-black pop" id="rankDisplay" style="color:#EB8225">1ro</div>
        
        <div class="avatar" id="resultAvatar" style="background:#73A03F"></div>
        
        <p class="text-xl font-bold text-steam-turquesa" id="resultMsg">Felicidades!</p>
        
        <div class="bg-steam-verde/10 border-2 border-steam-verde rounded-2xl py-3 px-6 flex items-center gap-2">
            <iconify-icon icon="mdi:star" class="text-steam-verde text-xl"></iconify-icon>
            <span class="text-2xl font-black text-steam-verde" id="resultScore">0 pts</span>
        </div>
        
        <div class="flex flex-col gap-3" id="resultsButtonContainer">
            <button class="btn btn-turquesa py-4 px-8 text-base hidden flex items-center gap-2 justify-center" id="nextLevelBtn">
                <iconify-icon icon="mdi:arrow-right-bold"></iconify-icon>
                SIGUIENTE NIVEL
            </button>
            <button class="btn btn-morado py-4 px-8 text-base hidden flex items-center gap-2 justify-center" id="levelSelectBtn">
                <iconify-icon icon="mdi:map-marker-path"></iconify-icon>
                SELECCIONAR NIVEL
            </button>
        </div>
        <p class="text-sm text-gray-500 pulse flex items-center gap-2" id="waitingResult">
            <iconify-icon icon="mdi:timer-sand"></iconify-icon>
            Esperando al Jugador 1...
        </p>
    </div>

    <script>
    /**
     * STEAM Platformer - Mobile Controller
     * 
     * Handles player input and communicates with the screen via AirConsole messages.
     * 
     * @fileoverview Controller module for the STEAM Platformer game
     * @version 2.0.0
     */

    // ==========================================================================
    // CONFIGURATION
    // ==========================================================================
    
    const CONFIG = {
        COLORS: [
            { hex: '#73A03F', name: 'Verde' },
            { hex: '#AB3D8B', name: 'Morado' },
            { hex: '#0595AE', name: 'Turquesa' },
            { hex: '#EB8225', name: 'Naranja' }
        ],
        VIBRATION: {
            ERROR: [200, 100, 200],
            SELECT: 25,
            BUTTON: 15,
            WIN: [80, 40, 80, 40, 80],
            DISCONNECT: 100
        },
        ANIMATION_DURATION: {
            BLINK: 600,
            JUMP: 500
        }
    };

    // ==========================================================================
    // MESSAGE PROTOCOL
    // ==========================================================================
    
    /**
     * Message Protocol Documentation
     * 
     * CONTROLLER → SCREEN:
     * - { action: 'join' } - Fallback join request
     * - { action: 'selectColor', color: string, colorName: string }
     * - { action: 'startGame' } - Admin only
     * - { action: 'playAgain' } - Admin only
     * - { action: 'nextLevel' } - Admin only
     * - { action: 'goToLevelSelect' } - Admin only
     * - { action: 'move', direction: 'left' | 'right' }
     * - { action: 'stop' }
     * - { action: 'jump', pressed: boolean }
     * 
     * SCREEN → CONTROLLER:
     * - { action: 'joined', playerNum, color, colorName, isAdmin }
     * - { action: 'reconnected', playerNum, color, colorName, isAdmin }
     * - { action: 'gameFull' }
     * - { action: 'colorUpdated', color, colorName }
     * - { action: 'gameState', players }
     * - { action: 'levelChanged', level, name }
     * - { action: 'playerDisconnected', playerNum, playerName }
     * - { action: 'gameStart' }
     * - { action: 'gameRestart' }
     * - { action: 'gameResults', results, winner, levelCompleted, hasNextLevel }
     */

    // ==========================================================================
    // DOM UTILITIES
    // ==========================================================================
    
    const DOM = {
        get: (id) => document.getElementById(id),
        
        elements: {
            // Screens
            joinScreen: null,
            selectScreen: null,
            gameScreen: null,
            resultsScreen: null,
            
            // Join screen
            connectingMsg: null,
            errorMsg: null,
            
            // Select screen
            adminBadge: null,
            avatarDisplay: null,
            colorGrid: null,
            startBtn: null,
            waitingHint: null,
            
            // Game screen
            gameAvatar: null,
            gameName: null,
            jumpBtn: null,
            leftBtn: null,
            rightBtn: null,
            
            // Results screen
            rankDisplay: null,
            resultAvatar: null,
            resultMsg: null,
            resultScore: null,
            nextLevelBtn: null,
            levelSelectBtn: null,
            waitingResult: null
        },
        
        init() {
            // Cache all DOM elements
            this.elements.joinScreen = this.get('joinScreen');
            this.elements.selectScreen = this.get('selectScreen');
            this.elements.gameScreen = this.get('gameScreen');
            this.elements.resultsScreen = this.get('resultsScreen');
            
            this.elements.connectingMsg = this.get('connectingMsg');
            this.elements.errorMsg = this.get('errorMsg');
            
            this.elements.adminBadge = this.get('adminBadge');
            this.elements.avatarDisplay = this.get('avatarDisplay');
            this.elements.colorGrid = this.get('colorGrid');
            this.elements.startBtn = this.get('startBtn');
            this.elements.waitingHint = this.get('waitingHint');
            
            this.elements.gameAvatar = this.get('gameAvatar');
            this.elements.gameName = this.get('gameName');
            this.elements.jumpBtn = this.get('jumpBtn');
            this.elements.leftBtn = this.get('leftBtn');
            this.elements.rightBtn = this.get('rightBtn');
            
            this.elements.rankDisplay = this.get('rankDisplay');
            this.elements.resultAvatar = this.get('resultAvatar');
            this.elements.resultMsg = this.get('resultMsg');
            this.elements.resultScore = this.get('resultScore');
            this.elements.nextLevelBtn = this.get('nextLevelBtn');
            this.elements.levelSelectBtn = this.get('levelSelectBtn');
            this.elements.waitingResult = this.get('waitingResult');
        }
    };

    // ==========================================================================
    // VIBRATION MANAGER
    // ==========================================================================
    
    const Vibration = {
        trigger(pattern) {
            if (navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }
    };

    // ==========================================================================
    // ORIENTATION MANAGER
    // ==========================================================================
    
    const OrientationManager = {
        locked: false,
        warningElement: null,
        
        lock() {
            this.locked = true;
            
            if (screen.orientation?.lock) {
                screen.orientation.lock('landscape').catch(() => {
                    this._setupFallback();
                });
            } else {
                this._setupFallback();
            }
        },
        
        unlock() {
            this.locked = false;
            this._hideWarning();
            window.removeEventListener('resize', this._checkBound);
            window.removeEventListener('orientationchange', this._checkBound);
            
            if (screen.orientation?.unlock) {
                screen.orientation.unlock();
            }
        },
        
        _setupFallback() {
            this._checkBound = this._check.bind(this);
            this._check();
            window.addEventListener('resize', this._checkBound);
            window.addEventListener('orientationchange', this._checkBound);
        },
        
        _check() {
            if (!this.locked) return;
            
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isPortrait && !this.warningElement) {
                this._showWarning();
            } else if (!isPortrait && this.warningElement) {
                this._hideWarning();
            }
        },
        
        _showWarning() {
            if (this.warningElement) return;
            
            this.warningElement = document.createElement('div');
            this.warningElement.id = 'orientationWarning';
            this.warningElement.style.cssText = `
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.95);
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                z-index: 9999;
                color: white;
                text-align: center;
                padding: 20px;
            `;
            this.warningElement.innerHTML = `
                <iconify-icon icon="mdi:phone-rotate-landscape" class="text-6xl mb-4 spin"></iconify-icon>
                <h2 class="text-2xl font-bold mb-2">Gira tu dispositivo</h2>
                <p class="text-lg">Para mejor experiencia, usa modo horizontal</p>
            `;
            document.body.appendChild(this.warningElement);
        },
        
        _hideWarning() {
            if (this.warningElement) {
                this.warningElement.remove();
                this.warningElement = null;
            }
        }
    };

    // ==========================================================================
    // SCREEN MANAGER
    // ==========================================================================
    
    const ScreenManager = {
        screens: ['join', 'select', 'game', 'results'],
        
        show(name) {
            this.screens.forEach(s => {
                const el = DOM.get(s + 'Screen');
                const isTarget = s === name;
                el.classList.toggle('hidden', !isTarget);
                el.classList.toggle('flex', isTarget);
            });
        }
    };

    // ==========================================================================
    // AVATAR MANAGER
    // ==========================================================================
    
    const AvatarManager = {
        update(player) {
            DOM.elements.avatarDisplay.style.background = player.color;
            DOM.elements.gameAvatar.style.background = player.color;
            DOM.elements.gameName.textContent = player.name;
            DOM.elements.resultAvatar.style.background = player.color;
        },
        
        playAnimation(type) {
            const avatar = DOM.elements.avatarDisplay;
            
            avatar.classList.remove('jump', 'blink');
            void avatar.offsetWidth; // Force reflow
            
            if (type === 'jump') {
                avatar.classList.add('jump', 'blink');
                setTimeout(() => avatar.classList.remove('blink'), CONFIG.ANIMATION_DURATION.BLINK);
                setTimeout(() => avatar.classList.remove('jump'), CONFIG.ANIMATION_DURATION.JUMP);
            }
        }
    };

    // ==========================================================================
    // CONTROLLER
    // ==========================================================================
    
    const Controller = {
        airconsole: null,
        player: { num: null, color: '#73A03F', name: 'Verde', isAdmin: false },
        keys: { left: false, right: false, jump: false },
        controlsBound: false,
        
        send(msg) {
            this.airconsole.message(AirConsole.SCREEN, msg);
        },
        
        _handleMessage(data) {
            const handlers = {
                'joined': () => this._onJoined(data),
                'reconnected': () => this._onJoined(data),
                'gameFull': () => this._onGameFull(),
                'colorUpdated': () => this._onColorUpdated(data),
                'gameState': () => console.log('Game state updated:', data.players),
                'levelChanged': () => console.log(`Level changed to ${data.level}: ${data.name}`),
                'playerDisconnected': () => this._onPlayerDisconnected(data),
                'gameStart': () => this._onGameStart(),
                'gameRestart': () => this._onGameRestart(),
                'gameResults': () => this._onGameResults(data)
            };
            
            const handler = handlers[data.action];
            if (handler) handler();
        },
        
        _onJoined(data) {
            this.player = {
                num: data.playerNum,
                color: data.color,
                name: data.colorName,
                isAdmin: data.isAdmin
            };
            this._setupSelectScreen();
            ScreenManager.show('select');
        },
        
        _onGameFull() {
            DOM.elements.connectingMsg.classList.add('hidden');
            DOM.elements.errorMsg.classList.remove('hidden');
            Vibration.trigger(CONFIG.VIBRATION.ERROR);
        },
        
        _onColorUpdated(data) {
            this.player.color = data.color;
            this.player.name = data.colorName;
            AvatarManager.update(this.player);
        },
        
        _onPlayerDisconnected(data) {
            if (data.playerNum !== this.player.num) {
                console.log(`Player ${data.playerName} disconnected`);
                Vibration.trigger(CONFIG.VIBRATION.DISCONNECT);
            }
        },
        
        _onGameStart() {
            ScreenManager.show('game');
            this._setupControls();
            OrientationManager.lock();
        },
        
        _onGameRestart() {
            OrientationManager.unlock();
            ScreenManager.show('select');
            DOM.elements.connectingMsg.classList.remove('hidden');
            DOM.elements.errorMsg.classList.add('hidden');
        },
        
        _onGameResults(data) {
            OrientationManager.unlock();
            this._showResults(data.results, data.winner, data.levelCompleted, data.hasNextLevel);
        },
        
        _setupEventListeners() {
            DOM.elements.startBtn.onclick = () => this.send({ action: 'startGame' });
            DOM.elements.nextLevelBtn.onclick = () => this.send({ action: 'nextLevel' });
            DOM.elements.levelSelectBtn.onclick = () => this.send({ action: 'goToLevelSelect' });
            
            // Prevent default touch behaviors
            document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
            document.addEventListener('gesturestart', e => e.preventDefault());
        },
        
        _setupSelectScreen() {
            AvatarManager.update(this.player);
            AvatarManager.playAnimation('jump');
            
            DOM.elements.adminBadge.classList.toggle('hidden', !this.player.isAdmin);
            DOM.elements.startBtn.classList.toggle('hidden', !this.player.isAdmin);
            DOM.elements.waitingHint.classList.toggle('hidden', this.player.isAdmin);
            
            this._renderColorPicker();
        },
        
        _renderColorPicker() {
            const grid = DOM.elements.colorGrid;
            grid.innerHTML = '';
            
            CONFIG.COLORS.forEach(color => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center gap-2';
                
                const btn = document.createElement('div');
                btn.className = `color-btn ${color.hex === this.player.color ? 'selected' : ''}`;
                btn.style.background = color.hex;
                btn.onclick = () => this._selectColor(color.hex, color.name);
                
                const label = document.createElement('span');
                label.className = 'text-xs font-bold text-gray-600';
                label.textContent = color.name;
                
                wrapper.appendChild(btn);
                wrapper.appendChild(label);
                grid.appendChild(wrapper);
            });
        },
        
        _selectColor(hex, name) {
            this.player.color = hex;
            this.player.name = name;
            AvatarManager.update(this.player);
            
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.style.background === hex);
            });
            
            AvatarManager.playAnimation('jump');
            this.send({ action: 'selectColor', color: hex, colorName: name });
            Vibration.trigger(CONFIG.VIBRATION.SELECT);
        },
        
        _setupControls() {
            if (this.controlsBound) return;
            this.controlsBound = true;
            
            const buttons = [
                [DOM.elements.leftBtn, 'left'],
                [DOM.elements.rightBtn, 'right'],
                [DOM.elements.jumpBtn, 'jump']
            ];
            
            buttons.forEach(([element, action]) => {
                // Touch events
                ['touchstart', 'touchend', 'touchcancel'].forEach(evt => {
                    element.addEventListener(evt, (e) => {
                        e.preventDefault();
                        this._handleInput(action, evt === 'touchstart', element);
                    }, { passive: false });
                });
                
                // Mouse events (for testing)
                element.addEventListener('mousedown', () => this._handleInput(action, true, element));
                element.addEventListener('mouseup', () => this._handleInput(action, false, element));
                element.addEventListener('mouseleave', () => this._handleInput(action, false, element));
            });
        },
        
        _handleInput(action, pressed, element) {
            element.classList.toggle('pressed', pressed);
            
            if (pressed) {
                Vibration.trigger(CONFIG.VIBRATION.BUTTON);
            }
            
            if (action === 'jump') {
                this._handleJump(pressed);
            } else {
                this._handleMove(action, pressed);
            }
        },
        
        _handleJump(pressed) {
            if (pressed && !this.keys.jump) {
                this.keys.jump = true;
                this.send({ action: 'jump', pressed: true });
            } else if (!pressed && this.keys.jump) {
                this.keys.jump = false;
                this.send({ action: 'jump', pressed: false });
            }
        },
        
        _handleMove(direction, pressed) {
            const opposite = direction === 'left' ? 'right' : 'left';
            
            if (pressed) {
                this.keys[direction] = true;
                this.keys[opposite] = false;
                this.send({ action: 'move', direction });
            } else if (this.keys[direction]) {
                this.keys[direction] = false;
                this.send(this.keys[opposite] ? { action: 'move', direction: opposite } : { action: 'stop' });
            }
        },
        
        _showResults(results, winner, levelCompleted, hasNextLevel) {
            ScreenManager.show('results');
            
            const me = results.find(r => r.num == this.player.num);
            const rank = me ? results.indexOf(me) + 1 : results.length;
            
            const medals = ['1ro', '2do', '3ro'];
            const colors = ['#EB8225', '#0595AE', '#AB3D8B'];
            
            DOM.elements.rankDisplay.textContent = medals[rank - 1] || `#${rank}`;
            DOM.elements.rankDisplay.style.color = colors[rank - 1] || '#73A03F';
            
            if (winner?.num == this.player.num) {
                DOM.elements.resultMsg.textContent = 'GANASTE!';
                DOM.elements.resultMsg.style.color = '#EB8225';
                Vibration.trigger(CONFIG.VIBRATION.WIN);
            } else {
                DOM.elements.resultMsg.textContent = winner ? `Gano ${winner.name}` : 'Buen juego!';
                DOM.elements.resultMsg.style.color = '#0595AE';
            }
            
            DOM.elements.resultScore.textContent = `${me?.score || 0} pts`;
            
            // Show/hide buttons based on admin status
            if (this.player.isAdmin) {
                const showNextLevel = levelCompleted && hasNextLevel;
                DOM.elements.nextLevelBtn.classList.toggle('hidden', !showNextLevel);
                DOM.elements.levelSelectBtn.classList.remove('hidden');
                DOM.elements.waitingResult.classList.add('hidden');
            } else {
                DOM.elements.nextLevelBtn.classList.add('hidden');
                DOM.elements.levelSelectBtn.classList.add('hidden');
                DOM.elements.waitingResult.classList.remove('hidden');
            }
        },
        
        resetKeys() {
            this.keys = { left: false, right: false, jump: false };
        }
    };

    // ==========================================================================
    // INITIALIZATION
    // ==========================================================================
    
    // Initialize AirConsole immediately (not on window.onload) to catch early events
    const airconsole = new AirConsole();
    
    // DOM must wait for load, but AirConsole handlers are set immediately
    airconsole.onReady = () => {
        console.log('Controller ready');
    };
    
    airconsole.onMessage = (from, data) => {
        Controller._handleMessage(data);
    };
    
    // Store reference in Controller
    Controller.airconsole = airconsole;
    
    // Initialize DOM elements when page loads
    window.onload = () => {
        DOM.init();
        Controller._setupEventListeners();
    };
    </script>
</body>
</html>
