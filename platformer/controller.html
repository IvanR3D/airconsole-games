<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Platformer - Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0; padding: 0; box-sizing: border-box;
            -webkit-user-select: none; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { touch-action: none; font-family: 'Segoe UI', system-ui, sans-serif; }

        /* Clean avatar with simple centered eyes + idle blink */
        .avatar {
            width: clamp(70px, 22vw, 100px);
            height: clamp(70px, 22vw, 100px);
            border-radius: 18px;
            position: relative;
            box-shadow: 0 8px 0 rgba(0,0,0,0.15), 0 10px 30px rgba(0,0,0,0.1);
        }
        .avatar::before,
        .avatar::after {
            content: '';
            position: absolute;
            width: 24%;
            height: 24%;
            top: 32%;
            background: radial-gradient(circle at 50% 50%, #222 35%, transparent 36%),
                        white;
            border-radius: 50%;
            animation: idleBlink 4s ease-in-out infinite;
        }
        .avatar::before { left: 18%; }
        .avatar::after { right: 18%; animation-delay: 0.05s; }
        
        .avatar-sm {
            width: clamp(45px, 14vw, 60px);
            height: clamp(45px, 14vw, 60px);
            border-radius: 12px;
            box-shadow: 0 5px 0 rgba(0,0,0,0.15);
            position: relative;
        }
        .avatar-sm::before,
        .avatar-sm::after {
            content: '';
            position: absolute;
            width: 26%;
            height: 26%;
            top: 30%;
            background: radial-gradient(circle at 50% 50%, #222 35%, transparent 36%),
                        white;
            border-radius: 50%;
            animation: idleBlink 4s ease-in-out infinite;
        }
        .avatar-sm::before { left: 16%; }
        .avatar-sm::after { right: 16%; animation-delay: 0.05s; }

        /* Idle blink - natural blinking */
        @keyframes idleBlink {
            0%, 42%, 48%, 100% { transform: scaleY(1); }
            45% { transform: scaleY(0.05); }
        }

        /* Happy jump when selecting color */
        .avatar.jump {
            animation: happyJump 0.5s ease-out;
        }
        @keyframes happyJump {
            0% { transform: scale(1); }
            40% { transform: scale(1.15) translateY(-12px); }
            70% { transform: scale(0.95) translateY(0); }
            100% { transform: scale(1) translateY(0); }
        }

        /* Fast blink animation when selecting */
        .avatar.blink::before,
        .avatar.blink::after {
            animation: blinkHappy 0.6s ease-out !important;
        }
        @keyframes blinkHappy {
            0% { transform: scaleY(1); }
            20% { transform: scaleY(0.05); }
            40% { transform: scaleY(1); }
            60% { transform: scaleY(0.05); }
            80% { transform: scaleY(1); }
            100% { transform: scaleY(1); }
        }

        /* Float animation */
        @keyframes float { 50% { transform: translateY(-8px); } }
        .float { animation: float 3s ease-in-out infinite; }

        /* Color picker */
        .color-btn {
            width: clamp(52px, 15vw, 68px);
            height: clamp(52px, 15vw, 68px);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2), 0 6px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .color-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 rgba(0,0,0,0.2); }
        .color-btn.selected {
            transform: scale(1.12);
            border-color: #EB8225;
            box-shadow: 0 0 0 4px #EB8225, 0 6px 20px rgba(235,130,37,0.4);
        }

        /* Action buttons */
        .btn {
            border: none;
            border-radius: 50px;
            font-weight: 800;
            text-transform: uppercase;
            color: white;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn:active { transform: translateY(4px); }
        .btn-verde { background: #73A03F; box-shadow: 0 6px 0 #5a8030; }
        .btn-verde:active { box-shadow: 0 2px 0 #5a8030; }
        .btn-turquesa { background: #0595AE; box-shadow: 0 6px 0 #047a91; }
        .btn-turquesa:active { box-shadow: 0 2px 0 #047a91; }
        .btn-morado { background: #AB3D8B; box-shadow: 0 6px 0 #8a3070; }
        .btn-morado:active { box-shadow: 0 2px 0 #8a3070; }

        /* Game controls - responsive for both orientations */
        .ctrl-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.08s, box-shadow 0.08s;
        }
        .ctrl-btn:active, .ctrl-btn.pressed { transform: translateY(6px); }

        .jump-btn {
            width: clamp(100px, 30vmin, 150px);
            height: clamp(100px, 30vmin, 150px);
            border-radius: 50%;
            background: #73A03F;
            box-shadow: 0 10px 0 #5a8030;
        }
        .jump-btn:active, .jump-btn.pressed { box-shadow: 0 2px 0 #5a8030; }

        .move-btn {
            width: clamp(70px, 22vmin, 100px);
            height: clamp(70px, 22vmin, 100px);
            border-radius: 20px;
        }
        .left-btn { background: #AB3D8B; box-shadow: 0 8px 0 #8a3070; }
        .left-btn:active, .left-btn.pressed { box-shadow: 0 2px 0 #8a3070; }
        .right-btn { background: #0595AE; box-shadow: 0 8px 0 #047a91; }
        .right-btn:active, .right-btn.pressed { box-shadow: 0 2px 0 #047a91; }

        .ctrl-icon { font-size: clamp(2rem, 10vmin, 3.5rem); color: white; line-height: 1; }
        .ctrl-label { font-size: clamp(0.7rem, 3vmin, 1rem); font-weight: 700; color: white; margin-top: 4px; text-transform: uppercase; letter-spacing: 0.05em; }

        /* Portrait - vertical layout */
        @media (orientation: portrait) {
            .game-controls {
                flex-direction: column !important;
                gap: clamp(15px, 4vh, 30px) !important;
            }
            .move-gap { gap: clamp(30px, 15vw, 80px) !important; }
            .game-header { display: flex !important; }
        }

        /* Landscape - horizontal layout */
        @media (orientation: landscape) {
            .game-controls {
                flex-direction: row !important;
                justify-content: space-around !important;
                align-items: center !important;
                gap: 4vw !important;
                width: 100% !important;
            }
            .jump-btn { width: clamp(80px, 20vmin, 130px); height: clamp(80px, 20vmin, 130px); }
            .move-btn { width: clamp(65px, 16vmin, 90px); height: clamp(65px, 16vmin, 90px); }
            .move-gap { gap: clamp(15px, 5vw, 40px) !important; }
            .game-header { display: none !important; }
            .ctrl-icon { font-size: clamp(1.8rem, 8vmin, 3rem); }
            .ctrl-label { font-size: clamp(0.6rem, 2.5vmin, 0.9rem); }
        }

        /* Small height screens */
        @media (max-height: 400px) {
            .game-header { display: none !important; }
            .jump-btn { width: 70px; height: 70px; }
            .move-btn { width: 60px; height: 60px; }
        }

        /* Rotate warning */
        @keyframes spin { 50% { transform: rotate(90deg); } }
        .spin { animation: spin 2s ease-in-out infinite; }

        /* Pulse */
        @keyframes pulse { 50% { opacity: 0.6; } }
        .pulse { animation: pulse 2s ease infinite; }

        /* Pop in */
        @keyframes pop { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pop { animation: pop 0.4s ease-out; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- JOIN SCREEN -->
    <div class="screen flex flex-col items-center justify-center w-full h-full p-6 text-center gap-5" id="joinScreen">
        <div class="float">
            <div class="avatar bg-steam-verde"></div>
        </div>
        <div>
            <h1 class="text-2xl sm:text-3xl font-black text-steam-turquesa">STEAM</h1>
            <h2 class="text-xl sm:text-2xl font-bold text-steam-verde flex items-center justify-center gap-2">
                <iconify-icon icon="mdi:gamepad-variant"></iconify-icon>
                Platformer
            </h2>
        </div>
        <p class="text-sm text-gray-500">Fundacion STEAM RD</p>
        <button class="btn btn-verde py-4 px-10 text-lg flex items-center gap-2" id="joinBtn">
            <iconify-icon icon="mdi:play-circle"></iconify-icon>
            UNIRSE!
        </button>
    </div>

    <!-- SELECT SCREEN -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-5 gap-4 overflow-y-auto" id="selectScreen">
        <div class="bg-steam-naranja text-white py-2 px-5 rounded-full font-bold text-sm hidden flex items-center gap-2" id="adminBadge">
            <iconify-icon icon="mdi:crown"></iconify-icon>
            ADMIN
        </div>
        
        <h2 class="text-xl font-bold text-steam-turquesa flex items-center gap-2">
            <iconify-icon icon="mdi:account-edit"></iconify-icon>
            Tu Personaje
        </h2>
        
        <div class="float">
            <div class="avatar" id="avatarDisplay" style="background:#73A03F"></div>
        </div>
        
        <div class="mt-2">
            <p class="text-sm text-gray-500 mb-4 flex items-center justify-center gap-2">
                <iconify-icon icon="mdi:palette"></iconify-icon>
                Elige tu color
            </p>
            <div class="grid grid-cols-4 gap-4" id="colorGrid"></div>
        </div>
        
        <div class="flex items-center gap-2 text-steam-verde font-bold mt-2">
            <iconify-icon icon="mdi:check-circle" class="text-xl"></iconify-icon>
            Listo para jugar
        </div>
        
        <button class="btn btn-turquesa py-4 px-8 text-base hidden pulse mt-2 flex items-center gap-2" id="startBtn">
            <iconify-icon icon="mdi:rocket-launch"></iconify-icon>
            INICIAR JUEGO!
        </button>
        
        <div class="bg-gray-100 rounded-2xl py-4 px-6 border-2 border-gray-200 mt-2 pulse" id="waitingHint">
            <p class="text-sm text-gray-500 flex items-center gap-2">
                <iconify-icon icon="mdi:timer-sand" class="animate-spin"></iconify-icon>
                Esperando al Jugador 1...
            </p>
        </div>
    </div>

    <!-- GAME CONTROLLER -->
    <div class="screen hidden flex-col items-center justify-evenly w-full h-full p-4 bg-[#1B4D3E]" id="gameScreen">
        <!-- Header - shown in portrait -->
        <div class="flex items-center gap-3 game-header">
            <div class="avatar-sm" id="gameAvatar" style="background:#73A03F"></div>
            <span class="text-xl font-bold text-white" id="gameName">Verde</span>
        </div>
        
        <!-- Controls -->
        <div class="flex flex-col items-center w-full game-controls">
            <div class="ctrl-btn jump-btn" id="jumpBtn">
                <iconify-icon icon="mdi:arrow-up-bold" class="ctrl-icon"></iconify-icon>
                <span class="ctrl-label">SALTAR</span>
            </div>
            
            <div class="flex items-center justify-center move-gap mt-6">
                <div class="ctrl-btn move-btn left-btn" id="leftBtn">
                    <iconify-icon icon="mdi:arrow-left-bold" class="ctrl-icon"></iconify-icon>
                    <span class="ctrl-label">IZQ</span>
                </div>
                <div class="ctrl-btn move-btn right-btn" id="rightBtn">
                    <iconify-icon icon="mdi:arrow-right-bold" class="ctrl-icon"></iconify-icon>
                    <span class="ctrl-label">DER</span>
                </div>
            </div>
        </div>
        
        <!-- Spacer for portrait mode -->
        <div class="game-header"></div>
    </div>

    <!-- RESULTS SCREEN -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-5 text-center gap-4 bg-gray-50" id="resultsScreen">
        <h2 class="text-2xl font-bold text-steam-turquesa flex items-center gap-2">
            <iconify-icon icon="mdi:flag-checkered"></iconify-icon>
            Fin de Carrera!
        </h2>
        
        <div class="text-5xl font-black pop" id="rankDisplay" style="color:#EB8225">1ro</div>
        
        <div class="avatar" id="resultAvatar" style="background:#73A03F"></div>
        
        <p class="text-xl font-bold text-steam-turquesa" id="resultMsg">Felicidades!</p>
        
        <div class="bg-steam-verde/10 border-2 border-steam-verde rounded-2xl py-3 px-6 flex items-center gap-2">
            <iconify-icon icon="mdi:star" class="text-steam-verde text-xl"></iconify-icon>
            <span class="text-2xl font-black text-steam-verde" id="resultScore">0 pts</span>
        </div>
        
        <button class="btn btn-morado py-4 px-8 text-base hidden flex items-center gap-2" id="againBtn">
            <iconify-icon icon="mdi:replay"></iconify-icon>
            JUGAR DE NUEVO
        </button>
        <p class="text-sm text-gray-500 pulse flex items-center gap-2" id="waitingResult">
            <iconify-icon icon="mdi:timer-sand"></iconify-icon>
            Esperando al Jugador 1...
        </p>
    </div>

    <script>
        const airconsole = new AirConsole();
        
        const COLORS = [
            { hex: '#73A03F', name: 'Verde' },
            { hex: '#AB3D8B', name: 'Morado' },
            { hex: '#0595AE', name: 'Turquesa' },
            { hex: '#EB8225', name: 'Naranja' }
        ];
        
        let player = { num: null, color: '#73A03F', name: 'Verde', isAdmin: false };
        let keys = { left: false, right: false, jump: false };
        
        const $ = (id) => document.getElementById(id);
        const send = (msg) => airconsole.message(AirConsole.SCREEN, msg);

        function init() {
            airconsole.onReady = () => console.log('Controller ready');
            
            airconsole.onMessage = (from, data) => {
                switch(data.action || data.type) {
                    case 'joined':
                        player = { num: data.playerNum, color: data.color, name: data.colorName, isAdmin: data.isAdmin };
                        setupSelect();
                        showScreen('select');
                        break;
                    case 'colorUpdated':
                        player.color = data.color;
                        player.name = data.colorName;
                        updateAvatars();
                        break;
                    case 'gameStart':
                        showScreen('game');
                        setupControls();
                        lockLandscape();
                        break;
                    case 'gameRestart':
                        unlock();
                        showScreen('select');
                        break;
                    case 'gameResults':
                        showResults(data.results, data.winner);
                        break;
                }
            };

            $('joinBtn').onclick = () => {
                send({ action: 'join' });
                $('joinBtn').disabled = true;
                $('joinBtn').textContent = 'Conectando...';
            };
            
            $('startBtn').onclick = () => send({ action: 'startGame' });
            $('againBtn').onclick = () => send({ action: 'playAgain' });
        }

        function setupSelect() {
            updateAvatars();
            
            // Play join animation
            const avatar = $('avatarDisplay');
            avatar.classList.add('jump', 'blink');
            setTimeout(() => avatar.classList.remove('blink'), 600);
            setTimeout(() => avatar.classList.remove('jump'), 500);
            
            $('adminBadge').classList.toggle('hidden', !player.isAdmin);
            $('startBtn').classList.toggle('hidden', !player.isAdmin);
            $('waitingHint').classList.toggle('hidden', player.isAdmin);
            
            const grid = $('colorGrid');
            grid.innerHTML = '';
            
            COLORS.forEach(c => {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex flex-col items-center gap-2';
                
                const btn = document.createElement('div');
                btn.className = `color-btn ${c.hex === player.color ? 'selected' : ''}`;
                btn.style.background = c.hex;
                btn.onclick = () => selectColor(c.hex, c.name);
                
                const label = document.createElement('span');
                label.className = 'text-xs font-bold text-gray-600';
                label.textContent = c.name;
                
                wrapper.appendChild(btn);
                wrapper.appendChild(label);
                grid.appendChild(wrapper);
            });
        }

        function updateAvatars() {
            $('avatarDisplay').style.background = player.color;
            $('gameAvatar').style.background = player.color;
            $('gameName').textContent = player.name;
            $('resultAvatar').style.background = player.color;
        }

        function selectColor(hex, name) {
            player.color = hex;
            player.name = name;
            updateAvatars();
            
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.style.background === hex);
            });
            
            // Trigger jump + blink animation
            const avatar = $('avatarDisplay');
            avatar.classList.remove('jump', 'blink');
            void avatar.offsetWidth; // Force reflow
            avatar.classList.add('jump', 'blink');
            setTimeout(() => avatar.classList.remove('blink'), 600);
            setTimeout(() => avatar.classList.remove('jump'), 500);
            
            send({ action: 'selectColor', color: hex, colorName: name });
            if (navigator.vibrate) navigator.vibrate(25);
        }

        function setupControls() {
            const btns = [
                [$('leftBtn'), 'left'],
                [$('rightBtn'), 'right'],
                [$('jumpBtn'), 'jump']
            ];
            
            btns.forEach(([el, action]) => {
                ['touchstart', 'touchend', 'touchcancel'].forEach(evt => {
                    el.addEventListener(evt, (e) => {
                        e.preventDefault();
                        handleInput(action, evt === 'touchstart', el);
                    }, { passive: false });
                });
                
                el.addEventListener('mousedown', () => handleInput(action, true, el));
                el.addEventListener('mouseup', () => handleInput(action, false, el));
                el.addEventListener('mouseleave', () => handleInput(action, false, el));
            });
        }

        function handleInput(action, pressed, el) {
            el.classList.toggle('pressed', pressed);
            if (pressed && navigator.vibrate) navigator.vibrate(15);
            
            if (action === 'jump') {
                if (pressed && !keys.jump) {
                    keys.jump = true;
                    send({ action: 'jump', pressed: true });
                } else if (!pressed && keys.jump) {
                    keys.jump = false;
                    send({ action: 'jump', pressed: false });
                }
            } else {
                if (pressed) {
                    keys[action] = true;
                    keys[action === 'left' ? 'right' : 'left'] = false;
                    send({ action: 'move', direction: action });
                } else if (keys[action]) {
                    keys[action] = false;
                    const other = action === 'left' ? 'right' : 'left';
                    send(keys[other] ? { action: 'move', direction: other } : { action: 'stop' });
                }
            }
        }

        function lockLandscape() {
            // Rotation warning disabled temporarily
        }

        function checkOrientation() {
            // Rotation warning disabled temporarily
        }

        function unlock() {
            // Rotation warning disabled temporarily
        }

        function showResults(results, winner) {
            unlock();
            showScreen('results');
            
            const me = results.find(r => r.num == player.num);
            const rank = me ? results.indexOf(me) + 1 : results.length;
            
            const medals = ['1ro', '2do', '3ro'];
            const colors = ['#EB8225', '#0595AE', '#AB3D8B'];
            
            $('rankDisplay').textContent = medals[rank - 1] || `#${rank}`;
            $('rankDisplay').style.color = colors[rank - 1] || '#73A03F';
            
            if (winner?.num == player.num) {
                $('resultMsg').textContent = 'GANASTE!';
                $('resultMsg').style.color = '#EB8225';
                if (navigator.vibrate) navigator.vibrate([80, 40, 80, 40, 80]);
            } else {
                $('resultMsg').textContent = winner ? `Gano ${winner.name}` : 'Buen juego!';
                $('resultMsg').style.color = '#0595AE';
            }
            
            $('resultScore').textContent = `${me?.score || 0} pts`;
            $('againBtn').classList.toggle('hidden', !player.isAdmin);
            $('waitingResult').classList.toggle('hidden', player.isAdmin);
        }

        function showScreen(name) {
            ['join', 'select', 'game', 'results'].forEach(s => {
                const el = $(s + 'Screen');
                el.classList.toggle('hidden', s !== name);
                el.classList.toggle('flex', s === name);
            });
            
            if (name !== 'game') {
                keys = { left: false, right: false, jump: false };
            }
        }

        document.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
        document.addEventListener('gesturestart', e => e.preventDefault());
        
        window.onload = init;
    </script>
</body>
</html>
