<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Platformer - Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F',
                            negro: '#010101',
                            blanco: '#FFFFFF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            touch-action: none;
        }

        /* Player avatar visual representation */
        .player-avatar-visual {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.25);
            transition: all 0.2s ease;
        }

        .player-avatar-visual::before {
            content: '';
            position: absolute;
            top: 4px;
            left: 4px;
            right: 4px;
            height: 12px;
            background: rgba(255,255,255,0.35);
            border-radius: 8px 8px 0 0;
        }

        .player-avatar-visual-large {
            width: 80px;
            height: 80px;
            border-radius: 16px;
        }

        .player-avatar-visual-large::before {
            height: 16px;
            top: 5px;
            left: 5px;
            right: 5px;
            border-radius: 10px 10px 0 0;
        }

        .player-avatar-visual-small {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .player-avatar-visual-small::before {
            height: 8px;
            top: 3px;
            left: 3px;
            right: 3px;
            border-radius: 5px 5px 0 0;
        }

        /* Color selector styling */
        .color-btn {
            transition: all 0.15s ease;
        }

        .color-btn.selected {
            transform: scale(1.15);
            box-shadow: 0 0 0 4px #EB8225, 0 4px 15px rgba(0,0,0,0.3);
        }

        /* Button 3D effect */
        .btn-3d {
            transition: all 0.08s ease;
        }

        .btn-3d:active, .btn-3d.pressed {
            transform: translateY(4px);
        }

        .btn-verde {
            box-shadow: 0 6px 0 #5a8030;
        }
        .btn-verde:active, .btn-verde.pressed {
            box-shadow: 0 2px 0 #5a8030;
        }

        .btn-turquesa {
            box-shadow: 0 6px 0 #047a91;
        }
        .btn-turquesa:active, .btn-turquesa.pressed {
            box-shadow: 0 2px 0 #047a91;
        }

        .btn-morado {
            box-shadow: 0 6px 0 #8a3070;
        }
        .btn-morado:active, .btn-morado.pressed {
            box-shadow: 0 2px 0 #8a3070;
        }

        .jump-button {
            box-shadow: 0 8px 0 #5a8030;
        }
        .jump-button:active, .jump-button.pressed {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #5a8030;
        }

        .left-button {
            box-shadow: 0 6px 0 #8a3070;
        }
        .left-button:active, .left-button.pressed {
            box-shadow: 0 2px 0 #8a3070;
        }

        .right-button {
            box-shadow: 0 6px 0 #047a91;
        }
        .right-button:active, .right-button.pressed {
            box-shadow: 0 2px 0 #047a91;
        }

        /* Shine effect on buttons */
        .btn-shine::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 100%);
            border-radius: inherit;
            pointer-events: none;
        }

        @keyframes rotate {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
        }

        .rotate-anim {
            animation: rotate 2s ease-in-out infinite;
        }

        @media (orientation: landscape) and (max-height: 450px) {
            .control-layout {
                flex-direction: row !important;
                justify-content: space-around !important;
            }

            .jump-button {
                width: 120px !important;
                height: 120px !important;
            }

            .control-button {
                width: 80px !important;
                height: 80px !important;
            }

            .movement-container {
                gap: 25px !important;
            }

            .game-header {
                display: none !important;
            }
        }
    </style>
</head>
<body class="w-screen h-screen overflow-hidden font-sans bg-white flex flex-col items-center justify-center text-steam-negro">
    <!-- JOIN SCREEN -->
    <div class="screen flex flex-col items-center justify-center w-full h-full p-5 text-center gap-5" id="joinScreen">
        <div class="flex justify-center mb-2">
            <div class="player-avatar-visual-large bg-steam-verde"></div>
        </div>
        <h1 class="text-2xl font-bold text-steam-turquesa">STEAM Platformer</h1>
        <p class="text-base text-steam-negro opacity-70">Fundacion STEAM RD</p>
        <button class="bg-steam-verde text-white border-none py-4 px-10 text-xl font-bold rounded-full cursor-pointer uppercase btn-3d btn-verde" id="joinButton">Unirse!</button>
    </div>

    <!-- AVATAR SELECT SCREEN -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-5 gap-4 overflow-y-auto" id="avatarSelectScreen">
        <div class="bg-steam-naranja text-white py-2 px-4 rounded-full font-bold text-sm hidden" id="adminBadge">ADMIN</div>
        
        <h2 class="text-xl font-bold text-steam-turquesa text-center">Tu Personaje</h2>
        
        <!-- Current avatar display -->
        <div class="flex justify-center">
            <div class="player-avatar-visual-large" id="currentAvatarDisplay" style="background-color: #73A03F;"></div>
        </div>
        
        <!-- Color selection -->
        <div class="mt-4">
            <h3 class="text-lg font-bold text-steam-turquesa mb-3 text-center">Elige tu Color</h3>
            <div class="grid grid-cols-4 gap-3 max-w-xs mx-auto" id="colorGrid"></div>
        </div>
        
        <p class="text-steam-verde font-bold text-base mt-2">Listo para jugar</p>
        
        <!-- Admin start section -->
        <div class="mt-4 hidden" id="adminStartSection">
            <button class="bg-steam-turquesa text-white border-none py-4 px-8 text-lg font-bold rounded-full cursor-pointer uppercase btn-3d btn-turquesa" id="startGameBtn">INICIAR JUEGO!</button>
        </div>
        
        <!-- Waiting hint for non-admins -->
        <div class="bg-gray-100 rounded-2xl py-4 px-5 text-center border-2 border-gray-200 mt-2" id="waitingHint">
            <p class="text-sm text-gray-600">Esperando que el Jugador 1 inicie el juego...</p>
        </div>
    </div>

    <!-- GAME CONTROLLER -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-4 bg-gradient-to-b from-[#1B4D3E] to-[#0D2818] gap-4" id="gameController">
        <!-- Orientation warning -->
        <div class="fixed top-0 left-0 w-full h-full bg-black/90 hidden flex-col items-center justify-center z-50 text-white text-center p-5" id="orientationWarning">
            <div class="text-6xl mb-5 rotate-anim">ðŸ“±</div>
            <div class="text-2xl font-bold mb-3">Rota tu dispositivo!</div>
            <div class="text-lg opacity-80">Coloca el telefono en posicion horizontal para jugar</div>
        </div>
        
        <!-- Game header -->
        <div class="flex items-center justify-center gap-3 mb-2 game-header">
            <div class="player-avatar-visual-small" id="gameAvatarBadge" style="background-color: #73A03F;"></div>
            <span class="text-xl font-bold text-white" id="gamePlayerName">Verde</span>
        </div>
        
        <!-- Controls -->
        <div class="flex flex-col items-center gap-5 w-full max-w-md control-layout">
            <div class="w-full flex justify-center">
                <div class="jump-button w-40 h-40 rounded-full border-none bg-steam-verde flex flex-col items-center justify-center cursor-pointer relative btn-shine" id="jumpBtn">
                    <span class="text-4xl mb-1">â†‘</span>
                    <span class="text-lg text-white font-bold">SALTAR</span>
                </div>
            </div>
            
            <div class="flex gap-12 items-center justify-center w-full movement-container">
                <div class="control-button left-button w-24 h-24 rounded-2xl border-none bg-steam-morado flex flex-col items-center justify-center cursor-pointer relative btn-shine" id="leftBtn">
                    <span class="text-3xl text-white">â—€</span>
                    <span class="text-sm text-white font-bold mt-1">IZQ</span>
                </div>
                <div class="control-button right-button w-24 h-24 rounded-2xl border-none bg-steam-turquesa flex flex-col items-center justify-center cursor-pointer relative btn-shine" id="rightBtn">
                    <span class="text-3xl text-white">â–¶</span>
                    <span class="text-sm text-white font-bold mt-1">DER</span>
                </div>
            </div>
        </div>
    </div>

    <!-- RESULTS SCREEN -->
    <div class="screen hidden flex-col items-center justify-center w-full h-full p-5 text-center gap-5" id="resultsScreen">
        <h2 class="text-2xl font-bold text-steam-turquesa">Carrera Terminada!</h2>
        <div class="text-5xl" id="finalRank">1ro</div>
        <div class="flex justify-center">
            <div class="player-avatar-visual-large" id="resultAvatarDisplay" style="background-color: #73A03F;"></div>
        </div>
        <p class="text-xl font-bold text-steam-turquesa" id="finalMessage">Felicidades!</p>
        <div class="text-2xl font-bold text-steam-verde" id="finalScore">0 puntos</div>
        <button class="bg-steam-morado text-white border-none py-4 px-8 text-lg font-bold rounded-full cursor-pointer uppercase btn-3d btn-morado hidden" id="playAgainBtn">JUGAR DE NUEVO</button>
        <p class="text-sm text-gray-600" id="waitingNext">Esperando al Jugador 1...</p>
    </div>

    <script>
        const airconsole = new AirConsole();
        
        let playerInfo = {
            playerNum: null,
            color: '#73A03F',
            colorName: 'Verde',
            isAdmin: false
        };
        
        const availableColors = [
            { color: '#73A03F', name: 'Verde' },
            { color: '#AB3D8B', name: 'Morado' },
            { color: '#0595AE', name: 'Turquesa' },
            { color: '#EB8225', name: 'Naranja' }
        ];
        
        let isLeftPressed = false;
        let isRightPressed = false;
        let isJumpPressed = false;
        
        let lastMoveTime = 0;
        const MOVE_THROTTLE = 16;
        
        function sendMessage(msg) {
            airconsole.message(AirConsole.SCREEN, msg);
        }
        
        function sendThrottledMove(direction) {
            const now = performance.now();
            if (now - lastMoveTime >= MOVE_THROTTLE) {
                lastMoveTime = now;
                sendMessage({ action: 'move', direction: direction });
            }
        }

        function init() {
            airconsole.onReady = function() {
                console.log('Controller ready');
            };

            airconsole.onMessage = function(from, data) {
                console.log("Received:", data);
                
                if (data.action === 'joined') {
                    handleJoined(data);
                } else if (data.type === 'gameState') {
                    // Update state
                } else if (data.type === 'gameStart') {
                    showScreen('gameController');
                    setupControls();
                    requestOrientationLock();
                } else if (data.type === 'gameRestart') {
                    unlockOrientation();
                    showScreen('avatarSelect');
                } else if (data.type === 'gameResults') {
                    showResults(data.results, data.winner);
                } else if (data.action === 'colorUpdated') {
                    playerInfo.color = data.color;
                    playerInfo.colorName = data.colorName;
                    updateColorDisplays();
                }
            };

            document.getElementById('joinButton').addEventListener('click', joinGame);
            document.getElementById('startGameBtn').addEventListener('click', startGame);
            document.getElementById('playAgainBtn').addEventListener('click', playAgain);
        }

        function joinGame() {
            airconsole.message(AirConsole.SCREEN, { 
                action: 'join'
            });
            
            document.getElementById('joinButton').disabled = true;
            document.getElementById('joinButton').textContent = 'Conectando...';
        }

        function handleJoined(data) {
            playerInfo.playerNum = data.playerNum;
            playerInfo.color = data.color;
            playerInfo.colorName = data.colorName;
            playerInfo.isAdmin = data.isAdmin;
            
            setupAvatarScreen();
            showScreen('avatarSelect');
        }

        function setupAvatarScreen() {
            updateColorDisplays();
            
            document.getElementById('adminBadge').classList.toggle('hidden', !playerInfo.isAdmin);
            document.getElementById('adminStartSection').classList.toggle('hidden', !playerInfo.isAdmin);
            document.getElementById('waitingHint').classList.toggle('hidden', playerInfo.isAdmin);
            
            const colorGrid = document.getElementById('colorGrid');
            colorGrid.innerHTML = '';
            
            availableColors.forEach((colorData) => {
                const btn = document.createElement('div');
                btn.className = `color-btn w-14 h-14 rounded-full border-4 border-white cursor-pointer shadow-lg ${colorData.color === playerInfo.color ? 'selected' : ''}`;
                btn.style.backgroundColor = colorData.color;
                btn.dataset.color = colorData.color;
                btn.dataset.colorName = colorData.name;
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'absolute -bottom-6 left-1/2 -translate-x-1/2 text-xs text-steam-negro whitespace-nowrap font-bold';
                nameSpan.textContent = colorData.name;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'relative pb-6';
                wrapper.appendChild(btn);
                wrapper.appendChild(nameSpan);
                
                btn.addEventListener('click', () => selectColor(colorData.color, colorData.name));
                colorGrid.appendChild(wrapper);
            });
        }

        function updateColorDisplays() {
            document.getElementById('currentAvatarDisplay').style.backgroundColor = playerInfo.color;
            document.getElementById('gameAvatarBadge').style.backgroundColor = playerInfo.color;
            document.getElementById('gamePlayerName').textContent = playerInfo.colorName;
            document.getElementById('resultAvatarDisplay').style.backgroundColor = playerInfo.color;
        }

        function selectColor(color, colorName) {
            playerInfo.color = color;
            playerInfo.colorName = colorName;
            
            updateColorDisplays();
            
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.color === color);
            });
            
            airconsole.message(AirConsole.SCREEN, {
                action: 'selectColor',
                color: color,
                colorName: colorName
            });
            
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function startGame() {
            airconsole.message(AirConsole.SCREEN, { action: 'startGame' });
        }

        function setupControls() {
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const jumpBtn = document.getElementById('jumpBtn');

            setupTouchControl(leftBtn, 'left');
            setupTouchControl(rightBtn, 'right');
            setupTouchControl(jumpBtn, 'jump');

            setupMouseControl(leftBtn, 'left');
            setupMouseControl(rightBtn, 'right');
            setupMouseControl(jumpBtn, 'jump');
        }

        function requestOrientationLock() {
            if (screen.orientation && screen.orientation.lock) {
                screen.orientation.lock('landscape').catch(err => {
                    console.log('No se pudo bloquear la orientacion:', err);
                    checkOrientation();
                });
            } else if (screen.lockOrientation) {
                try {
                    screen.lockOrientation('landscape');
                } catch (err) {
                    console.log('No se pudo bloquear la orientacion:', err);
                    checkOrientation();
                }
            } else if (screen.mozLockOrientation) {
                try {
                    screen.mozLockOrientation('landscape');
                } catch (err) {
                    console.log('No se pudo bloquear la orientacion:', err);
                    checkOrientation();
                }
            } else if (screen.msLockOrientation) {
                try {
                    screen.msLockOrientation('landscape');
                } catch (err) {
                    console.log('No se pudo bloquear la orientacion:', err);
                    checkOrientation();
                }
            } else {
                checkOrientation();
            }

            const orientationCheck = setInterval(() => {
                if (!document.getElementById('gameController').classList.contains('hidden')) {
                    checkOrientation();
                } else {
                    clearInterval(orientationCheck);
                    unlockOrientation();
                }
            }, 500);

            window.addEventListener('orientationchange', checkOrientation);
            window.addEventListener('resize', checkOrientation);
        }

        function checkOrientation() {
            const warning = document.getElementById('orientationWarning');
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isPortrait && !document.getElementById('gameController').classList.contains('hidden')) {
                warning.classList.remove('hidden');
                warning.classList.add('flex');
            } else {
                warning.classList.add('hidden');
                warning.classList.remove('flex');
            }
        }

        function unlockOrientation() {
            if (screen.orientation && screen.orientation.unlock) {
                screen.orientation.unlock();
            } else if (screen.unlockOrientation) {
                screen.unlockOrientation();
            } else if (screen.mozUnlockOrientation) {
                screen.mozUnlockOrientation();
            } else if (screen.msUnlockOrientation) {
                screen.msUnlockOrientation();
            }
        }

        function setupTouchControl(element, action) {
            element.addEventListener('touchstart', (e) => {
                e.preventDefault();
                handleActionStart(action, element);
            }, { passive: false });

            element.addEventListener('touchend', (e) => {
                e.preventDefault();
                handleActionEnd(action, element);
            }, { passive: false });

            element.addEventListener('touchcancel', (e) => {
                e.preventDefault();
                handleActionEnd(action, element);
            }, { passive: false });
        }

        function setupMouseControl(element, action) {
            element.addEventListener('mousedown', () => handleActionStart(action, element));
            element.addEventListener('mouseup', () => handleActionEnd(action, element));
            element.addEventListener('mouseleave', () => handleActionEnd(action, element));
        }

        function handleActionStart(action, element) {
            element.classList.add('pressed');
            if (navigator.vibrate) navigator.vibrate(15);
            
            switch(action) {
                case 'left':
                    if (!isLeftPressed) {
                        isLeftPressed = true;
                        isRightPressed = false;
                        sendMessage({ action: 'move', direction: 'left' });
                    }
                    break;
                case 'right':
                    if (!isRightPressed) {
                        isRightPressed = true;
                        isLeftPressed = false;
                        sendMessage({ action: 'move', direction: 'right' });
                    }
                    break;
                case 'jump':
                    if (!isJumpPressed) {
                        isJumpPressed = true;
                        sendMessage({ action: 'jump', pressed: true });
                    }
                    break;
            }
        }

        function handleActionEnd(action, element) {
            element.classList.remove('pressed');
            
            switch(action) {
                case 'left':
                    if (isLeftPressed) {
                        isLeftPressed = false;
                        if (isRightPressed) {
                            sendMessage({ action: 'move', direction: 'right' });
                        } else {
                            sendMessage({ action: 'stop' });
                        }
                    }
                    break;
                case 'right':
                    if (isRightPressed) {
                        isRightPressed = false;
                        if (isLeftPressed) {
                            sendMessage({ action: 'move', direction: 'left' });
                        } else {
                            sendMessage({ action: 'stop' });
                        }
                    }
                    break;
                case 'jump':
                    if (isJumpPressed) {
                        isJumpPressed = false;
                        sendMessage({ action: 'jump', pressed: false });
                    }
                    break;
            }
        }

        function showResults(results, winner) {
            unlockOrientation();
            showScreen('results');
            
            const myResult = results.find(r => r.playerNum == playerInfo.playerNum);
            const myRank = myResult ? results.indexOf(myResult) + 1 : results.length;
            
            const medals = ['1ro', '2do', '3ro'];
            document.getElementById('finalRank').textContent = medals[myRank - 1] || `#${myRank}`;
            
            if (winner && winner.playerNum == playerInfo.playerNum) {
                document.getElementById('finalMessage').textContent = 'GANASTE!';
                if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 100]);
            } else if (winner) {
                document.getElementById('finalMessage').textContent = `Gano ${winner.name}`;
            }
            
            document.getElementById('finalScore').textContent = `${myResult?.score || 0} puntos`;
            
            document.getElementById('playAgainBtn').classList.toggle('hidden', !playerInfo.isAdmin);
            document.getElementById('waitingNext').classList.toggle('hidden', playerInfo.isAdmin);
        }

        function playAgain() {
            airconsole.message(AirConsole.SCREEN, { action: 'playAgain' });
        }

        function showScreen(screen) {
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.add('hidden');
                s.classList.remove('flex');
            });
            const targetScreen = document.getElementById(screen + 'Screen');
            targetScreen.classList.remove('hidden');
            targetScreen.classList.add('flex');
            
            if (screen !== 'gameController') {
                isLeftPressed = false;
                isRightPressed = false;
                isJumpPressed = false;
            }
        }

        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        document.addEventListener('gesturestart', (e) => e.preventDefault());

        window.onload = init;
    </script>
</body>
</html>
