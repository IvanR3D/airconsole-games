<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STEAM Platformer - Fundacion STEAM RD</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script type="text/javascript" src="https://www.airconsole.com/api/airconsole-1.8.0.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        steam: {
                            turquesa: '#0595AE',
                            morado: '#AB3D8B',
                            naranja: '#EB8225',
                            verde: '#73A03F',
                            negro: '#010101',
                            blanco: '#FFFFFF'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { position: fixed; top: 0; left: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: #f8f9fa; }

        /* Clean title with colored letters */
        .title-steam { color: #0595AE; }
        .title-platformer { color: #73A03F; }

        /* Player avatar - clean flat design */
        .player-avatar {
            width: clamp(50px, 8vw, 80px);
            height: clamp(50px, 8vw, 80px);
            border-radius: 16px;
            position: relative;
            box-shadow: 0 6px 0 rgba(0,0,0,0.15), 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Eyes for avatar - simple centered with idle blink */
        .player-avatar::before,
        .player-avatar::after {
            content: '';
            position: absolute;
            width: 24%;
            height: 24%;
            top: 32%;
            background: radial-gradient(circle at 50% 50%, #222 35%, transparent 36%),
                        white;
            border-radius: 50%;
            animation: idleBlink 4s ease-in-out infinite;
        }
        .player-avatar::before { left: 18%; }
        .player-avatar::after { right: 18%; animation-delay: 0.05s; }

        /* Idle blink - natural blinking */
        @keyframes idleBlink {
            0%, 42%, 48%, 100% { transform: scaleY(1); }
            45% { transform: scaleY(0.05); }
        }

        /* Happy blink when player connects */
        .player-card.ready .player-avatar::before,
        .player-card.ready .player-avatar::after,
        .player-card.admin .player-avatar::before,
        .player-card.admin .player-avatar::after {
            animation: blinkHappy 0.6s ease-out, idleBlink 4s ease-in-out 0.6s infinite;
        }
        @keyframes blinkHappy {
            0% { transform: scaleY(1); }
            20% { transform: scaleY(0.05); }
            40% { transform: scaleY(1); }
            60% { transform: scaleY(0.05); }
            80% { transform: scaleY(1); }
            100% { transform: scaleY(1); }
        }

        /* Jump when connected */
        .player-card.ready .player-avatar,
        .player-card.admin .player-avatar {
            animation: happyJump 0.5s ease-out;
        }
        @keyframes happyJump {
            0% { transform: scale(1); }
            40% { transform: scale(1.15) translateY(-12px); }
            70% { transform: scale(0.95) translateY(0); }
            100% { transform: scale(1) translateY(0); }
        }

        .player-avatar-small {
            width: clamp(35px, 5vw, 50px);
            height: clamp(35px, 5vw, 50px);
            border-radius: 10px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.15);
        }

        /* Float animation */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
        }
        .float { animation: float 3s ease-in-out infinite; }

        /* Player card */
        .player-card {
            background: white;
            border-radius: 20px;
            padding: clamp(16px, 3vw, 28px);
            border: 4px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .player-card.ready {
            border-color: #73A03F;
            background: #f0fdf4;
        }

        .player-card.admin {
            border-color: #EB8225;
            background: #fff7ed;
        }

        /* Countdown */
        .countdown-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .countdown-number {
            font-size: clamp(120px, 30vw, 250px);
            font-weight: 900;
            color: white;
            text-shadow: 0 0 60px currentColor;
            animation: countPop 0.6s ease-out;
        }

        @keyframes countPop {
            0% { transform: scale(2.5); opacity: 0; }
            60% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Confetti */
        @keyframes fall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        .confetti {
            position: absolute;
            animation: fall 3s ease-out forwards;
        }

        /* Pulse */
        @keyframes pulse {
            50% { opacity: 0.6; }
        }
        .pulse { animation: pulse 2s ease infinite; }

        /* Winner animation */
        @keyframes winner {
            0% { transform: scale(0) rotate(-10deg); }
            70% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .winner-anim { animation: winner 0.6s ease-out; }
    </style>
</head>
<body>
    <!-- START SCREEN -->
    <div id="startScreen" class="w-screen h-screen flex flex-col items-center justify-center p-6 text-center bg-gray-50">
        <div class="mb-6">
            <h1 class="text-4xl sm:text-5xl lg:text-6xl font-black mb-2 flex items-center justify-center gap-3">
                <iconify-icon icon="mdi:gamepad-variant" class="text-steam-turquesa"></iconify-icon>
                <span class="title-steam">STEAM</span> <span class="title-platformer">PLATFORMER</span>
            </h1>
            <p class="text-gray-500 text-lg flex items-center justify-center gap-3">
                <iconify-icon icon="mdi:run-fast"></iconify-icon>
                Corre
                <iconify-icon icon="mdi:arrow-up-bold-box"></iconify-icon>
                Salta
                <iconify-icon icon="mdi:cash-multiple"></iconify-icon>
                Colecta
            </p>
        </div>
        
        <div class="grid grid-cols-2 gap-4 sm:gap-6 mb-8 w-full max-w-xl lg:max-w-3xl">
            <div class="player-card" id="playerSlot1">
                <div class="text-lg sm:text-xl font-bold text-steam-turquesa mb-3 flex items-center justify-center gap-2">
                    <iconify-icon icon="mdi:controller" class="text-xl"></iconify-icon>
                    Jugador 1
                </div>
                <div class="flex justify-center mb-3 float">
                    <div class="player-avatar bg-gray-300"></div>
                </div>
                <div class="text-sm text-gray-400 flex items-center justify-center gap-1">
                    <iconify-icon icon="mdi:timer-sand" class="animate-pulse"></iconify-icon>
                    Esperando...
                </div>
            </div>
            <div class="player-card" id="playerSlot2">
                <div class="text-lg sm:text-xl font-bold text-steam-turquesa mb-3 flex items-center justify-center gap-2">
                    <iconify-icon icon="mdi:controller" class="text-xl"></iconify-icon>
                    Jugador 2
                </div>
                <div class="flex justify-center mb-3 float">
                    <div class="player-avatar bg-gray-300"></div>
                </div>
                <div class="text-sm text-gray-400 flex items-center justify-center gap-1">
                    <iconify-icon icon="mdi:timer-sand" class="animate-pulse"></iconify-icon>
                    Esperando...
                </div>
            </div>
            <div class="player-card" id="playerSlot3">
                <div class="text-lg sm:text-xl font-bold text-steam-turquesa mb-3 flex items-center justify-center gap-2">
                    <iconify-icon icon="mdi:controller" class="text-xl"></iconify-icon>
                    Jugador 3
                </div>
                <div class="flex justify-center mb-3 float">
                    <div class="player-avatar bg-gray-300"></div>
                </div>
                <div class="text-sm text-gray-400 flex items-center justify-center gap-1">
                    <iconify-icon icon="mdi:timer-sand" class="animate-pulse"></iconify-icon>
                    Esperando...
                </div>
            </div>
            <div class="player-card" id="playerSlot4">
                <div class="text-lg sm:text-xl font-bold text-steam-turquesa mb-3 flex items-center justify-center gap-2">
                    <iconify-icon icon="mdi:controller" class="text-xl"></iconify-icon>
                    Jugador 4
                </div>
                <div class="flex justify-center mb-3 float">
                    <div class="player-avatar bg-gray-300"></div>
                </div>
                <div class="text-sm text-gray-400 flex items-center justify-center gap-1">
                    <iconify-icon icon="mdi:timer-sand" class="animate-pulse"></iconify-icon>
                    Esperando...
                </div>
            </div>
        </div>
        
        <div class="bg-steam-naranja/10 border-2 border-steam-naranja rounded-2xl py-4 px-8 hidden flex items-center gap-3" id="adminHint">
            <iconify-icon icon="mdi:cellphone" class="text-steam-naranja text-2xl"></iconify-icon>
            <p class="text-steam-naranja font-bold">El Jugador 1 inicia desde su telefono</p>
        </div>
    </div>

    <!-- GAME CONTAINER -->
    <div id="gameContainer" class="hidden w-screen h-screen fixed inset-0 overflow-hidden"></div>

    <!-- COUNTDOWN -->
    <div id="countdownOverlay" class="countdown-overlay hidden">
        <div class="countdown-number" id="countdownNumber">3</div>
    </div>

    <!-- RESULTS SCREEN -->
    <div id="resultsScreen" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4 bg-gray-50">
        <div class="bg-white rounded-3xl p-6 sm:p-10 text-center w-full max-w-2xl shadow-2xl max-h-[95vh] overflow-y-auto">
            <h2 class="text-3xl sm:text-4xl font-black text-steam-turquesa mb-6 flex items-center justify-center gap-3">
                <iconify-icon icon="mdi:flag-checkered"></iconify-icon>
                Fin de Carrera!
            </h2>
            <div class="winner-anim mb-8" id="winnerSection"></div>
            <table class="w-full mb-8 text-left">
                <thead>
                    <tr class="border-b-4 border-gray-100">
                        <th class="py-3 px-2 text-steam-turquesa font-bold">#</th>
                        <th class="py-3 px-2 text-steam-turquesa font-bold">
                            <span class="flex items-center gap-1">
                                <iconify-icon icon="mdi:account"></iconify-icon>
                                Jugador
                            </span>
                        </th>
                        <th class="py-3 px-2 text-steam-turquesa font-bold text-center">
                            <span class="flex items-center justify-center gap-1">
                                <iconify-icon icon="mdi:cash"></iconify-icon>
                                Monedas
                            </span>
                        </th>
                        <th class="py-3 px-2 text-steam-turquesa font-bold text-center">
                            <span class="flex items-center justify-center gap-1">
                                <iconify-icon icon="mdi:timer"></iconify-icon>
                                Tiempo
                            </span>
                        </th>
                        <th class="py-3 px-2 text-steam-turquesa font-bold text-right">
                            <span class="flex items-center justify-end gap-1">
                                <iconify-icon icon="mdi:star"></iconify-icon>
                                Puntos
                            </span>
                        </th>
                    </tr>
                </thead>
                <tbody id="resultsBody"></tbody>
            </table>
            <div class="bg-steam-naranja/10 border-2 border-steam-naranja rounded-xl py-4 px-6 pulse flex items-center justify-center gap-2">
                <iconify-icon icon="mdi:cellphone" class="text-steam-naranja text-xl"></iconify-icon>
                <p class="text-steam-naranja font-bold">Esperando al Jugador 1...</p>
            </div>
        </div>
    </div>

    <!-- CONFETTI -->
    <div class="fixed inset-0 pointer-events-none z-[1000] overflow-hidden" id="confettiContainer"></div>

    <script>
        const airconsole = new AirConsole();
        
        // Level design - more interesting and varied
        const LEVEL = {
            length: 3000,
            floorSegments: [
                { x: 0, width: 400 },
                { x: 600, width: 300 },
                { x: 1100, width: 450 },
                { x: 1750, width: 350 },
                { x: 2300, width: 700 },
            ],
            platforms: [
                { x: 300, y: 550, width: 150 },
                { x: 520, y: 480, width: 120 },
                { x: 800, y: 530, width: 180 },
                { x: 1050, y: 460, width: 140 },
                { x: 1350, y: 510, width: 160 },
                { x: 1600, y: 440, width: 130 },
                { x: 1900, y: 490, width: 200 },
                { x: 2150, y: 530, width: 150 },
                { x: 2500, y: 470, width: 180 },
            ],
            coins: [
                { x: 375, y: 510 }, { x: 580, y: 440 }, { x: 890, y: 490 },
                { x: 1120, y: 420 }, { x: 1430, y: 470 }, { x: 1665, y: 400 },
                { x: 2000, y: 450 }, { x: 2225, y: 490 }, { x: 2590, y: 430 },
                { x: 2800, y: 550 },
            ],
            obstacles: [
                { x: 450, y: 320, startX: 450 },
                { x: 950, y: 300, startX: 950 },
                { x: 1500, y: 280, startX: 1500 },
                { x: 2050, y: 310, startX: 2050 },
            ],
        };

        const COLORS = ['#73A03F', '#AB3D8B', '#0595AE', '#EB8225'];
        const NAMES = ['Verde', 'Morado', 'Turquesa', 'Naranja'];

        const state = {
            players: {},
            games: {},
            started: false,
            startTime: null,
            admin: null
        };

        let audioCtx;
        const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
        
        function sound(type) {
            initAudio();
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.connect(g);
            g.connect(audioCtx.destination);
            
            const t = audioCtx.currentTime;
            switch(type) {
                case 'jump':
                    o.frequency.setValueAtTime(400, t);
                    o.frequency.exponentialRampToValueAtTime(800, t + 0.1);
                    g.gain.setValueAtTime(0.1, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.1);
                    o.start(t); o.stop(t + 0.1);
                    break;
                case 'coin':
                    [1000, 1250, 1500].forEach((f, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain); gain.connect(audioCtx.destination);
                        osc.frequency.value = f;
                        gain.gain.setValueAtTime(0.08, t + i * 0.05);
                        gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.05 + 0.1);
                        osc.start(t + i * 0.05); osc.stop(t + i * 0.05 + 0.1);
                    });
                    break;
                case 'hit':
                    o.type = 'sawtooth';
                    o.frequency.setValueAtTime(200, t);
                    o.frequency.exponentialRampToValueAtTime(80, t + 0.15);
                    g.gain.setValueAtTime(0.12, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.15);
                    o.start(t); o.stop(t + 0.15);
                    break;
                case 'win':
                    [523, 659, 784, 1047].forEach((f, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain); gain.connect(audioCtx.destination);
                        osc.frequency.value = f;
                        gain.gain.setValueAtTime(0.1, t + i * 0.12);
                        gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.12 + 0.25);
                        osc.start(t + i * 0.12); osc.stop(t + i * 0.12 + 0.25);
                    });
                    break;
                case 'count':
                    o.frequency.value = 500;
                    g.gain.setValueAtTime(0.1, t);
                    g.gain.exponentialRampToValueAtTime(0.001, t + 0.12);
                    o.start(t); o.stop(t + 0.12);
                    break;
                case 'go':
                    [600, 900, 1200].forEach((f, i) => {
                        const osc = audioCtx.createOscillator();
                        const gain = audioCtx.createGain();
                        osc.connect(gain); gain.connect(audioCtx.destination);
                        osc.frequency.value = f;
                        gain.gain.setValueAtTime(0.12, t + i * 0.04);
                        gain.gain.exponentialRampToValueAtTime(0.001, t + i * 0.04 + 0.15);
                        osc.start(t + i * 0.04); osc.stop(t + i * 0.04 + 0.15);
                    });
                    break;
            }
        }

        function confetti() {
            const c = document.getElementById('confettiContainer');
            c.innerHTML = '';
            const colors = ['#0595AE', '#AB3D8B', '#EB8225', '#73A03F', '#FFD700'];
            for (let i = 0; i < 150; i++) {
                const el = document.createElement('div');
                el.className = 'confetti';
                el.style.cssText = `left:${Math.random()*100}%;top:-20px;width:${8+Math.random()*8}px;height:${8+Math.random()*8}px;background:${colors[Math.floor(Math.random()*colors.length)]};border-radius:${Math.random()>0.5?'50%':'2px'};animation-delay:${Math.random()*2}s;animation-duration:${2+Math.random()*2}s;`;
                c.appendChild(el);
            }
            setTimeout(() => c.innerHTML = '', 5000);
        }

        async function countdown() {
            const overlay = document.getElementById('countdownOverlay');
            const num = document.getElementById('countdownNumber');
            overlay.classList.remove('hidden');
            
            for (const [val, color] of [['3', '#EB8225'], ['2', '#AB3D8B'], ['1', '#0595AE'], ['GO!', '#73A03F']]) {
                num.textContent = val;
                num.style.color = color;
                num.style.animation = 'none';
                num.offsetHeight;
                num.style.animation = 'countPop 0.6s ease-out';
                sound(val === 'GO!' ? 'go' : 'count');
                await new Promise(r => setTimeout(r, 750));
            }
            
            overlay.classList.add('hidden');
        }

        airconsole.onReady = () => console.log("Screen ready");
        airconsole.onConnect = (id) => console.log("Connected:", id);
        
        airconsole.onDisconnect = (id) => {
            for (let n in state.players) {
                if (state.players[n].deviceId === id) {
                    state.players[n].disconnected = true;
                    updateSlots();
                    break;
                }
            }
        };

        airconsole.onMessage = (id, data) => {
            if (data.action === 'join') {
                for (let i = 0; i < 4; i++) {
                    if (!state.players[i+1]) {
                        const isAdmin = !state.admin;
                        if (isAdmin) state.admin = id;
                        
                        state.players[i+1] = {
                            deviceId: id,
                            name: NAMES[i],
                            color: COLORS[i],
                            isAdmin,
                            disconnected: false
                        };
                        
                        airconsole.message(id, {
                            action: 'joined',
                            playerNum: i + 1,
                            color: COLORS[i],
                            colorName: NAMES[i],
                            isAdmin
                        });
                        
                        updateSlots();
                        airconsole.broadcast({ type: 'gameState', players: state.players });
                        break;
                    }
                }
            } else if (data.action === 'selectColor') {
                for (let n in state.players) {
                    if (state.players[n].deviceId === id) {
                        state.players[n].color = data.color;
                        state.players[n].name = data.colorName;
                        updateSlots();
                        airconsole.message(id, { action: 'colorUpdated', color: data.color, colorName: data.colorName });
                        break;
                    }
                }
            } else if (data.action === 'startGame' && id === state.admin) {
                startGame();
            } else if (data.action === 'playAgain' && id === state.admin) {
                restart();
            } else {
                for (let n in state.players) {
                    if (state.players[n].deviceId === id && state.games[n] && state.started) {
                        const g = state.games[n];
                        if (data.action === 'move') {
                            g.keys.left = data.direction === 'left';
                            g.keys.right = data.direction === 'right';
                        } else if (data.action === 'stop') {
                            g.keys.left = g.keys.right = false;
                        } else if (data.action === 'jump') {
                            g.keys.jump = data.pressed;
                        }
                        break;
                    }
                }
            }
        };

        function updateSlots() {
            const count = Object.keys(state.players).length;
            for (let i = 1; i <= 4; i++) {
                const slot = document.getElementById(`playerSlot${i}`);
                const p = state.players[i];
                
                slot.className = 'player-card';
                
                if (p) {
                    slot.classList.add(p.isAdmin ? 'admin' : 'ready');
                    slot.innerHTML = `
                        <div class="text-lg sm:text-xl font-bold flex items-center justify-center gap-2" style="color:${p.color}">
                            ${p.isAdmin ? '<iconify-icon icon="mdi:crown" class="text-steam-naranja text-2xl"></iconify-icon>' : '<iconify-icon icon="mdi:account-check" class="text-xl"></iconify-icon>'}
                            ${p.name}
                        </div>
                        <div class="flex justify-center my-3 float">
                            <div class="player-avatar" style="background:${p.color}"></div>
                        </div>
                        <div class="text-sm font-bold flex items-center justify-center gap-1 ${p.disconnected ? 'text-steam-morado' : 'text-steam-verde'}">
                            ${p.disconnected 
                                ? '<iconify-icon icon="mdi:wifi-off"></iconify-icon> Desconectado' 
                                : '<iconify-icon icon="mdi:check-circle"></iconify-icon> Listo!'}
                        </div>
                    `;
                } else {
                    slot.innerHTML = `
                        <div class="text-lg sm:text-xl font-bold text-gray-400 flex items-center justify-center gap-2">
                            <iconify-icon icon="mdi:controller" class="text-xl"></iconify-icon>
                            Jugador ${i}
                        </div>
                        <div class="flex justify-center my-3 float">
                            <div class="player-avatar bg-gray-200"></div>
                        </div>
                        <div class="text-sm text-gray-400 flex items-center justify-center gap-1">
                            <iconify-icon icon="mdi:timer-sand" class="animate-pulse"></iconify-icon>
                            Esperando...
                        </div>
                    `;
                }
            }
            
            document.getElementById('adminHint').classList.toggle('hidden', count === 0);
        }

        async function startGame() {
            document.getElementById('startScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            
            const players = Object.values(state.players).filter(p => !p.disconnected);
            setupScreens(players.length);
            
            let i = 0;
            for (let n in state.players) {
                if (!state.players[n].disconnected) {
                    state.games[n] = new Game(n, state.players[n].color, state.players[n].name);
                    state.games[n].init();
                    i++;
                }
            }
            
            await countdown();
            
            state.started = true;
            state.startTime = Date.now();
            airconsole.broadcast({ type: 'gameStart' });
        }

        function setupScreens(count) {
            const container = document.getElementById('gameContainer');
            container.innerHTML = '';
            
            let i = 0;
            for (let n in state.players) {
                if (state.players[n].disconnected) continue;
                const p = state.players[n];
                
                const div = document.createElement('div');
                div.id = `screen${n}`;
                div.className = 'absolute overflow-hidden';
                
                // Layout based on player count
                if (count === 1) {
                    div.style.cssText = 'inset:0;';
                } else if (count === 2) {
                    div.style.cssText = `left:0;right:0;height:calc(50% - 2px);${i === 0 ? 'top:0' : 'bottom:0'};`;
                } else if (count === 3) {
                    if (i === 0) div.style.cssText = 'top:0;left:0;right:0;height:calc(50% - 2px);';
                    else div.style.cssText = `bottom:0;width:calc(50% - 2px);height:calc(50% - 2px);${i === 1 ? 'left:0' : 'right:0'};`;
                } else {
                    const pos = [['top:0;left:0'], ['top:0;right:0'], ['bottom:0;left:0'], ['bottom:0;right:0']][i];
                    div.style.cssText = `${pos};width:calc(50% - 2px);height:calc(50% - 2px);`;
                }
                
                div.innerHTML = `
                    <canvas id="canvas${n}" class="absolute inset-0 w-full h-full"></canvas>
                    <div class="absolute top-3 left-3 sm:top-4 sm:left-4 bg-black/70 rounded-xl py-2 px-4 flex items-center gap-2 text-white font-bold text-sm sm:text-lg z-10" style="border-left:4px solid ${p.color}">
                        <iconify-icon icon="mdi:cash-multiple" class="text-steam-naranja text-lg"></iconify-icon>
                        <span id="coins${n}">0</span>/<span>${LEVEL.coins.length}</span>
                    </div>
                    <div class="absolute top-3 right-3 sm:top-4 sm:right-4 bg-black/70 rounded-xl py-2 px-3 flex items-center gap-2 font-bold z-10" style="border-left:4px solid ${p.color}">
                        <div class="w-6 h-6 sm:w-8 sm:h-8 rounded-lg relative" style="background:${p.color}">
                            <span class="absolute top-1 left-1 w-1.5 h-1.5 sm:w-2 sm:h-2 bg-white rounded-full"></span>
                            <span class="absolute top-1 right-1 w-1.5 h-1.5 sm:w-2 sm:h-2 bg-white rounded-full"></span>
                        </div>
                        <span class="text-white text-sm sm:text-base">${p.name}</span>
                    </div>
                    <div class="absolute bottom-3 left-3 right-3 sm:bottom-4 sm:left-4 sm:right-4 h-2 bg-black/30 rounded-full overflow-hidden z-10">
                        <div id="progress${n}" class="h-full rounded-full transition-all" style="width:0%;background:${p.color}"></div>
                    </div>
                `;
                
                if (count > 1) {
                    div.style.border = `3px solid ${p.color}`;
                }
                
                container.appendChild(div);
                i++;
            }
        }

        function restart() {
            document.getElementById('resultsScreen').style.display = 'none';
            document.getElementById('startScreen').style.display = 'flex';
            document.getElementById('gameContainer').style.display = 'none';
            
            state.started = false;
            state.games = {};
            
            for (let n in state.players) {
                if (state.players[n].disconnected) delete state.players[n];
            }
            
            updateSlots();
            airconsole.broadcast({ type: 'gameRestart' });
        }

        function showResults() {
            const results = [];
            
            for (let n in state.games) {
                const g = state.games[n];
                const p = state.players[n];
                if (g.finishTime && !p.disconnected) {
                    const timeBonus = Math.max(0, 1000 - (g.finishTime - state.startTime) / 100);
                    const coinBonus = g.coins * 100;
                    results.push({
                        num: n,
                        name: p.name,
                        color: p.color,
                        coins: g.coins,
                        time: ((g.finishTime - state.startTime) / 1000).toFixed(1),
                        score: Math.round(timeBonus + coinBonus)
                    });
                }
            }
            
            results.sort((a, b) => b.score - a.score);
            
            const winnerDiv = document.getElementById('winnerSection');
            if (results.length) {
                const w = results[0];
                winnerDiv.innerHTML = `
                    <iconify-icon icon="mdi:trophy" class="text-6xl text-steam-naranja mb-4"></iconify-icon>
                    <div class="player-avatar mx-auto mb-4" style="background:${w.color};width:100px;height:100px;border-radius:20px;box-shadow:0 0 30px ${w.color}50"></div>
                    <div class="text-2xl font-black" style="color:${w.color}">${w.name}</div>
                    <div class="text-xl text-steam-verde font-bold mt-2 flex items-center justify-center gap-2">
                        <iconify-icon icon="mdi:star"></iconify-icon>
                        ${w.score} pts
                    </div>
                `;
                sound('win');
                confetti();
            }
            
            const tbody = document.getElementById('resultsBody');
            tbody.innerHTML = '';
            const medals = ['mdi:medal-outline', 'mdi:medal-outline', 'mdi:medal-outline'];
            const medalColors = ['#FFD700', '#C0C0C0', '#CD7F32'];
            
            results.forEach((r, i) => {
                const row = document.createElement('tr');
                row.className = i === 0 ? 'bg-amber-50' : i % 2 ? 'bg-gray-50' : '';
                row.innerHTML = `
                    <td class="py-3 px-2 text-xl">
                        ${i < 3 
                            ? `<iconify-icon icon="${medals[i]}" style="color:${medalColors[i]}" class="text-2xl"></iconify-icon>` 
                            : `#${i+1}`}
                    </td>
                    <td class="py-3 px-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-md relative" style="background:${r.color}">
                                <span class="absolute top-1 left-1 w-1.5 h-1.5 bg-white rounded-full"></span>
                                <span class="absolute top-1 right-1 w-1.5 h-1.5 bg-white rounded-full"></span>
                            </div>
                            <span class="font-bold">${r.name}</span>
                        </div>
                    </td>
                    <td class="py-3 px-2 text-center text-steam-naranja font-bold">${r.coins}</td>
                    <td class="py-3 px-2 text-center">${r.time}s</td>
                    <td class="py-3 px-2 text-right font-black text-steam-verde">${r.score}</td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('resultsScreen').style.display = 'flex';
            airconsole.broadcast({ type: 'gameResults', results, winner: results[0] });
        }

        class Game {
            constructor(num, color, name) {
                this.num = num;
                this.color = color;
                this.name = name;
                this.canvas = null;
                this.ctx = null;
                this.keys = { left: false, right: false, jump: false };
                this.finishTime = null;
                
                this.player = { x: 80, y: 300, vx: 0, vy: 0, w: 44, h: 44, facing: 1, stunned: 0 };
                this.coins = 0;
                this.won = false;
                this.grounded = false;
                this.camX = 0;
                this.particles = [];
                this.trail = [];
                
                // Clone level data
                this.floors = LEVEL.floorSegments.map(f => ({...f}));
                this.platforms = LEVEL.platforms.map(p => ({...p, h: 16}));
                this.coinList = LEVEL.coins.map(c => ({...c, got: false, bob: Math.random() * 6.28}));
                this.obstacles = LEVEL.obstacles.map(o => ({...o, w: 38, h: 38, dir: 1, spd: 2 + Math.random(), range: 100 + Math.random() * 50}));
                this.finishX = LEVEL.length - 200;
            }

            init() {
                this.canvas = document.getElementById(`canvas${this.num}`);
                this.ctx = this.canvas.getContext('2d', { alpha: false });
                
                const container = document.getElementById(`screen${this.num}`);
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                
                const ratio = this.canvas.height / 700;
                this.floorY = this.canvas.height - 70;
                
                this.floors.forEach(f => f.y = this.floorY);
                this.platforms.forEach(p => p.y *= ratio);
                this.coinList.forEach(c => c.y *= ratio);
                this.obstacles.forEach(o => o.y *= ratio);
                this.player.y = 300 * ratio;
                
                this.coinsEl = document.getElementById(`coins${this.num}`);
                this.progressEl = document.getElementById(`progress${this.num}`);
                
                this.loop();
            }

            update() {
                if (this.won || !state.started) return;
                
                const p = this.player;
                const prevVy = p.vy;
                
                // Input
                p.vx = 0;
                if (!p.stunned) {
                    if (this.keys.left) { p.vx = -5.5; p.facing = -1; }
                    if (this.keys.right) { p.vx = 5.5; p.facing = 1; }
                }
                
                if (p.stunned > 0) p.stunned--;
                
                // Physics
                p.vy += 0.5;
                if (p.vy > 15) p.vy = 15;
                
                if (this.keys.jump && this.grounded && !p.stunned) {
                    p.vy = -13;
                    sound('jump');
                    this.keys.jump = false;
                    this.burst(p.x + p.w/2, p.y + p.h, '#8BC34A', 5);
                }
                
                p.x += p.vx;
                p.y += p.vy;
                
                // Trail
                if (Math.abs(p.vx) > 0 || Math.abs(p.vy) > 3) {
                    this.trail.push({ x: p.x, y: p.y, a: 0.4 });
                    if (this.trail.length > 6) this.trail.shift();
                }
                this.trail = this.trail.filter(t => (t.a *= 0.85) > 0.05);
                
                // Collisions
                this.grounded = false;
                
                // Floors
                this.floors.forEach(f => {
                    if (p.x + p.w > f.x && p.x < f.x + f.width && p.y + p.h > f.y && p.y + p.h < f.y + 25 && p.vy > 0) {
                        p.y = f.y - p.h;
                        p.vy = 0;
                        this.grounded = true;
                    }
                });
                
                // Platforms
                this.platforms.forEach(pl => {
                    if (p.x + p.w > pl.x && p.x < pl.x + pl.width && p.y + p.h > pl.y && p.y + p.h < pl.y + 20 && p.vy > 0) {
                        p.y = pl.y - p.h;
                        p.vy = 0;
                        this.grounded = true;
                    }
                });
                
                // Fall death
                if (p.y > this.canvas.height + 50) {
                    this.burst(p.x + p.w/2, this.canvas.height - 50, '#AB3D8B', 12);
                    p.x = 80;
                    p.y = 300 * (this.canvas.height / 700);
                    p.vx = p.vy = 0;
                    sound('hit');
                }
                
                // Obstacles
                this.obstacles.forEach(o => {
                    o.x += o.dir * o.spd;
                    if (Math.abs(o.x - o.startX) > o.range) o.dir *= -1;
                    
                    if (!p.stunned && p.x + p.w > o.x && p.x < o.x + o.w && p.y + p.h > o.y && p.y < o.y + o.h) {
                        p.stunned = 45;
                        sound('hit');
                        this.burst(p.x + p.w/2, p.y + p.h/2, '#AB3D8B', 10);
                    }
                });
                
                // Bounds
                p.x = Math.max(0, p.x);
                
                // Camera
                this.camX = Math.max(0, Math.min(p.x - this.canvas.width / 2, this.finishX - this.canvas.width + 150));
                
                // Progress
                if (this.progressEl) this.progressEl.style.width = Math.min(100, p.x / this.finishX * 100) + '%';
                
                // Coins
                this.coinList.forEach(c => {
                    if (!c.got && Math.abs(p.x + p.w/2 - c.x) < 35 && Math.abs(p.y + p.h/2 - c.y) < 35) {
                        c.got = true;
                        this.coins++;
                        if (this.coinsEl) this.coinsEl.textContent = this.coins;
                        this.burst(c.x, c.y, '#EB8225', 10);
                        sound('coin');
                    }
                });
                
                // Finish
                if (p.x > this.finishX) {
                    this.won = true;
                    this.finishTime = Date.now();
                    this.burst(p.x + p.w/2, p.y, '#73A03F', 20);
                    
                    const allDone = Object.values(state.games).every(g => g.won || state.players[g.num].disconnected);
                    if (allDone) setTimeout(showResults, 1200);
                }
                
                // Particles
                this.particles = this.particles.filter(pt => {
                    pt.x += pt.vx;
                    pt.y += pt.vy;
                    pt.vy += 0.15;
                    pt.life--;
                    return pt.life > 0;
                });
            }

            draw() {
                const ctx = this.ctx;
                const w = this.canvas.width;
                const h = this.canvas.height;
                
                // Sky - clean solid colors
                ctx.fillStyle = '#87CEEB';
                ctx.fillRect(0, 0, w, h * 0.4);
                ctx.fillStyle = '#98D8C8';
                ctx.fillRect(0, h * 0.4, w, h * 0.3);
                ctx.fillStyle = '#2D5A4A';
                ctx.fillRect(0, h * 0.7, w, h * 0.3);
                
                ctx.save();
                ctx.translate(-this.camX, 0);
                
                // Simple clouds
                ctx.fillStyle = 'rgba(255,255,255,0.9)';
                [[100, 60], [400, 90], [800, 50], [1200, 80], [1700, 65], [2200, 75], [2700, 55]].forEach(([x, y]) => {
                    ctx.beginPath();
                    ctx.arc(x, y, 30, 0, Math.PI * 2);
                    ctx.arc(x + 25, y - 5, 22, 0, Math.PI * 2);
                    ctx.arc(x + 50, y, 28, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // Ground
                this.floors.forEach(f => {
                    // Dirt
                    ctx.fillStyle = '#5D4037';
                    ctx.fillRect(f.x, f.y, f.width, 70);
                    // Grass
                    ctx.fillStyle = '#8BC34A';
                    ctx.fillRect(f.x, f.y, f.width, 12);
                    // Grass detail
                    ctx.fillStyle = '#9CCC65';
                    for (let gx = f.x + 10; gx < f.x + f.width - 10; gx += 25) {
                        ctx.fillRect(gx, f.y - 4, 3, 8);
                    }
                });
                
                // Platforms - clean flat design
                this.platforms.forEach(pl => {
                    ctx.fillStyle = '#546E7A';
                    ctx.fillRect(pl.x, pl.y, pl.width, pl.h);
                    ctx.fillStyle = '#78909C';
                    ctx.fillRect(pl.x, pl.y, pl.width, 4);
                });
                
                // Obstacles - enemy blocks
                this.obstacles.forEach(o => {
                    ctx.fillStyle = '#AB3D8B';
                    ctx.beginPath();
                    ctx.roundRect(o.x, o.y, o.w, o.h, 8);
                    ctx.fill();
                    // Eyes
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(o.x + o.w * 0.3, o.y + o.h * 0.4, 6, 0, Math.PI * 2);
                    ctx.arc(o.x + o.w * 0.7, o.y + o.h * 0.4, 6, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#333';
                    ctx.beginPath();
                    ctx.arc(o.x + o.w * 0.3 + o.dir * 2, o.y + o.h * 0.4, 3, 0, Math.PI * 2);
                    ctx.arc(o.x + o.w * 0.7 + o.dir * 2, o.y + o.h * 0.4, 3, 0, Math.PI * 2);
                    ctx.fill();
                });
                
                // Coins
                const t = performance.now();
                this.coinList.forEach(c => {
                    if (!c.got) {
                        const bobY = Math.sin(t / 200 + c.bob) * 4;
                        ctx.fillStyle = '#EB8225';
                        ctx.beginPath();
                        ctx.arc(c.x, c.y + bobY, 14, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = '#FFD700';
                        ctx.beginPath();
                        ctx.arc(c.x - 4, c.y + bobY - 4, 5, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText('$', c.x, c.y + bobY + 1);
                    }
                });
                
                // Finish flag
                const fx = this.finishX;
                ctx.fillStyle = '#455A64';
                ctx.fillRect(fx, this.floorY - 130, 6, 130);
                ctx.fillStyle = '#73A03F';
                ctx.beginPath();
                ctx.moveTo(fx + 6, this.floorY - 130);
                ctx.lineTo(fx + 60, this.floorY - 105);
                ctx.lineTo(fx + 6, this.floorY - 80);
                ctx.fill();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('META', fx + 33, this.floorY - 102);
                
                // Checkered finish
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 2; j++) {
                        ctx.fillStyle = (i + j) % 2 ? '#333' : '#fff';
                        ctx.fillRect(fx - 40 + i * 12, this.floorY - 20 + j * 10, 12, 10);
                    }
                }
                
                // Particles
                this.particles.forEach(pt => {
                    ctx.globalAlpha = pt.life / 30;
                    ctx.fillStyle = pt.color;
                    ctx.beginPath();
                    ctx.arc(pt.x, pt.y, 4, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
                
                // Trail
                this.trail.forEach(tr => {
                    ctx.globalAlpha = tr.a * 0.5;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.roundRect(tr.x + 5, tr.y + 5, this.player.w - 10, this.player.h - 10, 8);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
                
                // Player
                const p = this.player;
                if (p.stunned) ctx.globalAlpha = 0.4 + Math.sin(t / 40) * 0.3;
                
                // Shadow
                ctx.fillStyle = 'rgba(0,0,0,0.2)';
                ctx.beginPath();
                ctx.ellipse(p.x + p.w/2, p.y + p.h + 4, p.w/2 * 0.7, 6, 0, 0, Math.PI * 2);
                ctx.fill();
                
                // Body
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.roundRect(p.x, p.y, p.w, p.h, 12);
                ctx.fill();
                
                // Highlight
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.roundRect(p.x + 5, p.y + 4, p.w - 10, 12, 6);
                ctx.fill();
                
                // Eyes
                const eyeY = p.y + p.h * 0.38;
                const eyeX1 = p.x + p.w * 0.3;
                const eyeX2 = p.x + p.w * 0.7;
                const lookX = p.facing * 3;
                
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(eyeX1, eyeY, 7, 0, Math.PI * 2);
                ctx.arc(eyeX2, eyeY, 7, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#222';
                ctx.beginPath();
                ctx.arc(eyeX1 + lookX, eyeY, 3, 0, Math.PI * 2);
                ctx.arc(eyeX2 + lookX, eyeY, 3, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.globalAlpha = 1;
                ctx.restore();
            }

            burst(x, y, color, count) {
                for (let i = 0; i < count; i++) {
                    this.particles.push({
                        x, y,
                        vx: (Math.random() - 0.5) * 8,
                        vy: (Math.random() - 0.5) * 8 - 3,
                        life: 25 + Math.random() * 10,
                        color
                    });
                }
            }

            loop() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }
        }

        window.addEventListener('resize', () => {
            if (state.started) {
                for (let n in state.games) {
                    const g = state.games[n];
                    const container = document.getElementById(`screen${n}`);
                    if (container && g.canvas) {
                        g.canvas.width = container.clientWidth;
                        g.canvas.height = container.clientHeight;
                    }
                }
            }
        });
    </script>
</body>
</html>
